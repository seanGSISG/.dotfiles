#!/bin/bash
# chezmoi modify_ script for ~/.claude/settings.json
#
# Reads the existing deployed settings.json from stdin, merges in our
# managed keys (permissions, preferences, hooks), and outputs the result.
# This preserves runtime additions like enabledPlugins and statusLine
# (added by plugins) while ensuring hooks are always present.

set -euo pipefail

# Read existing settings from stdin (chezmoi passes current file contents)
existing="$(cat)"

# If empty or invalid, start with empty object
if ! echo "$existing" | jq empty 2>/dev/null; then
  existing='{}'
fi

# Our managed configuration - merged on top of existing
managed='
{
  "permissions": {
    "allow": [],
    "deny": []
  },
  "preferences": {
    "verbose": false
  },
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/skills/continuous-learning-v2/hooks/observe.sh pre"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/skills/continuous-learning-v2/hooks/observe.sh post"
          }
        ]
      }
    ],
    "PreCompact": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node ~/.claude/scripts/hooks/pre-compact.js"
          }
        ]
      }
    ],
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node ~/.claude/scripts/hooks/session-start.js"
          }
        ]
      }
    ],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node ~/.claude/scripts/hooks/session-end.js"
          }
        ]
      },
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "node ~/.claude/scripts/hooks/evaluate-session.js"
          }
        ]
      }
    ]
  }
}
'

# Deep merge: existing * managed (managed keys win, existing extras preserved)
echo "$existing" | jq --argjson managed "$managed" '. * $managed'
