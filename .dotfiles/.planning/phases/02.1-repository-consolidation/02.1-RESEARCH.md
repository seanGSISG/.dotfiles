# Phase 2.1: Repository Consolidation - Research

**Researched:** 2026-02-10
**Domain:** Git repository merging, chezmoi source directory configuration
**Confidence:** HIGH

## Summary

Repository consolidation requires merging two git repositories with unrelated histories while preserving all commit history, then configuring chezmoi to use the new unified location as its source directory. The standard approach combines git's subtree merge strategy (or git-filter-repo for more complex scenarios) with chezmoi's `sourceDir` configuration option.

The key technical challenge is merging the home repo's `.planning/` commits into the chezmoi repo without creating conflicts, since both repos have `.planning/` directories at different logical paths (home has `.dotfiles/.planning/`, chezmoi has `.planning/`). After merging, the final state will have `.planning/` at the repo root with unified history from both sources.

**Primary recommendation:** Use git remote + subtree merge strategy with `--allow-unrelated-histories` to combine repos, configure chezmoi via `sourceDir` setting, then force-push unified history to GitHub.

## Standard Stack

### Core Tools

| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| git | 2.9+ | Repository merging with `--allow-unrelated-histories` flag | Required for merging unrelated histories; flag introduced in Git 2.9 |
| chezmoi | 2.x | Dotfile manager with configurable source directory | Supports `sourceDir` configuration option to point to custom location |
| git-filter-repo | Latest (optional) | Advanced history rewriting for complex path manipulations | Official git recommendation to replace deprecated `git filter-branch`; faster and safer |

### Supporting Tools

| Tool | Version | Purpose | When to Use |
|------|---------|---------|-------------|
| age | Any | Encryption key management | Need to move encryption keys to XDG-compliant location |
| pre-commit | Any | Safety guardrails during migration | Ensure secrets don't leak during history rewriting |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Subtree merge | `git filter-repo --to-subdirectory-filter` | Filter-repo is cleaner but requires installation; subtree merge uses built-in git features |
| Force push | Create new repo and archive old one | Loses GitHub stars/forks/issues; force push preserves remote identity |
| Merge commit | Rebase/squash history | Merge commit clearly marks unification point; rebase obscures the migration event |

**Installation:**
```bash
# git-filter-repo (if choosing advanced approach)
sudo apt-get install git-filter-repo  # Debian/Ubuntu
brew install git-filter-repo           # macOS
python -m pip install git-filter-repo  # Universal
```

## Architecture Patterns

### Recommended Final Structure
```
~/.dotfiles/                    # Single unified repo (IS the chezmoi source)
├── .git/                       # Single git repo (merged history)
├── .chezmoi.toml.tmpl          # Points to new age key location
├── .chezmoiignore              # Updated for new paths
├── .gitignore
├── .planning/                  # At repo root (unified from both sources)
│   ├── PROJECT.md
│   ├── ROADMAP.md
│   ├── STATE.md
│   └── phases/
├── .pre-commit-config.yaml
├── .secrets.baseline
├── .secrets.env.example
├── encrypted_dot_secrets.env.age
├── packages/                   # New subdirectory for manifests
│   ├── apt-packages.txt
│   ├── uv-tools.txt
│   └── binary-installs.txt
└── README.md
```

### Pattern 1: Git Remote + Subtree Merge

**What:** Add home repo as remote, fetch its history, merge with `--allow-unrelated-histories`

**When to use:** When both repos have simple structures without deep path conflicts

**Example:**
```bash
# In chezmoi repo (~/.local/share/chezmoi)
git remote add home-repo ~/
git fetch home-repo master

# Merge histories (creates merge commit)
git merge home-repo/master --allow-unrelated-histories -m "Merge .planning/ history from home repo"

# Resolve any conflicts in .planning/ paths
# Final state: .planning/ at repo root with unified history
```

**Source:** Official Git documentation, multiple 2025-2026 tutorials confirm this pattern

### Pattern 2: Git Filter-Repo + Remote Merge

**What:** Use `git-filter-repo` to restructure one repo's paths before merging

**When to use:** When significant path restructuring is needed before merge

**Example:**
```bash
# Clone home repo to temporary location
git clone ~/ /tmp/home-repo-temp
cd /tmp/home-repo-temp

# Move .dotfiles/.planning/ to .planning/ (if needed)
git filter-repo --path-rename .dotfiles/.planning/:.planning/

# Back in chezmoi repo
git remote add home-repo /tmp/home-repo-temp
git fetch home-repo master
git merge home-repo/master --allow-unrelated-histories
```

**Source:** git-filter-repo documentation, GitHub official guides

### Pattern 3: Chezmoi Source Directory Configuration

**What:** Configure chezmoi to use `~/.dotfiles` instead of `~/.local/share/chezmoi`

**When to use:** After physical repository move is complete

**Example:**
```bash
# Option 1: Via config file
cat > ~/.config/chezmoi/chezmoi.toml <<EOF
sourceDir = "/home/vscode/.dotfiles"
EOF

# Option 2: Via .chezmoi.toml.tmpl in source directory
# Add to ~/.dotfiles/.chezmoi.toml.tmpl:
# sourceDir = "{{ .chezmoi.homeDir }}/.dotfiles"

# Verify
chezmoi source-path  # Should return: /home/vscode/.dotfiles
```

**Source:** Context7 chezmoi documentation (HIGH confidence)

### Pattern 4: Age Key XDG Migration

**What:** Move age encryption key to XDG-compliant location and update config

**When to use:** During consolidation to adopt standard conventions

**Example:**
```bash
# Create XDG directory
mkdir -p ~/.config/age

# Move key (with secure permissions)
mv ~/key.txt ~/.config/age/keys.txt
chmod 600 ~/.config/age/keys.txt

# Update .chezmoi.toml.tmpl
sed -i 's|identity = "~/key.txt"|identity = "~/.config/age/keys.txt"|' \
  ~/.dotfiles/.chezmoi.toml.tmpl
```

**Source:** XDG Base Directory Specification, age documentation

### Anti-Patterns to Avoid

- **Copying files without history:** Don't `cp -r` the `.planning/` directory; use git merge to preserve commit history
- **Deleting `.git` before verification:** Always verify merged history with `git log` before removing source repos
- **Force push without `--force-with-lease`:** Use `--force-with-lease` to prevent overwriting unexpected remote changes
- **Ignoring .chezmoiignore updates:** Package lists and `.planning/` are now at different paths; update ignore patterns
- **Moving source without updating sourceDir:** Chezmoi will create new repo at old location if config isn't updated

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Merging two git repos | Custom script copying commits | `git remote add` + `git merge --allow-unrelated-histories` | Git's built-in merge preserves all metadata (author, timestamp, signatures); custom scripts lose this |
| Rewriting git paths | Scripted `git filter-branch` | `git-filter-repo` | filter-repo 10-100x faster, has safety checks, officially recommended by git project |
| Changing chezmoi source | Symlinks or manual file moves | `sourceDir` config option | Chezmoi expects to control source directory; symlinks break `chezmoi cd` and other commands |
| Handling merge conflicts | Manual file editing | Git's merge tools + `git mergetool` | Git tracks conflict resolution state; manual edits can leave repo in broken state |

**Key insight:** Git repository merging is well-trodden territory with built-in solutions. The `--allow-unrelated-histories` flag exists specifically for this use case and handles all edge cases (tags, branches, commit metadata preservation).

## Common Pitfalls

### Pitfall 1: Path Confusion During Merge

**What goes wrong:** Home repo tracks `.dotfiles/.planning/` while chezmoi repo tracks `.planning/`, creating conflicts during merge

**Why it happens:** Both repos have different logical roots; git sees overlapping paths

**How to avoid:**
- Examine both repos' file structures before merging
- Home repo's `.dotfiles/.planning/` files are actually at `~/.dotfiles/.planning/` (two levels deep)
- Chezmoi repo's `.planning/` files are at `~/.local/share/chezmoi/.planning/` (repo root)
- After merge, final path will be `~/.dotfiles/.planning/` (repo root)
- Git should auto-detect these as different paths; if conflicts arise, choose the version that matches final layout

**Warning signs:** Merge conflicts in files that shouldn't overlap; git reporting hundreds of conflicts

### Pitfall 2: Force Push Destroying Team Work

**What goes wrong:** `git push --force` overwrites commits pushed by others between your fetch and push

**Why it happens:** Force push ignores remote state and unconditionally overwrites

**How to avoid:**
- Use `git push --force-with-lease` instead of `--force`
- `--force-with-lease` only succeeds if remote hasn't changed since you last fetched
- For solo repos, this still provides safety against multiple terminal sessions
- Verify remote state with `git fetch && git status` before force pushing

**Warning signs:** Git warning about "rejected - non-fast-forward"; remote has commits you don't have locally

### Pitfall 3: Chezmoi Creates New Repo at Old Location

**What goes wrong:** After moving source to `~/.dotfiles`, chezmoi re-initializes `~/.local/share/chezmoi` on next run

**Why it happens:** Chezmoi checks `sourceDir` config; if not set, defaults to `~/.local/share/chezmoi`

**How to avoid:**
- Set `sourceDir` in config **before** deleting old location
- Verify with `chezmoi source-path` before any destructive operations
- Config location: `~/.config/chezmoi/chezmoi.toml` (global) or `sourceDir/.chezmoi.toml.tmpl` (templated)

**Warning signs:** `chezmoi status` shows "not in a git repository" or re-creates empty source directory

### Pitfall 4: Encrypted Files Become Unreadable

**What goes wrong:** After moving age key, chezmoi can't decrypt `encrypted_*.age` files

**Why it happens:** `.chezmoi.toml.tmpl` still points to old key location (`~/key.txt`)

**How to avoid:**
- Update age identity path in `.chezmoi.toml.tmpl` **before** moving key
- Test decryption with `chezmoi cat ~/.secrets.env` before committing changes
- Keep backup of key until verification is complete

**Warning signs:** Chezmoi errors mentioning "age" or "decryption failed"; encrypted files show as binary in diffs

### Pitfall 5: Lost Commits Due to Detached .git

**What goes wrong:** Delete `~/.git` (home repo) before verifying merge, losing commits that didn't merge cleanly

**Why it happens:** Assumption that "all commits are merged" without verification

**How to avoid:**
- After merge, run `git log --all --oneline` in new unified repo
- Compare commit count: home repo had 20 commits, verify all 20 appear in merged history
- Keep `~/.git` until Phase 2.1 is fully verified complete
- Final cleanup can happen in Phase 6 or project completion

**Warning signs:** Expected commits missing from `git log`; GitHub shows fewer commits than expected

### Pitfall 6: .chezmoiignore Out of Sync

**What goes wrong:** Package lists (apt-packages.txt, etc.) now at `packages/` subdirectory but `.chezmoiignore` still references root paths

**Why it happens:** File moves without updating ignore patterns

**How to avoid:**
- Update `.chezmoiignore` patterns when moving files:
  - Old: `apt-packages.txt`
  - New: `packages/apt-packages.txt`
- Test with `chezmoi status` to see what would be applied
- These files should remain ignored (repo-only, never applied to home directory)

**Warning signs:** `chezmoi apply` tries to create `~/apt-packages.txt` or `~/packages/` in home directory

## Code Examples

Verified patterns from official sources:

### Complete Repository Merge Workflow

```bash
# Source: Git official docs + 2025-2026 best practices

# 1. Prepare: Work in chezmoi repo (becomes unified repo)
cd ~/.local/share/chezmoi

# 2. Add home repo as remote (local path)
git remote add home-repo ~/
git fetch home-repo master

# 3. Create merge commit with unrelated histories
git merge home-repo/master --allow-unrelated-histories \
  -m "Merge .planning/ history from home repository

This merge combines:
- Chezmoi repo (7 commits): dotfile sources, encryption, safety guardrails
- Home repo (20 commits): project planning documentation

Both repos tracked .planning/ at different logical paths:
- Chezmoi: .planning/ at repo root
- Home: .dotfiles/.planning/ (tracked as .planning/ internally)

Final unified state: .planning/ at repo root with full history.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>"

# 4. Resolve conflicts if any (likely none due to different paths)
# If conflicts exist in .planning/: keep version matching final layout

# 5. Verify merged history
git log --all --oneline --graph | head -40
# Should show both repo histories converging at merge commit

# 6. Clean up remote reference (optional, before push)
git remote remove home-repo
```

### Move Repository and Configure Chezmoi

```bash
# Source: Verified with Context7 chezmoi documentation

# 1. Move repository from chezmoi default to ~/.dotfiles
# Chezmoi source is currently at: ~/.local/share/chezmoi
# Target location: ~/.dotfiles (already exists with .planning/ only)

# Move .git and all chezmoi files to ~/.dotfiles
mv ~/.local/share/chezmoi/.git ~/.dotfiles/
mv ~/.local/share/chezmoi/* ~/.dotfiles/
mv ~/.local/share/chezmoi/.[!.]* ~/.dotfiles/ 2>/dev/null || true

# 2. Create chezmoi config file pointing to new location
mkdir -p ~/.config/chezmoi
cat > ~/.config/chezmoi/chezmoi.toml <<'EOF'
sourceDir = "/home/vscode/.dotfiles"
EOF

# 3. Verify configuration
chezmoi source-path
# Expected output: /home/vscode/.dotfiles

# 4. Test chezmoi operations
chezmoi diff    # Should work without errors
chezmoi status  # Should show no changes (if not edited)

# 5. Clean up old location
rm -rf ~/.local/share/chezmoi
# Note: Only do this AFTER verification
```

### Reorganize Files to Final Layout

```bash
# Source: Standard git operations

cd ~/.dotfiles

# 1. Create packages subdirectory
mkdir -p packages

# 2. Move package manifests
git mv apt-packages.txt packages/
git mv uv-tools.txt packages/
git mv binary-installs.txt packages/

# 3. Update .chezmoiignore for new paths
cat >> .chezmoiignore <<'EOF'
# Package manifests (repo-only, not applied to home directory)
packages/
EOF

# 4. Commit reorganization
git add .chezmoiignore
git commit -m "refactor: reorganize package lists into packages/ subdirectory

Moves apt-packages.txt, uv-tools.txt, and binary-installs.txt into
packages/ subdirectory for better organization.

Updates .chezmoiignore to reflect new paths.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>"
```

### Migrate Age Encryption Key

```bash
# Source: XDG Base Directory Specification + age best practices

# 1. Create XDG-compliant directory
mkdir -p ~/.config/age
chmod 700 ~/.config/age

# 2. Move key with secure permissions
mv ~/key.txt ~/.config/age/keys.txt
chmod 600 ~/.config/age/keys.txt

# 3. Update chezmoi config template
cd ~/.dotfiles
# Edit .chezmoi.toml.tmpl: change identity path
sed -i 's|identity = "~/key.txt"|identity = "~/.config/age/keys.txt"|' \
  .chezmoi.toml.tmpl

# 4. Test decryption still works
chezmoi cat ~/.secrets.env
# Should output decrypted content without errors

# 5. Commit configuration change
git add .chezmoi.toml.tmpl
git commit -m "chore: move age key to XDG-compliant location

Moves encryption key from ~/key.txt to ~/.config/age/keys.txt
following XDG Base Directory Specification.

Updates .chezmoi.toml.tmpl to reference new key location.

Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>"
```

### Force Push Unified History

```bash
# Source: Git force-push best practices 2026

cd ~/.dotfiles

# 1. Ensure we're on correct branch
git checkout main  # or master, depending on repo

# 2. Fetch latest remote state (safety check)
git fetch origin

# 3. Verify local history looks correct
git log --oneline --graph --all | head -40

# 4. Force push with lease (safer than --force)
# --force-with-lease fails if remote changed since last fetch
git push --force-with-lease origin main

# Alternative: Create backup tag on remote before force push
git push origin main:refs/tags/pre-consolidation-backup
git push --force-with-lease origin main

# 5. Verify push succeeded
git log origin/main --oneline | head -10
# Should match local history
```

### Cleanup Post-Migration

```bash
# Source: Safe cleanup procedure

# 1. Verify everything works from new location
chezmoi source-path  # Should return: /home/vscode/.dotfiles
chezmoi diff         # Should work without errors
chezmoi apply --dry-run --verbose  # Should show no unexpected changes

# 2. Delete home repo .git (only after verification)
rm -rf ~/.git

# 3. Delete orphaned .planning/ in home directory
# (superseded by ~/.dotfiles/.planning/)
rm -rf ~/.planning

# 4. Verify home directory is NOT a git repo
git -C ~/ status 2>&1 | grep "not a git repository"
# Should output: "fatal: not a git repository"

# 5. Keep these until project completion (deferred cleanup):
# - ~/.dotfiles-backup/ (Phase 1-2 artifacts)
# - Other backup artifacts
# These can be removed in Phase 6 or final verification
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| `git filter-branch` | `git filter-repo` | Git 2.24 (2019) | 10-100x faster, official recommendation, safer defaults |
| `--force` push | `--force-with-lease` | Git 1.8.5 (2013) | Prevents accidental overwrites of remote changes |
| Home-only dotfiles | Chezmoi with custom `sourceDir` | Chezmoi 2.0+ | Single repo for dotfiles + project docs, better organization |
| `~/key.txt` for age | `~/.config/age/keys.txt` | XDG spec adoption | Follows standard conventions, cleaner home directory |

**Deprecated/outdated:**
- `git filter-branch`: Deprecated in favor of `git-filter-repo` (slower, more error-prone)
- Hardcoded `~/.local/share/chezmoi`: Chezmoi supports custom `sourceDir` since v2.0
- `git push --force` without lease: Use `--force-with-lease` to prevent accidental damage

## Open Questions

### 1. Should we use filter-repo or simple merge?

**What we know:**
- Home repo has simple structure: just `.planning/` files tracked (appears as `.dotfiles/.planning/` in `git ls-files`)
- Chezmoi repo has `.planning/` at root
- Paths may not actually conflict because git tracks them differently

**What's unclear:**
- Will git auto-detect these as non-conflicting paths, or will manual conflict resolution be needed?
- Is the path prefix mismatch significant enough to require filter-repo preprocessing?

**Recommendation:**
- Start with simple merge approach (Pattern 1: Remote + Subtree Merge)
- Only use git-filter-repo (Pattern 2) if conflicts arise that can't be resolved manually
- Test merge in fresh clone first to preview conflicts

### 2. Which branch name to use post-merge?

**What we know:**
- Chezmoi repo uses `main` branch
- Home repo uses `master` branch
- GitHub remote expects consistent branch name

**What's unclear:**
- Should we standardize on `main` (modern convention) or `master` (home repo's current)?
- Will force push require branch rename on remote?

**Recommendation:**
- Use `main` (chezmoi repo's branch) as primary
- Merge home's `master` into chezmoi's `main`
- Force push to `origin/main` (GitHub remote already tracks this)
- Home repo's `master` branch disappears when `~/.git` is deleted

### 3. Timing of sourceDir configuration?

**What we know:**
- Can configure `sourceDir` in `~/.config/chezmoi/chezmoi.toml` (global)
- Can configure in source repo's `.chezmoi.toml.tmpl` (templated)
- Must be set before deleting old source location

**What's unclear:**
- Should we configure before or after moving files?
- Which config location is more reliable for this migration?

**Recommendation:**
- Use global config file (`~/.config/chezmoi/chezmoi.toml`) for migration
- Set `sourceDir = "/home/vscode/.dotfiles"` before any file moves
- Keeps config external to repos during transition
- Can optionally add to `.chezmoi.toml.tmpl` later for portability

## Sources

### Primary (HIGH confidence)

- **Context7: /twpayne/chezmoi** - `sourceDir` configuration, chezmoi initialization
- **Context7: /websites/chezmoi_io** - `.chezmoiroot` usage, source directory customization
- **Git Official Documentation** - Subtree merge strategy, `--allow-unrelated-histories` flag
- **GitHub Docs: About Git subtree merges** - Official subtree merge pattern and examples
- **Git Kernel Documentation: using-merge-subtree.html** - Authoritative subtree merge guide

### Secondary (MEDIUM confidence)

- **Multiple 2025-2026 tutorials** (Meziantou, AlexV/Medium, Graham F. Scott) - Confirmed remote + merge pattern
- **git-filter-repo documentation** (newren/git-filter-repo) - `--subdirectory-filter` and `--path-rename` options
- **Git Tower: Git Filter-Repo guide** - Installation and best practices
- **2026 Git force-push best practices** (Graphite, Dev.to) - `--force-with-lease` safety pattern

### Tertiary (LOW confidence)

- **WebSearch: Chezmoi migration experiences** - User migration stories confirm approach but lack technical depth
- **Stack Overflow: Git merge unrelated histories** - Community solutions consistent with official docs

## Metadata

**Confidence breakdown:**
- Git merge strategy: HIGH - Official documentation, widely used pattern since Git 2.9
- Chezmoi configuration: HIGH - Verified with Context7 documentation (authoritative source)
- Force push safety: HIGH - Current best practice 2026, multiple authoritative sources
- git-filter-repo usage: MEDIUM - Well-documented but may not be needed for this specific case
- Path conflict resolution: MEDIUM - Depends on actual git behavior during merge (needs testing)

**Research date:** 2026-02-10
**Valid until:** ~60 days (git/chezmoi are stable technologies; patterns unlikely to change rapidly)
