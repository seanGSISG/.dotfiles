---
phase: 02.1-repository-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.dotfiles/ (entire directory — becomes chezmoi source)
  - ~/.config/chezmoi/chezmoi.toml
  - ~/.dotfiles/.chezmoi.toml.tmpl
  - ~/.config/age/keys.txt
autonomous: true

must_haves:
  truths:
    - "`~/.dotfiles` is a git repository with `.git/` directory"
    - "`chezmoi source-path` returns `/home/vscode/.dotfiles`"
    - "`git log` in `~/.dotfiles` shows commits from both the chezmoi repo and the home repo"
    - "Age-encrypted files can still be decrypted by chezmoi after key relocation"
  artifacts:
    - path: "~/.dotfiles/.git"
      provides: "Unified git repository"
    - path: "~/.dotfiles/.chezmoi.toml.tmpl"
      provides: "Chezmoi config template with updated age key path"
    - path: "~/.config/chezmoi/chezmoi.toml"
      provides: "Global chezmoi config pointing sourceDir to ~/.dotfiles"
    - path: "~/.config/age/keys.txt"
      provides: "Age encryption key at XDG-compliant location"
  key_links:
    - from: "~/.config/chezmoi/chezmoi.toml"
      to: "~/.dotfiles"
      via: "sourceDir setting"
      pattern: 'sourceDir.*dotfiles'
    - from: "~/.config/chezmoi/chezmoi.toml"
      to: "~/.config/age/keys.txt"
      via: "age.identity setting"
      pattern: 'identity.*config/age/keys'
---

<objective>
Merge the two split git repositories (chezmoi source at `~/.local/share/chezmoi` and home repo at `~/`) into a single unified repository at `~/.dotfiles`, then configure chezmoi to use this new location as its source directory and relocate the age encryption key to the XDG-standard path.

Purpose: This is the critical structural fix that unifies the project's split repo state into a single source of truth, enabling clean work in all subsequent phases.

Output: A single git repository at `~/.dotfiles` containing all chezmoi files AND `.planning/` history, with chezmoi configured to use it as source.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-repository-consolidation/02.1-CONTEXT.md
@.planning/phases/02.1-repository-consolidation/02.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move chezmoi source to ~/.dotfiles and merge home repo history</name>
  <files>
    ~/.dotfiles/ (all chezmoi files relocated here)
    ~/.dotfiles/.git/ (unified git history)
  </files>
  <action>
    This task physically moves the chezmoi source directory and merges git histories.

    **Step 1: Move chezmoi source directory to ~/.dotfiles**

    The target `~/.dotfiles/` already exists with a `.planning/` subdirectory (tracked by home repo).
    The chezmoi source at `~/.local/share/chezmoi/` has its own `.git/` and all chezmoi-managed files.

    Move the entire chezmoi source (including `.git/`) to `~/.dotfiles/`:
    ```bash
    # Remove the existing .dotfiles/.planning since it will come from the merge
    rm -rf ~/.dotfiles/.planning

    # Move chezmoi source contents to ~/.dotfiles
    # Use rsync to handle the move cleanly (preserves .git)
    rsync -a ~/.local/share/chezmoi/ ~/.dotfiles/
    ```

    Verify the move:
    ```bash
    cd ~/.dotfiles
    git status  # Should show the chezmoi repo with main branch
    git log --oneline -5  # Should show chezmoi commit history
    ls .chezmoi.toml.tmpl  # Chezmoi config template exists
    ```

    **Step 2: Merge home repo history into the unified repo**

    The home repo at `~/` tracks `.planning/` files under two path prefixes:
    - `.planning/*` (direct)
    - `.dotfiles/.planning/*` (nested)

    The final state needs `.planning/` at repo root (which already exists in chezmoi repo from Phase 1).

    ```bash
    cd ~/.dotfiles

    # Add the home repo as a remote
    git remote add home-repo /home/vscode

    # Fetch its history
    git fetch home-repo master

    # Merge with allow-unrelated-histories
    # This creates a merge commit that unifies both histories
    git merge home-repo/master --allow-unrelated-histories \
      -m "merge: unify chezmoi source and .planning history

    Consolidate split repo structure:
    - Primary: chezmoi source (from ~/.local/share/chezmoi)
    - Merged: .planning/ history (from ~/ home repo)
    - Result: single unified repo at ~/.dotfiles"
    ```

    **Step 3: Resolve merge conflicts**

    The home repo tracks files under `.dotfiles/.planning/` prefix, but our repo already has `.planning/` at root. Expected conflicts or duplicates:
    - `.planning/ROADMAP.md`, `.planning/STATE.md` etc. may conflict — keep the chezmoi repo version (ours) since it's more current
    - `.dotfiles/.planning/*` paths from home repo will appear as new files — these are duplicates of `.planning/*` and should be removed after merge

    If merge conflicts occur on `.planning/` files:
    ```bash
    # Accept our (chezmoi repo) versions for any .planning conflicts
    git checkout --ours .planning/
    git add .planning/

    # Remove the .dotfiles/.planning/ duplicate path if it appears
    git rm -r .dotfiles/.planning/ 2>/dev/null || true

    # Remove other home-repo artifacts that don't belong
    git rm -r .dotfiles/ 2>/dev/null || true

    git commit --no-edit  # Complete the merge
    ```

    If NO conflicts (clean merge), the `.dotfiles/.planning/` files from home repo will land in the working tree. Remove them:
    ```bash
    # Remove the nested .dotfiles/ path (duplicate of root-level files)
    git rm -r .dotfiles/ 2>/dev/null || true
    git commit -m "chore: remove duplicate .dotfiles/.planning/ from merged history" 2>/dev/null || true
    ```

    **Step 4: Clean up the remote**
    ```bash
    cd ~/.dotfiles
    git remote remove home-repo
    ```

    **Step 5: Verify unified history**
    ```bash
    cd ~/.dotfiles
    # Must see commits from BOTH repos
    git log --oneline --all | head -30
    # Check for chezmoi commits
    git log --oneline --grep="01-01" | head -3
    # Check for home repo commits (planning docs)
    git log --oneline --grep="roadmap" | head -3
    ```
  </action>
  <verify>
    ```bash
    cd ~/.dotfiles
    # Has .git directory
    test -d .git && echo "PASS: .git exists"
    # Is on main branch
    git branch --show-current | grep -q "main" && echo "PASS: on main branch"
    # Has chezmoi files
    test -f .chezmoi.toml.tmpl && echo "PASS: chezmoi template exists"
    test -f encrypted_dot_secrets.env.age && echo "PASS: encrypted secrets exist"
    # Has .planning directory
    test -d .planning && echo "PASS: .planning exists"
    # History from both repos
    CHEZMOI_COMMITS=$(git log --oneline --grep="chezmoi" | wc -l)
    PLANNING_COMMITS=$(git log --oneline --grep="roadmap\|requirements\|research" | wc -l)
    echo "Chezmoi-related commits: $CHEZMOI_COMMITS"
    echo "Planning-related commits: $PLANNING_COMMITS"
    [ "$CHEZMOI_COMMITS" -gt 0 ] && [ "$PLANNING_COMMITS" -gt 0 ] && echo "PASS: both histories present"
    ```
  </verify>
  <done>
    `~/.dotfiles/` is a git repository containing all chezmoi files AND `.planning/` directory, with commit history from both the chezmoi source repo and the home directory repo visible in `git log`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure chezmoi source directory and relocate age key</name>
  <files>
    ~/.config/chezmoi/chezmoi.toml
    ~/.dotfiles/.chezmoi.toml.tmpl
    ~/.config/age/keys.txt
  </files>
  <action>
    This task configures chezmoi to use `~/.dotfiles` as its source and moves the age key to XDG location.

    **Step 1: Create global chezmoi config pointing to new source**

    ```bash
    mkdir -p ~/.config/chezmoi
    cat > ~/.config/chezmoi/chezmoi.toml <<'EOF'
    sourceDir = "/home/vscode/.dotfiles"
    encryption = "age"
    [age]
    identity = "~/.config/age/keys.txt"
    recipient = "age1jlfdynhp3lzz88evlm5dtnd70ndusz25cfudllgdyh8eka9lh5rq07kg3r"
    EOF
    ```

    Note: The recipient value must match the existing key. Read it from the current config:
    ```bash
    RECIPIENT=$(grep recipient ~/.local/share/chezmoi/.chezmoi.toml.tmpl | cut -d'"' -f2)
    ```
    Use this `$RECIPIENT` value when writing the config.

    **Step 2: Relocate age encryption key to XDG path**

    ```bash
    mkdir -p ~/.config/age
    chmod 700 ~/.config/age
    cp ~/key.txt ~/.config/age/keys.txt
    chmod 600 ~/.config/age/keys.txt
    ```

    Keep `~/key.txt` as a backup for now (will be cleaned up after verification).

    **Step 3: Update .chezmoi.toml.tmpl in the repo**

    Update the template to reference the new key location:
    ```bash
    cd ~/.dotfiles
    ```

    Edit `.chezmoi.toml.tmpl` to change `identity = "~/key.txt"` to `identity = "~/.config/age/keys.txt"`:
    ```toml
    encryption = "age"
    [age]
    identity = "~/.config/age/keys.txt"
    recipient = "age1jlfdynhp3lzz88evlm5dtnd70ndusz25cfudllgdyh8eka9lh5rq07kg3r"

    [data]
    hostname = "{{ .chezmoi.hostname }}"
    username = "{{ .chezmoi.username }}"
    ```

    **Step 4: Verify chezmoi recognizes new source**

    ```bash
    chezmoi source-path
    # Must output: /home/vscode/.dotfiles

    # Verify encryption still works
    chezmoi cat ~/.secrets.env 2>/dev/null || echo "Note: cat may fail if target doesn't exist, that's OK"

    # Verify managed files are visible
    chezmoi managed | head -5
    ```

    **Step 5: Commit the config changes**

    ```bash
    cd ~/.dotfiles
    git add .chezmoi.toml.tmpl
    git commit -m "chore(02.1): update age key path to XDG location (~/.config/age/keys.txt)"
    ```
  </action>
  <verify>
    ```bash
    # Chezmoi source path is correct
    chezmoi source-path | grep -q "/home/vscode/.dotfiles" && echo "PASS: source-path correct"

    # Age key exists at new location
    test -f ~/.config/age/keys.txt && echo "PASS: age key at XDG path"
    test "$(stat -c %a ~/.config/age)" = "700" && echo "PASS: age dir permissions"
    test "$(stat -c %a ~/.config/age/keys.txt)" = "600" && echo "PASS: age key permissions"

    # Chezmoi config exists
    test -f ~/.config/chezmoi/chezmoi.toml && echo "PASS: global chezmoi config exists"
    grep -q "sourceDir" ~/.config/chezmoi/chezmoi.toml && echo "PASS: sourceDir configured"

    # Template updated
    grep -q "config/age/keys.txt" ~/.dotfiles/.chezmoi.toml.tmpl && echo "PASS: template updated"

    # Encryption works
    chezmoi cat ~/.secrets.env >/dev/null 2>&1 && echo "PASS: encryption works" || echo "INFO: cat test skipped (target may not exist)"
    ```
  </verify>
  <done>
    `chezmoi source-path` returns `/home/vscode/.dotfiles`, age key is at `~/.config/age/keys.txt` with correct permissions (700/600), `.chezmoi.toml.tmpl` references the new key path, and chezmoi can still decrypt encrypted files.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the following:

```bash
# 1. ~/.dotfiles is a git repo
cd ~/.dotfiles && git rev-parse --is-inside-work-tree

# 2. chezmoi source path
chezmoi source-path  # Must return /home/vscode/.dotfiles

# 3. All chezmoi files present
ls ~/.dotfiles/.chezmoi.toml.tmpl ~/.dotfiles/encrypted_dot_secrets.env.age ~/.dotfiles/apt-packages.txt

# 4. .planning present
ls ~/.dotfiles/.planning/PROJECT.md ~/.dotfiles/.planning/ROADMAP.md

# 5. Merged history
cd ~/.dotfiles && git log --oneline | wc -l  # Should be > 20 commits

# 6. Age key at XDG path
test -f ~/.config/age/keys.txt && echo "OK"
```
</verification>

<success_criteria>
1. `~/.dotfiles/.git/` exists (is a git repo)
2. `chezmoi source-path` returns `/home/vscode/.dotfiles`
3. All chezmoi-managed files are in `~/.dotfiles/` (template, encrypted secrets, package lists, gitignore, pre-commit config)
4. `.planning/` directory is inside `~/.dotfiles/` and tracked by git
5. `git log` shows commits from both the chezmoi repo (Phase 1-2 work) and the home repo (.planning docs)
6. Age encryption key is at `~/.config/age/keys.txt` with 600 permissions
7. Chezmoi can still decrypt encrypted files using the relocated key
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-repository-consolidation/02.1-01-SUMMARY.md`
</output>
