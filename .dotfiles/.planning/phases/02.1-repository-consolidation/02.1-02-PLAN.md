---
phase: 02.1-repository-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - ~/.dotfiles/packages/apt-packages.txt
  - ~/.dotfiles/packages/uv-tools.txt
  - ~/.dotfiles/packages/binary-installs.txt
  - ~/.dotfiles/.chezmoiignore
  - ~/.dotfiles/.gitignore
autonomous: false

must_haves:
  truths:
    - "Package lists are in `~/.dotfiles/packages/` subdirectory"
    - "No git repo exists at `~/` (home directory)"
    - "No chezmoi source exists at `~/.local/share/chezmoi`"
    - "`git log` in `~/.dotfiles` preserves all prior commit history"
    - "GitHub remote is updated with unified history"
  artifacts:
    - path: "~/.dotfiles/packages/apt-packages.txt"
      provides: "Apt package inventory"
    - path: "~/.dotfiles/packages/uv-tools.txt"
      provides: "UV tools inventory"
    - path: "~/.dotfiles/packages/binary-installs.txt"
      provides: "Binary install inventory"
    - path: "~/.dotfiles/.chezmoiignore"
      provides: "Updated ignore patterns for packages/ and .planning/"
    - path: "~/.dotfiles/.gitignore"
      provides: "Updated gitignore for new layout"
  key_links:
    - from: "~/.dotfiles/.chezmoiignore"
      to: "packages/"
      via: "ignore pattern"
      pattern: "packages/"
    - from: "~/.dotfiles/packages/"
      to: "bootstrap script (future Phase 5)"
      via: "package lists consumed by installer"
      pattern: "apt-packages.txt|uv-tools.txt|binary-installs.txt"
---

<objective>
Reorganize package lists into a `packages/` subdirectory, clean up old repo artifacts (home-directory `.git`, old chezmoi source), update ignore files for the new layout, and force-push the unified history to GitHub.

Purpose: Complete the repository consolidation by establishing the final directory layout, removing stale artifacts, and syncing the unified state to the remote.

Output: Clean `~/.dotfiles` repo with final layout pushed to GitHub, no stale repos remaining.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-repository-consolidation/02.1-CONTEXT.md
@.planning/phases/02.1-repository-consolidation/02.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move package lists to packages/ subdirectory and update ignore files</name>
  <files>
    ~/.dotfiles/packages/apt-packages.txt
    ~/.dotfiles/packages/uv-tools.txt
    ~/.dotfiles/packages/binary-installs.txt
    ~/.dotfiles/.chezmoiignore
    ~/.dotfiles/.gitignore
  </files>
  <action>
    **Step 1: Create packages/ subdirectory and move files**

    ```bash
    cd ~/.dotfiles
    mkdir -p packages

    # Use git mv to preserve history tracking
    git mv apt-packages.txt packages/apt-packages.txt
    git mv uv-tools.txt packages/uv-tools.txt
    git mv binary-installs.txt packages/binary-installs.txt
    ```

    **Step 2: Update .chezmoiignore**

    Replace the current `.chezmoiignore` content. The ignore file must exclude:
    - `README.md` — repo docs, not a dotfile
    - `LICENSE` — repo metadata
    - `.pre-commit-config.yaml` — repo tooling
    - `.secrets.baseline` — repo tooling
    - `.secrets.env.example` — repo reference
    - `.planning/` — project planning docs
    - `.github/` — GitHub CI/CD config
    - `packages/` — package manifests (consumed by bootstrap, not chezmoi apply)

    Write `.chezmoiignore`:
    ```
    README.md
    LICENSE
    .pre-commit-config.yaml
    .secrets.baseline
    .secrets.env.example
    .planning/
    .github/
    packages/
    ```

    **Step 3: Update .gitignore**

    Ensure `.gitignore` still covers secrets and editor artifacts. It should contain at minimum:
    ```
    # Secrets - never commit
    .secrets.env
    key.txt

    # Editor/OS artifacts
    .DS_Store
    *.swp
    *~
    ```

    Review the current `.gitignore` and update as needed. Do NOT add `packages/` or `.planning/` to gitignore — these are tracked by git, just excluded from chezmoi apply.

    **Step 4: Commit the reorganization**

    ```bash
    cd ~/.dotfiles
    git add packages/ .chezmoiignore .gitignore
    git commit -m "chore(02.1): move package lists to packages/ subdirectory

    Reorganize repo layout:
    - apt-packages.txt -> packages/apt-packages.txt
    - uv-tools.txt -> packages/uv-tools.txt
    - binary-installs.txt -> packages/binary-installs.txt
    - Update .chezmoiignore for packages/ path
    - Update .gitignore for new layout"
    ```
  </action>
  <verify>
    ```bash
    cd ~/.dotfiles
    # Package files in new location
    test -f packages/apt-packages.txt && echo "PASS: apt-packages.txt moved"
    test -f packages/uv-tools.txt && echo "PASS: uv-tools.txt moved"
    test -f packages/binary-installs.txt && echo "PASS: binary-installs.txt moved"

    # Old locations gone
    test ! -f apt-packages.txt && echo "PASS: old apt-packages.txt removed"
    test ! -f uv-tools.txt && echo "PASS: old uv-tools.txt removed"
    test ! -f binary-installs.txt && echo "PASS: old binary-installs.txt removed"

    # .chezmoiignore has packages/
    grep -q "packages/" .chezmoiignore && echo "PASS: packages/ in chezmoiignore"

    # Chezmoi doesn't try to manage package files
    chezmoi managed 2>/dev/null | grep -q "packages" && echo "FAIL: packages in managed" || echo "PASS: packages excluded from chezmoi"
    ```
  </verify>
  <done>
    Package lists are in `~/.dotfiles/packages/`, `.chezmoiignore` excludes `packages/` and `.planning/` from chezmoi apply, and old root-level package files are removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up old repos, verify success criteria, and push to GitHub</name>
  <files>
    ~/.git (deleted)
    ~/.local/share/chezmoi (deleted)
    ~/.planning (deleted)
  </files>
  <action>
    **Step 1: Delete the home directory git repo**

    The home repo at `~/` is no longer needed — its history has been merged into `~/.dotfiles`.

    ```bash
    rm -rf ~/.git
    ```

    Verify home is no longer a git repo:
    ```bash
    cd ~
    git rev-parse --is-inside-work-tree 2>&1 | grep -q "fatal" && echo "OK: home is not a git repo"
    ```

    **Step 2: Delete orphaned ~/.planning directory**

    The home repo tracked `~/.planning/` but the canonical copy is now at `~/.dotfiles/.planning/`. Delete the orphan:
    ```bash
    rm -rf ~/.planning
    ```

    **Step 3: Delete old chezmoi source directory**

    Since chezmoi now points to `~/.dotfiles`, the old source is obsolete:
    ```bash
    rm -rf ~/.local/share/chezmoi
    ```

    Verify chezmoi still works:
    ```bash
    chezmoi source-path  # Must return /home/vscode/.dotfiles
    chezmoi managed | head -3  # Must list managed files
    ```

    **Step 4: Remove stale ~/key.txt**

    The age key has been relocated to `~/.config/age/keys.txt` in Plan 01. Remove the old copy:
    ```bash
    rm -f ~/key.txt
    ```

    **Step 5: Run full success criteria verification**

    Run ALL Phase 2.1 success criteria checks:
    ```bash
    echo "=== Phase 2.1 Success Criteria ==="

    # SC1: ~/.dotfiles IS the chezmoi source directory
    SOURCE=$(chezmoi source-path)
    [ "$SOURCE" = "/home/vscode/.dotfiles" ] && echo "SC1 PASS: chezmoi source-path = $SOURCE" || echo "SC1 FAIL: $SOURCE"

    # SC2: All chezmoi files in ~/.dotfiles
    for f in .chezmoi.toml.tmpl .chezmoiignore .gitignore .pre-commit-config.yaml .secrets.baseline .secrets.env.example README.md encrypted_dot_secrets.env.age; do
      test -f ~/.dotfiles/$f && echo "SC2 PASS: $f exists" || echo "SC2 FAIL: $f missing"
    done

    # SC3: .planning inside ~/.dotfiles
    test -d ~/.dotfiles/.planning && echo "SC3 PASS: .planning/ in repo" || echo "SC3 FAIL: .planning/ missing"
    cd ~/.dotfiles && git ls-files .planning/ | head -3

    # SC4: ~/.dotfiles has its own .git
    test -d ~/.dotfiles/.git && echo "SC4 PASS: .git exists" || echo "SC4 FAIL: .git missing"

    # SC5: No git repo at ~/
    cd ~ && git rev-parse --is-inside-work-tree 2>&1 | grep -q "fatal" && echo "SC5 PASS: no home repo" || echo "SC5 FAIL: home is still a repo"

    # SC6: git log shows all prior history
    cd ~/.dotfiles
    TOTAL_COMMITS=$(git log --oneline | wc -l)
    echo "SC6 INFO: $TOTAL_COMMITS total commits in unified repo"
    [ "$TOTAL_COMMITS" -ge 20 ] && echo "SC6 PASS: history preserved" || echo "SC6 WARN: fewer commits than expected"
    ```

    **Step 6: Force push unified history to GitHub**

    ```bash
    cd ~/.dotfiles
    git push --force-with-lease origin main
    ```

    If push fails due to auth issues, note it for the checkpoint below.
  </action>
  <verify>
    ```bash
    # Home dir is NOT a git repo
    cd ~ && git rev-parse --is-inside-work-tree 2>&1 | grep -q "fatal" && echo "PASS: no home repo"

    # Old chezmoi source is gone
    test ! -d ~/.local/share/chezmoi && echo "PASS: old source deleted"

    # Orphaned ~/.planning is gone
    test ! -d ~/.planning && echo "PASS: orphaned .planning deleted"

    # Old key.txt is gone
    test ! -f ~/key.txt && echo "PASS: old key.txt removed"

    # chezmoi still functional
    chezmoi source-path | grep -q "dotfiles" && echo "PASS: chezmoi works"
    chezmoi managed | wc -l | xargs -I{} echo "PASS: {} managed files"
    ```
  </verify>
  <done>
    Home directory is no longer a git repo. `~/.local/share/chezmoi` and `~/.planning` are deleted. `~/key.txt` is removed. All Phase 2.1 success criteria pass. Unified history is pushed to GitHub.
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <what-built>
    Complete repository consolidation: unified `~/.dotfiles` repo with merged history, chezmoi configured for new source, age key at XDG location, package lists in `packages/` subdirectory, old repos cleaned up, and history pushed to GitHub.
  </what-built>
  <how-to-verify>
    1. Run `chezmoi source-path` — should return `/home/vscode/.dotfiles`
    2. Run `cd ~/.dotfiles && git log --oneline | head -10` — should show commits from both repos including the merge commit
    3. Run `ls ~/.dotfiles/packages/` — should show apt-packages.txt, uv-tools.txt, binary-installs.txt
    4. Run `ls ~/.dotfiles/.planning/PROJECT.md` — should exist
    5. Run `cd ~ && git status` — should say "fatal: not a git repository"
    6. Check GitHub repo at https://github.com/seanGSISG/.dotfiles — should show unified history
    7. Run `chezmoi doctor` — should show no critical errors
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
All six Phase 2.1 success criteria must be TRUE:

1. `chezmoi source-path` returns `/home/vscode/.dotfiles`
2. All chezmoi files (dotfile sources, package lists, encrypted secrets) are in `~/.dotfiles`
3. `.planning/` directory is inside `~/.dotfiles` and tracked by git
4. `~/.dotfiles` has its own `.git` directory
5. No git repo at `~/` (home directory is NOT a git repo)
6. `git log` in `~/.dotfiles` shows all prior commit history preserved

Additional checks:
- `chezmoi managed` lists expected files
- Age encryption still works with key at `~/.config/age/keys.txt`
- Package lists accessible at `~/.dotfiles/packages/`
- GitHub remote shows unified history
</verification>

<success_criteria>
1. Package lists live at `~/.dotfiles/packages/{apt-packages,uv-tools,binary-installs}.txt`
2. `.chezmoiignore` excludes `packages/` and `.planning/` from chezmoi apply
3. No `~/.git` directory exists
4. No `~/.local/share/chezmoi` directory exists
5. No orphaned `~/.planning` directory exists
6. No `~/key.txt` file exists
7. GitHub remote has the unified history (force push succeeded)
8. `chezmoi managed` works correctly with new layout
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-repository-consolidation/02.1-02-SUMMARY.md`
</output>
