---
phase: 02-package-management-tool-inventory
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.local/share/chezmoi/apt-packages.txt
autonomous: true

must_haves:
  truths:
    - "apt-packages.txt exists in the chezmoi repo with all required system packages"
    - "Packages are grouped by purpose with section headers (build-tools, shell-utils, dev-libs, etc.)"
    - "Every package has a comment explaining why it's needed"
    - "PPA/external-repo packages are annotated with their repo source"
    - "Only manually-installed packages are included (no transitive dependencies)"
    - "Version constraints are specified where modern features are used (e.g., git>=2.40)"
  artifacts:
    - path: "~/.local/share/chezmoi/apt-packages.txt"
      provides: "Curated system package list for bootstrap consumption"
      contains: "build-essential"
  key_links:
    - from: "apt-packages.txt"
      to: "bootstrap.sh (Phase 5)"
      via: "Plain text format, one package per line, # comments"
      pattern: "^[a-z].*#"
---

<objective>
Auto-discover all manually-installed apt packages from the current system, then curate and annotate them into a categorized apt-packages.txt file committed to the chezmoi repo.

Purpose: This is the system package "bill of materials" — it documents every apt package needed for environment reproduction. The bootstrap script (Phase 5) will consume this file to install packages on a fresh machine.
Output: A single apt-packages.txt file in the chezmoi repo, grouped by purpose, with inline comments explaining each package.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-package-management-tool-inventory/02-CONTEXT.md
@.planning/phases/02-package-management-tool-inventory/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-discover and curate apt package list</name>
  <files>~/.local/share/chezmoi/apt-packages.txt</files>
  <action>
    1. Run `apt-mark showmanual` to get the full list of manually-installed packages (currently ~101 packages).

    2. Curate the list by REMOVING packages that are NOT needed for the target dev environment:
       - Remove GUI/desktop packages that are not essential for WSL2 dev (e.g., google-chrome-stable, libgtk, libx11, libwayland, libcairo, libpango, libgdk-pixbuf, libatk, libatspi, libdrm, libgbm, libxcb, libxcomposite, libxcursor, libxdamage, libxext, libxfixes, libxi, libxkbcommon, libxrandr, libxrender, libxshmfence, libxss, libxtst, libasound, libnotify, libnotify-bin, libnspr4, libnss3, libcups, libfontconfig, libfreetype, libx11-xcb, dbus-x11, xdg-utils, timg)
       - Remove transitional/meta packages already satisfied by others (ubuntu-minimal, ubuntu-wsl pull in base-files, bash, coreutils, etc.)
       - Remove packages that are part of the base Ubuntu install and not explicitly needed (base-files, bash, bsdutils, coreutils, dash, debianutils, diffutils, grep, gzip, hostname, init, login, lsb-release, ncurses-base, ncurses-bin, procps, util-linux)
       - Keep crystal ONLY if the user actively uses Crystal lang (likely remove — not in project requirements)
       - Keep ne ONLY if the user actively uses it (likely remove — not standard)
       - Remove acli if it's a one-off experiment
       - Remove pipx (being replaced by uv tool)
       - Keep python3, python3-pip, python3.12, python3.12-venv (needed for uv and Python dev)
       - Keep libsecret-1-0, libsecret-1-dev, libsecret-tools (needed for credential storage with git/gh)
       - Keep libfuse2t64, fuse (needed for AppImage support)
       - Keep gnome-keyring, gnupg/gnupg2 (needed for credential management on WSL2)
       - Keep powershell (useful for WSL2/Windows interop)
       - Keep wslu (WSL utilities for Windows integration)

    3. Create `apt-packages.txt` in ~/.local/share/chezmoi/ with these sections (adjust groupings based on what survived curation):

       ```
       # apt-packages.txt — System packages for WSL2 dev environment
       # Format: one package per line, # comments explain purpose
       # Consumed by: bootstrap.sh (Phase 5)
       # Generated from: apt-mark showmanual on current machine, then curated
       #
       # Version constraints: package>=X.Y means minimum version required
       # Repo annotations: # repo: <url> means package requires external APT repo
       # Auth annotations: # auth: manual means post-install authentication needed

       # === Build Tools ===
       build-essential  # GCC, g++, make, libc-dev — compiling native extensions

       # === Version Control ===
       git>=2.40        # Modern git (switch, restore, sparse-checkout improvements)

       # === Shell & Terminal ===
       zsh              # Primary shell (replacing bash as default)
       bash-completion  # Tab completion for bash fallback
       ...etc
       ```

    4. For section groupings, use approximately these categories (merge or split as the curated list warrants):
       - Build Tools (build-essential, pkg-config if present)
       - Version Control (git)
       - Shell & Terminal (zsh, bash-completion)
       - File & Text Utilities (bat, eza, ripgrep, jq, tree, file, findutils, glow, htop)
       - Search & Navigation (zoxide, fzf are binaries — but if apt-installed, list here)
       - Archive & Network (curl, wget, zip, unzip)
       - Python Development (python3, python3-pip, python3.12, python3.12-venv)
       - Security & Credentials (gnome-keyring, gnupg2, libsecret-1-dev, libsecret-tools)
       - System Libraries (libfuse2t64, fuse)
       - Windows/WSL Integration (wslu, powershell)
       - External Repo Packages (gh — annotated with repo: source)

    5. Every package MUST have an inline comment (after #) explaining why it's in the list.
       PPA/external-repo packages (gh) MUST have a `# repo:` annotation line.
       Auth-required packages (gh) MUST have a `# auth:` annotation line.

    6. Do NOT include packages that will be installed via binary-installs.txt (chezmoi, fnm, bun, starship, age, antidote, uv) or uv-tools.txt (basedpyright, pre-commit, detect-secrets, virtualenv, just).
  </action>
  <verify>
    - File exists: `ls ~/.local/share/chezmoi/apt-packages.txt`
    - Has section headers: `grep -c "^# ===" ~/.local/share/chezmoi/apt-packages.txt` returns 5+
    - Every non-comment, non-blank line has a comment: no bare package names without `#` explanation
    - No transitive deps: packages like `libxcb-xinerama0` should NOT appear
    - git has version constraint: `grep "git>=2" ~/.local/share/chezmoi/apt-packages.txt`
    - gh has repo annotation: `grep -A2 "^gh" ~/.local/share/chezmoi/apt-packages.txt` shows repo line
  </verify>
  <done>apt-packages.txt exists with 20-40 curated packages (down from 101 raw), organized into purpose-based sections, every package annotated with why it's needed, PPA packages annotated with repo source, auth-required tools annotated.</done>
</task>

<task type="auto">
  <name>Task 2: Add apt-packages.txt to chezmoi and commit</name>
  <files>~/.local/share/chezmoi/apt-packages.txt</files>
  <action>
    1. Update .chezmoiignore to include apt-packages.txt (it's a repo-only file, NOT deployed to ~/ by chezmoi apply):
       ```
       # Add to .chezmoiignore:
       apt-packages.txt
       ```

    2. Add and commit to the chezmoi git repo:
       ```bash
       cd ~/.local/share/chezmoi
       git add apt-packages.txt .chezmoiignore
       git commit -m "feat(02): add curated apt package list

       - Auto-discovered from apt-mark showmanual (101 packages)
       - Curated to ~N essential dev packages
       - Grouped by purpose with section headers
       - Every package annotated with rationale
       - PPA packages annotated with repo sources"
       ```

    3. Verify the commit includes the file and .chezmoiignore update.
  </action>
  <verify>
    - `cd ~/.local/share/chezmoi && git log --oneline -1` shows the commit
    - `git diff HEAD~1 --name-only` includes apt-packages.txt and .chezmoiignore
    - `chezmoi managed` does NOT include apt-packages.txt (it's in .chezmoiignore)
  </verify>
  <done>apt-packages.txt is committed to the chezmoi repo and excluded from chezmoi apply (repo-only file for bootstrap consumption).</done>
</task>

</tasks>

<verification>
1. `cat ~/.local/share/chezmoi/apt-packages.txt` shows categorized package list
2. Section count: `grep -c "^# ===" ~/.local/share/chezmoi/apt-packages.txt` >= 5
3. Package count: `grep -cE "^[a-z]" ~/.local/share/chezmoi/apt-packages.txt` is between 20-40
4. Every package annotated: `grep -E "^[a-z]" ~/.local/share/chezmoi/apt-packages.txt | grep -cv "#"` returns 0
5. No binary-install tools in apt list: `grep -cE "^(chezmoi|fnm|bun|starship|age|antidote|uv)\b" ~/.local/share/chezmoi/apt-packages.txt` returns 0
6. File committed: `cd ~/.local/share/chezmoi && git status` shows clean
7. Not in chezmoi managed: `chezmoi managed | grep -c apt-packages` returns 0
</verification>

<success_criteria>
- apt-packages.txt exists in chezmoi repo with 20-40 curated packages (not 101 raw dump)
- Packages are grouped by purpose with clear section headers
- Every package has an inline comment explaining its purpose
- PPA/external-repo packages have repo source annotations
- Auth-required packages have auth annotations
- File is committed and excluded from chezmoi apply
- PKG-01 requirement is satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-package-management-tool-inventory/02-01-SUMMARY.md`
</output>
