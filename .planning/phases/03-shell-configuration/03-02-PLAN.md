---
phase: 03-shell-configuration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - dot_config/zsh/tools.zsh
  - dot_config/zsh/wsl.zsh.tmpl
autonomous: true

must_haves:
  truths:
    - "tools.zsh loads fnm with --use-on-cd flag when fnm is available"
    - "tools.zsh loads fzf integration when fzf is available"
    - "tools.zsh loads zoxide integration when zoxide is available"
    - "All tool integrations gracefully skip when tool is not installed"
    - "wsl.zsh sets up GNOME Keyring and dbus on WSL2"
    - "wsl.zsh sets up WezTerm OSC 7 directory tracking"
    - "wsl.zsh is only deployed on WSL2 machines via chezmoi template"
  artifacts:
    - path: "dot_config/zsh/tools.zsh"
      provides: "fnm, fzf, zoxide integrations with graceful fallbacks"
      contains: "command -v fnm"
    - path: "dot_config/zsh/wsl.zsh.tmpl"
      provides: "WSL2-specific integrations (GNOME Keyring, dbus, WezTerm OSC 7)"
      contains: "DBUS_SESSION_BUS_ADDRESS"
  key_links:
    - from: "dot_config/zsh/tools.zsh"
      to: "fnm binary"
      via: "eval $(fnm env)"
      pattern: "fnm env --use-on-cd"
    - from: "dot_config/zsh/wsl.zsh.tmpl"
      to: "dbus-launch"
      via: "eval for dbus session"
      pattern: "dbus-launch"
---

<objective>
Create tool integration files (fnm, fzf, zoxide) and WSL2-specific configuration (GNOME Keyring, dbus, WezTerm OSC 7).

Purpose: Tool integrations enable Node version management, fuzzy finding, and smart directory jumping. WSL2 config handles platform-specific needs like dbus and terminal cwd tracking.

Output: Two chezmoi source files -- tools.zsh (universal) and wsl.zsh.tmpl (WSL2-conditional via chezmoi).
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-shell-configuration/03-RESEARCH.md
@.planning/phases/03-shell-configuration/03-CONTEXT.md

Reference existing source files:
- ~/.bashrc lines 170-172: NVM setup (being replaced by fnm)
- ~/.bashrc lines 189-196: GNOME Keyring / dbus setup
- ~/.bashrc lines 204-207: WezTerm OSC 7 setup
- ~/.profile line 35: fzf PATH

Chezmoi source directory: ~/.dotfiles
For WSL2-conditional file: use .tmpl suffix so chezmoi processes the Go template.
wsl.zsh.tmpl needs chezmoi template guards for WSL2 detection.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tools.zsh with fnm, fzf, and zoxide integrations</name>
  <files>dot_config/zsh/tools.zsh</files>
  <action>
Create `~/.dotfiles/dot_config/zsh/tools.zsh` with graceful tool loading.

**Critical pattern:** Every tool integration MUST be wrapped in `command -v tool &>/dev/null` check (research pitfall 5). This prevents errors on fresh machines where tools aren't installed yet.

```zsh
# Tool integrations
# Each tool is loaded only if available (graceful on fresh machines)

# --- fnm (Fast Node Manager) ---
# Replaces nvm - 40x faster, Rust-based
if command -v fnm &>/dev/null; then
  eval "$(fnm env --use-on-cd --shell zsh)"
fi

# --- fzf (Fuzzy Finder) ---
if [ -f ~/.fzf.zsh ]; then
  source ~/.fzf.zsh
elif command -v fzf &>/dev/null; then
  eval "$(fzf --zsh)"
fi

# --- zoxide (Smart cd) ---
if command -v zoxide &>/dev/null; then
  eval "$(zoxide init zsh)"
fi
```

**fnm details:**
- `--use-on-cd` enables automatic Node version switching when entering directories with .nvmrc or .node-version
- `--shell zsh` generates zsh-specific shell integration
- Replaces the nvm setup from existing .bashrc lines 170-172

**fzf details:**
- Check ~/.fzf.zsh first (generated by fzf install script)
- Fallback to `fzf --zsh` (newer fzf versions support this)
- This replaces the Oh My Bash fzf plugin from .bashrc line 113

**zoxide details:**
- Simple eval initialization
- This replaces the Oh My Bash zoxide plugin from .bashrc line 115

**Do NOT include:** nvm (replaced by fnm), linuxbrew (removed per decisions), opencode (not in tool inventory).
  </action>
  <verify>
Run: `grep -c 'command -v' ~/.dotfiles/dot_config/zsh/tools.zsh` should return at least 2 (fnm and zoxide checks).
Run: `grep 'nvm\|linuxbrew\|oh-my' ~/.dotfiles/dot_config/zsh/tools.zsh` should return nothing.
Run: `grep 'fnm env --use-on-cd' ~/.dotfiles/dot_config/zsh/tools.zsh` confirms fnm integration.
  </verify>
  <done>tools.zsh loads fnm, fzf, and zoxide with graceful existence checks. No nvm, no linuxbrew, no Oh My Zsh/Bash references.</done>
</task>

<task type="auto">
  <name>Task 2: Create wsl.zsh.tmpl with WSL2-specific integrations</name>
  <files>dot_config/zsh/wsl.zsh.tmpl</files>
  <action>
Create `~/.dotfiles/dot_config/zsh/wsl.zsh.tmpl` with chezmoi template guards.

This file is a chezmoi template (.tmpl suffix). The ENTIRE file content should be wrapped in chezmoi WSL2 detection so it only deploys on WSL2 machines:

```
{{- if eq .chezmoi.os "linux" }}
{{-   if (.chezmoi.kernel.osrelease | lower | contains "microsoft") }}
# WSL2-specific integrations
# This file is only deployed on WSL2 machines (chezmoi template)

# --- GNOME Keyring + dbus ---
# Required for SSH agent and credential storage in WSL2
# Source: existing .bashrc lines 189-196
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
  eval "$(dbus-launch --sh-syntax)"
  dbus-update-activation-environment --all 2>/dev/null
fi

if [ -z "$GNOME_KEYRING_CONTROL" ]; then
  eval "$(echo '' | gnome-keyring-daemon --unlock 2>/dev/null)"
fi

# Export SSH_AUTH_SOCK for GNOME Keyring if available
if [ -d "$XDG_RUNTIME_DIR/keyring" ]; then
  export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/keyring/ssh"
fi

# --- WezTerm OSC 7 ---
# Reports working directory to terminal for cwd inheritance in new tabs/panes
# Source: existing .bashrc lines 204-207
if [[ "$TERM_PROGRAM" == "WezTerm" ]] || command -v wezterm.exe &>/dev/null; then
  # Try official integration file first
  if [ -f /usr/share/wezterm/shell-integration/wezterm.sh ]; then
    source /usr/share/wezterm/shell-integration/wezterm.sh
  else
    # Manual OSC 7 via precmd hook
    __wezterm_osc7() {
      printf "\033]7;file://%s%s\033\\" "${HOST}" "${PWD}"
    }
    autoload -Uz add-zsh-hook
    add-zsh-hook precmd __wezterm_osc7
  fi
fi
{{-   end }}
{{- end }}
```

**Key decisions:**
- Chezmoi template wraps entire file - empty file on non-WSL2 machines
- GNOME Keyring setup preserved from existing .bashrc (lines 189-196)
- dbus-update-activation-environment included (from existing .bashrc)
- WezTerm OSC 7 uses zsh's add-zsh-hook (cleaner than PROMPT_COMMAND from bash)
- Checks for official wezterm integration file first, falls back to manual hook
- XDG_RUNTIME_DIR check for SSH_AUTH_SOCK (research open question 2)

**Important:** This file uses chezmoi Go template syntax. The `{{-` syntax trims whitespace. The template conditionals ensure this file is effectively empty on non-WSL2 systems.
  </action>
  <verify>
Run: `chezmoi cat ~/.config/zsh/wsl.zsh` to confirm chezmoi can render the template (should show content on WSL2).
Run: `grep 'DBUS_SESSION_BUS_ADDRESS' ~/.dotfiles/dot_config/zsh/wsl.zsh.tmpl` confirms GNOME Keyring setup.
Run: `grep 'osc7\|OSC 7\|wezterm' ~/.dotfiles/dot_config/zsh/wsl.zsh.tmpl` confirms WezTerm integration.
Run: `grep '/home/vscode' ~/.dotfiles/dot_config/zsh/wsl.zsh.tmpl` should return nothing.
  </verify>
  <done>wsl.zsh.tmpl deploys WSL2-specific integrations (GNOME Keyring, dbus, WezTerm OSC 7) only on WSL2 machines via chezmoi template guards. Uses zsh-native hooks instead of bash PROMPT_COMMAND. No hardcoded paths.</done>
</task>

</tasks>

<verification>
1. `ls ~/.dotfiles/dot_config/zsh/` shows tools.zsh and wsl.zsh.tmpl
2. `grep -r '/home/vscode' ~/.dotfiles/dot_config/zsh/tools.zsh ~/.dotfiles/dot_config/zsh/wsl.zsh.tmpl` returns nothing
3. `grep -c 'command -v' ~/.dotfiles/dot_config/zsh/tools.zsh` returns >= 2
4. `chezmoi cat ~/.config/zsh/wsl.zsh` renders without template errors
5. `grep 'nvm\|oh-my\|linuxbrew' ~/.dotfiles/dot_config/zsh/tools.zsh` returns nothing
</verification>

<success_criteria>
- tools.zsh loads fnm (with --use-on-cd), fzf, and zoxide with existence checks
- wsl.zsh.tmpl sets up GNOME Keyring, dbus, and WezTerm OSC 7 only on WSL2
- All integrations gracefully skip when tool is missing
- No hardcoded paths, no nvm, no linuxbrew, no Oh My Zsh/Bash references
</success_criteria>

<output>
After completion, create `.planning/phases/03-shell-configuration/03-02-SUMMARY.md`
</output>
