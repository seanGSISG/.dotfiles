---
phase: 03-shell-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dot_config/zsh/exports.zsh
  - dot_config/zsh/plugins.zsh
  - dot_config/zsh/private_dot_zsh_plugins.txt
autonomous: true

must_haves:
  truths:
    - "exports.zsh sets PATH with $HOME/.local/bin, $HOME/bin, $HOME/.bun/bin, $HOME/.fzf/bin"
    - "exports.zsh configures zsh history with dedup, shared history, ignore space"
    - "plugins.zsh sources antidote and loads plugins from .zsh_plugins.txt"
    - "plugins.zsh initializes completion system with day-based .zcompdump caching"
    - ".zsh_plugins.txt lists exactly: zsh-autosuggestions, zsh-syntax-highlighting, zsh-history-substring-search, zsh-completions"
  artifacts:
    - path: "dot_config/zsh/exports.zsh"
      provides: "PATH, environment variables, history configuration, zsh options"
      contains: "HISTSIZE"
    - path: "dot_config/zsh/plugins.zsh"
      provides: "Antidote plugin loading, completion system initialization"
      contains: "antidote load"
    - path: "dot_config/zsh/private_dot_zsh_plugins.txt"
      provides: "Antidote plugin list"
      contains: "zsh-users/zsh-autosuggestions"
  key_links:
    - from: "dot_config/zsh/plugins.zsh"
      to: "dot_config/zsh/private_dot_zsh_plugins.txt"
      via: "antidote load reads plugin list"
      pattern: "antidote load.*\\.zsh_plugins\\.txt"
---

<objective>
Create the zsh foundation files: environment exports (PATH, history, options) and plugin management (antidote + completion system).

Purpose: These are the foundational files that all other zsh config files depend on. PATH must be set before tools load, and plugins must be initialized before completions work.

Output: Three chezmoi source files in dot_config/zsh/ that establish the core zsh environment.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-shell-configuration/03-RESEARCH.md
@.planning/phases/03-shell-configuration/03-CONTEXT.md

Reference existing files being replaced:
- ~/.zshrc (current Oh My Zsh config with powerlevel10k)
- ~/.bashrc (current PATH setup, env vars)
- ~/.profile (current PATH with duplicates)

Chezmoi source directory: ~/.dotfiles
Chezmoi naming: dot_config/zsh/exports.zsh maps to ~/.config/zsh/exports.zsh
For the plugins file (.zsh_plugins.txt starts with dot): use private_dot_zsh_plugins.txt
Non-templated files don't need .tmpl suffix.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create exports.zsh with PATH, environment variables, and history configuration</name>
  <files>dot_config/zsh/exports.zsh</files>
  <action>
Create `~/.dotfiles/dot_config/zsh/exports.zsh` with these sections in order:

**ZDOTDIR:**
```zsh
export ZDOTDIR="${ZDOTDIR:-$HOME/.config/zsh}"
```

**PATH construction** (single authoritative location, no duplication):
```zsh
export PATH="$HOME/.local/bin:$HOME/bin:$HOME/.bun/bin:$HOME/.fzf/bin:$PATH"
```
This consolidates PATH from existing .bashrc (lines 9, 177, 180, 184), .profile (lines 20-27, 30, 35), and .zshrc. Remove the hardcoded `/home/vscode/.opencode/bin` path from .bashrc line 180 -- use `$HOME` if kept at all (but opencode is not in the tool inventory, so omit it).

**Environment variables:**
```zsh
export EDITOR="${EDITOR:-code}"
export LANG="${LANG:-en_US.UTF-8}"
export ENABLE_LSP_TOOLS=1
export BUN_INSTALL="$HOME/.bun"
```
ENABLE_LSP_TOOLS comes from existing .zshrc line 123 and .bashrc line 10. BUN_INSTALL from .bashrc line 183.

**History configuration** (Claude's discretion - research recommends these):
```zsh
export HISTFILE="$HOME/.zsh_history"
export HISTSIZE=100000
export SAVEHIST=100000

setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_SAVE_NO_DUPS
setopt INC_APPEND_HISTORY
setopt SHARE_HISTORY
```

**Zsh options** (good defaults):
```zsh
setopt AUTO_CD              # cd by typing directory name
setopt AUTO_PUSHD           # push directories to stack
setopt PUSHD_IGNORE_DUPS    # no duplicates in dir stack
setopt PUSHD_SILENT         # don't print dir stack after pushd/popd
```

**Important:** No hardcoded paths. All paths use $HOME. No secrets in this file. No FORCE_COLOR (was in .bashrc but not needed with modern tools).
  </action>
  <verify>
Run: `chezmoi cat ~/.config/zsh/exports.zsh` to confirm chezmoi can render the file.
Run: `grep -c '/home/vscode' ~/.dotfiles/dot_config/zsh/exports.zsh` should return 0 (no hardcoded paths).
Run: `grep 'HISTSIZE' ~/.dotfiles/dot_config/zsh/exports.zsh` should show 100000.
  </verify>
  <done>exports.zsh exists with PATH, env vars, history config, and zsh options. No hardcoded paths. No secrets.</done>
</task>

<task type="auto">
  <name>Task 2: Create plugins.zsh with antidote loading and completion system</name>
  <files>dot_config/zsh/plugins.zsh, dot_config/zsh/private_dot_zsh_plugins.txt</files>
  <action>
**Create `~/.dotfiles/dot_config/zsh/plugins.zsh`:**

```zsh
# Antidote plugin manager
# Source: https://github.com/mattmc3/antidote

# Ensure antidote is installed
if [[ ! -d ${ZDOTDIR:-$HOME}/.antidote ]]; then
  echo "Installing antidote..."
  git clone --depth=1 https://github.com/mattmc3/antidote.git ${ZDOTDIR:-$HOME}/.antidote
fi

# Source antidote
source ${ZDOTDIR:-$HOME}/.antidote/antidote.zsh

# Load plugins from .zsh_plugins.txt
antidote load ${ZDOTDIR:-$HOME/.config/zsh}/.zsh_plugins.txt

# --- Completion System ---
# Load completion system (call once only - see research pitfall 3)
autoload -Uz compinit

# Speed optimization: only regenerate .zcompdump once per day
if [[ -n ${ZDOTDIR:-$HOME}/.zcompdump(#qN.mh+24) ]]; then
  compinit -d "${ZDOTDIR:-$HOME}/.zcompdump"
else
  compinit -C -d "${ZDOTDIR:-$HOME}/.zcompdump"
fi

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'   # Case-insensitive
zstyle ':completion:*' menu select                            # Menu selection
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"       # Colored completions
```

**Key decisions:**
- Auto-install antidote if missing (graceful on fresh machines)
- compinit called exactly once (research pitfall 3)
- Day-based .zcompdump caching for performance
- Case-insensitive completion matching
- Menu-style selection for completions

**Create `~/.dotfiles/dot_config/zsh/private_dot_zsh_plugins.txt`:**

The chezmoi name `private_dot_zsh_plugins.txt` maps to `~/.config/zsh/.zsh_plugins.txt` (private_ prefix sets 600 permissions, dot_ maps the leading dot).

Contents:
```txt
# Zsh plugins managed by antidote
# Order matters: syntax-highlighting should be last of the "visual" plugins

# Additional completion definitions
zsh-users/zsh-completions path:src kind:fpath

# Fish-like autosuggestions
zsh-users/zsh-autosuggestions

# History substring search (arrow key navigation)
zsh-users/zsh-history-substring-search

# Real-time syntax highlighting (load last)
zsh-users/zsh-syntax-highlighting
```

**Plugin list rationale:**
- zsh-completions: extra completion definitions, loaded as fpath (before compinit)
- zsh-autosuggestions: fish-like autosuggestions
- zsh-history-substring-search: better history navigation
- zsh-syntax-highlighting: must be loaded last per its README
- fzf and zoxide are NOT in plugin list -- they're loaded via `eval` in tools.zsh (research pattern 5)

**Note on keybindings** (emacs mode is zsh default, no explicit config needed):
After plugins load, bind history-substring-search to arrow keys:
Add to bottom of plugins.zsh after antidote load:
```zsh
# Bind history-substring-search to arrow keys
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
```
  </action>
  <verify>
Run: `ls -la ~/.dotfiles/dot_config/zsh/plugins.zsh ~/.dotfiles/dot_config/zsh/private_dot_zsh_plugins.txt` confirms both files exist.
Run: `grep 'antidote load' ~/.dotfiles/dot_config/zsh/plugins.zsh` confirms plugin loading.
Run: `grep -c 'compinit' ~/.dotfiles/dot_config/zsh/plugins.zsh` should return exactly 2 (autoload + call) or 3 (autoload + 2 conditional calls) -- NOT more.
Run: `wc -l < ~/.dotfiles/dot_config/zsh/private_dot_zsh_plugins.txt` should be around 10-15 lines.
  </verify>
  <done>plugins.zsh loads antidote with auto-install fallback, initializes completion system with day-based caching, and configures completion styling. .zsh_plugins.txt lists exactly the 4 agreed plugins (zsh-completions, zsh-autosuggestions, zsh-history-substring-search, zsh-syntax-highlighting). No Oh My Zsh references.</done>
</task>

</tasks>

<verification>
1. `ls ~/.dotfiles/dot_config/zsh/` shows exports.zsh, plugins.zsh, private_dot_zsh_plugins.txt
2. `grep -r '/home/vscode' ~/.dotfiles/dot_config/zsh/` returns nothing (no hardcoded paths)
3. `grep -c 'compinit' ~/.dotfiles/dot_config/zsh/plugins.zsh` returns 2-3 (exactly one autoload + conditional calls)
4. `grep 'oh-my-zsh\|omz\|OMZ' ~/.dotfiles/dot_config/zsh/` returns nothing (clean break from OMZ)
</verification>

<success_criteria>
- exports.zsh sets PATH, HISTFILE/HISTSIZE/SAVEHIST, zsh options, and environment variables
- plugins.zsh loads antidote with graceful install, initializes completion once with caching
- .zsh_plugins.txt lists the 4 agreed-upon plugins in correct order
- No hardcoded /home/vscode paths anywhere
- No Oh My Zsh references anywhere
</success_criteria>

<output>
After completion, create `.planning/phases/03-shell-configuration/03-01-SUMMARY.md`
</output>
