---
phase: 03-shell-configuration
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - dot_zshrc.tmpl
  - dot_bashrc.tmpl
  - dot_profile
autonomous: false

must_haves:
  truths:
    - ".zshrc sources all modular files in correct order and loads Starship prompt"
    - ".bashrc provides functional fallback with PATH, secrets, fnm, shared aliases, and colored zsh hint banner"
    - ".profile is minimal -- no secrets, no PATH duplication, sources .bashrc if bash"
    - "Developer can source .zshrc and get working zsh with antidote, Starship, fnm, fzf, zoxide loaded"
    - "Developer can source .bashrc and get minimal fallback with hint to use zsh"
    - "All configs use $HOME or chezmoi templates, no hardcoded /home/vscode paths"
  artifacts:
    - path: "dot_zshrc.tmpl"
      provides: "Main zsh config -- pure sourcer with chezmoi WSL2 conditional"
      contains: "source.*exports.zsh"
    - path: "dot_bashrc.tmpl"
      provides: "Bash fallback with banner, PATH, secrets, fnm, shared aliases"
      contains: "zsh.*full dev"
    - path: "dot_profile"
      provides: "Clean .profile -- minimal, sources .bashrc if bash"
  key_links:
    - from: "dot_zshrc.tmpl"
      to: "dot_config/zsh/exports.zsh"
      via: "source command"
      pattern: 'source "\$ZDOTDIR/exports\.zsh"'
    - from: "dot_zshrc.tmpl"
      to: "dot_config/zsh/plugins.zsh"
      via: "source command"
      pattern: 'source "\$ZDOTDIR/plugins\.zsh"'
    - from: "dot_zshrc.tmpl"
      to: "dot_config/zsh/tools.zsh"
      via: "source command"
      pattern: 'source "\$ZDOTDIR/tools\.zsh"'
    - from: "dot_zshrc.tmpl"
      to: "dot_config/zsh/functions.zsh"
      via: "source command"
      pattern: 'source "\$ZDOTDIR/functions\.zsh"'
    - from: "dot_zshrc.tmpl"
      to: "dot_config/zsh/aliases/"
      via: "for loop sourcing all .zsh files"
      pattern: 'for f in.*aliases.*\.zsh'
    - from: "dot_bashrc.tmpl"
      to: "dot_config/zsh/aliases/"
      via: "for loop sourcing shared aliases"
      pattern: 'for f in.*aliases.*\.zsh'
---

<objective>
Create the shell entry points -- .zshrc (pure sourcer), .bashrc (functional fallback with zsh hint), and .profile (minimal clean).

Purpose: These are the files that shell startup reads. .zshrc wires together all the modular files from Plans 01-03. .bashrc provides a functional fallback. .profile is cleaned up.

Output: Three chezmoi source files that serve as shell entry points.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-shell-configuration/03-RESEARCH.md
@.planning/phases/03-shell-configuration/03-CONTEXT.md

**Prior plan outputs (these files must exist before this plan runs):**
@.planning/phases/03-shell-configuration/03-01-SUMMARY.md
@.planning/phases/03-shell-configuration/03-02-SUMMARY.md
@.planning/phases/03-shell-configuration/03-03-SUMMARY.md

Reference existing files being replaced:
- ~/.zshrc (125 lines, Oh My Zsh + powerlevel10k)
- ~/.bashrc (208 lines, Oh My Bash + nvm + linuxbrew + hardcoded paths)
- ~/.profile (36 lines, PATH duplication + secrets)

Chezmoi source directory: ~/.dotfiles
Chezmoi naming: dot_zshrc.tmpl maps to ~/.zshrc (template for WSL conditional)
dot_bashrc.tmpl maps to ~/.bashrc (template for secrets path)
dot_profile maps to ~/.profile (no template needed if no conditional logic)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dot_zshrc.tmpl -- pure sourcer with explicit load order</name>
  <files>dot_zshrc.tmpl</files>
  <action>
Create `~/.dotfiles/dot_zshrc.tmpl` as a pure sourcer. This is a chezmoi template (.tmpl) because it conditionally sources wsl.zsh on WSL2.

The .zshrc MUST be purely a sourcer -- no inline configuration, no aliases, no functions. Everything goes in the modular files.

```zsh
# ~/.zshrc - Modular zsh configuration
# Managed by chezmoi - edit source at ~/.dotfiles/dot_zshrc.tmpl
#
# Load order:
#   1. exports.zsh   - PATH, env vars, history
#   2. plugins.zsh   - antidote, completion system
#   3. tools.zsh     - fnm, fzf, zoxide
#   4. functions.zsh - custom functions, alias help
#   5. aliases/      - categorized alias files
#   6. wsl.zsh       - WSL2-specific (conditional)
#   7. Starship      - prompt (must be last)

ZDOTDIR="${ZDOTDIR:-$HOME/.config/zsh}"

# Source modular config files
source "$ZDOTDIR/exports.zsh"
source "$ZDOTDIR/plugins.zsh"
source "$ZDOTDIR/tools.zsh"
source "$ZDOTDIR/functions.zsh"

# Source all alias files
for f in "$ZDOTDIR/aliases"/*.zsh; do
  [[ -r "$f" ]] && source "$f"
done

# WSL2-specific integrations (conditional via chezmoi template)
{{ if eq .chezmoi.os "linux" -}}
{{   if (.chezmoi.kernel.osrelease | lower | contains "microsoft") -}}
[[ -f "$ZDOTDIR/wsl.zsh" ]] && source "$ZDOTDIR/wsl.zsh"
{{   end -}}
{{ end -}}

# Load secrets from age-encrypted chezmoi-managed file
[[ -f "$HOME/.secrets.env" ]] && source "$HOME/.secrets.env"

# Starship prompt (must be last - it modifies precmd hooks)
if command -v starship &>/dev/null; then
  eval "$(starship init zsh)"
fi
```

**Key decisions:**
- ZDOTDIR set at top for all subsequent source commands
- Explicit load order documented in header comment
- WSL2 conditional uses chezmoi template (not runtime detection) -- file is only sourced if it exists AND we're on WSL2
- Secrets sourced near end (after tools, before prompt)
- Starship init MUST be last (it hooks into precmd)
- Starship has command -v check for graceful handling on fresh machines
- No Oh My Zsh, no powerlevel10k, no p10k references
- No LS_COLORS unset (that was a p10k workaround)

**What's removed from current .zshrc:**
- Oh My Zsh setup (lines 14-86): replaced by antidote in plugins.zsh
- Powerlevel10k instant prompt (lines 7-9): replaced by Starship
- p10k source (line 118): replaced by Starship
- LS_COLORS unset (line 1): p10k workaround no longer needed
- ZSH_THEME (line 22): replaced by Starship
- plugins=() (line 84): replaced by .zsh_plugins.txt
- ENABLE_LSP_TOOLS (line 123): moved to exports.zsh
  </action>
  <verify>
Run: `chezmoi cat ~/.zshrc` to confirm template renders correctly.
Run: `grep -c 'source' ~/.dotfiles/dot_zshrc.tmpl` should show 5 source commands (exports, plugins, tools, functions, wsl).
Run: `grep 'oh-my-zsh\|powerlevel10k\|p10k\|OMZ' ~/.dotfiles/dot_zshrc.tmpl` should return nothing.
Run: `grep 'starship init zsh' ~/.dotfiles/dot_zshrc.tmpl` confirms Starship.
Run: `grep '/home/vscode' ~/.dotfiles/dot_zshrc.tmpl` should return nothing.
  </verify>
  <done>.zshrc is a pure sourcer that loads modular files in explicit order, conditionally sources wsl.zsh on WSL2, loads secrets, and initializes Starship prompt last. No Oh My Zsh, no p10k, no hardcoded paths.</done>
</task>

<task type="auto">
  <name>Task 2: Create dot_bashrc.tmpl -- functional fallback with colored zsh hint</name>
  <files>dot_bashrc.tmpl</files>
  <action>
Create `~/.dotfiles/dot_bashrc.tmpl` as a functional bash fallback. This is a chezmoi template because it may need conditional WSL2 config.

**Design principles from CONTEXT.md decisions:**
- Functional fallback: PATH, secrets, fnm, basic prompt, core aliases
- Bash sources the same alias files from ~/.config/zsh/aliases/
- Noticeable colored banner on bash login: hint to run zsh
- NO Oh My Bash, NO nvm, NO linuxbrew

```bash
# ~/.bashrc - Minimal bash fallback
# Managed by chezmoi - edit source at ~/.dotfiles/dot_bashrc.tmpl
# For full dev environment, use zsh

# Only run in interactive sessions
case $- in
  *i*) ;;
    *) return;;
esac

# --- Colored banner: hint to use zsh ---
if [ -t 1 ]; then
  echo -e "\033[1;33m+------------------------------------------+\033[0m"
  echo -e "\033[1;33m|  Bash fallback - limited environment     |\033[0m"
  echo -e "\033[1;33m|  Run 'zsh' for full dev setup            |\033[0m"
  echo -e "\033[1;33m+------------------------------------------+\033[0m"
  echo ""
fi

# --- PATH ---
export PATH="$HOME/.local/bin:$HOME/bin:$HOME/.bun/bin:$HOME/.fzf/bin:$PATH"

# --- Environment ---
export EDITOR="${EDITOR:-code}"
export LANG="${LANG:-en_US.UTF-8}"
export ENABLE_LSP_TOOLS=1
export BUN_INSTALL="$HOME/.bun"

# --- Secrets ---
[ -f "$HOME/.secrets.env" ] && source "$HOME/.secrets.env"

# --- fnm (Fast Node Manager) ---
if command -v fnm &>/dev/null; then
  eval "$(fnm env --use-on-cd --shell bash)"
fi

# --- fzf ---
if [ -f ~/.fzf.bash ]; then
  source ~/.fzf.bash
elif command -v fzf &>/dev/null; then
  eval "$(fzf --bash)"
fi

# --- zoxide ---
if command -v zoxide &>/dev/null; then
  eval "$(zoxide init bash)"
fi

# --- Source shared alias files ---
for f in "$HOME/.config/zsh/aliases"/*.zsh; do
  [ -r "$f" ] && source "$f"
done

# --- Source shared functions ---
[ -f "$HOME/.config/zsh/functions.zsh" ] && source "$HOME/.config/zsh/functions.zsh"

# --- Bash-specific prompt ---
PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '

# --- History ---
HISTSIZE=10000
HISTFILESIZE=20000
HISTCONTROL=ignoreboth:erasedups
shopt -s histappend

{{ if eq .chezmoi.os "linux" -}}
{{   if (.chezmoi.kernel.osrelease | lower | contains "microsoft") -}}
# --- WSL2: GNOME Keyring + dbus ---
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
  eval "$(dbus-launch --sh-syntax)"
fi

# --- WSL2: WezTerm OSC 7 ---
__wezterm_osc7() {
  printf "\033]7;file://%s%s\033\\" "$HOSTNAME" "$PWD"
}
PROMPT_COMMAND="__wezterm_osc7${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
{{   end -}}
{{ end -}}

# --- Starship prompt (if available, overrides PS1) ---
if command -v starship &>/dev/null; then
  eval "$(starship init bash)"
fi
```

**What's removed from current .bashrc:**
- Oh My Bash setup (lines 8, 14, 80-134): removed entirely
- NVM setup (lines 170-172): replaced by fnm
- Linuxbrew (line 174): removed (decision: no Homebrew on WSL2)
- Hardcoded /home/vscode paths (lines 8, 180, 187): replaced with $HOME
- Oh My Bash theme/plugins (lines 14-118): removed
- FORCE_COLOR (line 168): removed (not needed)
- Personal alias manual load (lines 165-167): replaced by shared alias loop
- Project-specific aliases (prefect line 187): removed (hardcoded path)
- opencode PATH (line 180): removed (not in tool inventory)

**What's preserved:**
- Interactive shell check (case $-...)
- GNOME Keyring + dbus setup (conditional on WSL2)
- WezTerm OSC 7 (using bash's PROMPT_COMMAND, not zsh hooks)
- Secrets loading
- Starship prompt (bash-compatible)
  </action>
  <verify>
Run: `chezmoi cat ~/.bashrc` to confirm template renders correctly.
Run: `grep 'oh-my-bash\|OMB\|OSH\|Oh My\|nvm\|linuxbrew' ~/.dotfiles/dot_bashrc.tmpl` should return nothing.
Run: `grep '/home/vscode' ~/.dotfiles/dot_bashrc.tmpl` should return nothing.
Run: `grep 'full dev' ~/.dotfiles/dot_bashrc.tmpl` confirms zsh hint banner.
Run: `grep 'fnm env.*bash' ~/.dotfiles/dot_bashrc.tmpl` confirms fnm with bash shell.
Run: `grep 'aliases.*\.zsh' ~/.dotfiles/dot_bashrc.tmpl` confirms shared alias sourcing.
  </verify>
  <done>.bashrc is a functional fallback with colored zsh hint banner, PATH, secrets, fnm, fzf, zoxide, shared aliases, and Starship. No Oh My Bash, no nvm, no linuxbrew, no hardcoded paths.</done>
</task>

<task type="auto">
  <name>Task 3: Create dot_profile -- minimal, clean, no secrets, no PATH duplication</name>
  <files>dot_profile</files>
  <action>
Create `~/.dotfiles/dot_profile` as a minimal .profile.

```bash
# ~/.profile: executed by login shells
# Managed by chezmoi - edit source at ~/.dotfiles/dot_profile

# Source .bashrc for bash login shells
if [ -n "$BASH_VERSION" ]; then
  [ -f "$HOME/.bashrc" ] && . "$HOME/.bashrc"
fi
```

**That's it.** The .profile should be minimal per CONTEXT.md decision:
- No secrets (they're loaded by .zshrc and .bashrc)
- No PATH duplication (PATH is set in exports.zsh for zsh, and in .bashrc for bash)
- No pipx path addition (already in .bashrc PATH)
- No fzf path addition (already in .bashrc PATH)
- Just sources .bashrc if running bash

**What's removed from current .profile:**
- PATH additions (lines 20-27, 30, 35): consolidated into .bashrc and exports.zsh
- Secrets loading (line 33): now in .bashrc and .zshrc
- Pipx path (line 30): already in PATH via .bashrc
- fzf path (line 35): already in PATH via .bashrc

**Why no .tmpl:** No chezmoi template logic needed -- this file is the same on all machines.
  </action>
  <verify>
Run: `wc -l < ~/.dotfiles/dot_profile` should be under 15 lines.
Run: `grep 'secrets\|SECRETS\|secrets.env' ~/.dotfiles/dot_profile` should return nothing.
Run: `grep 'PATH' ~/.dotfiles/dot_profile` should return nothing (no PATH duplication).
Run: `grep '/home/vscode' ~/.dotfiles/dot_profile` should return nothing.
  </verify>
  <done>.profile is minimal -- sources .bashrc if bash, nothing else. No secrets, no PATH duplication, no hardcoded paths.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete modular shell configuration with zsh as primary shell, antidote plugins, Starship prompt, 6 categorized alias files, bash fallback, and clean .profile. All managed by chezmoi.</what-built>
  <how-to-verify>
1. Run `chezmoi diff` to review ALL changes that will be applied
2. Run `chezmoi apply --dry-run --verbose` to preview deployment (no changes made)
3. If satisfied, run `chezmoi apply` to deploy all configs
4. Open a new zsh session: verify Starship prompt appears, plugins load, aliases work
5. Run `?` or `halp` to see categorized alias help
6. Run `bash` to verify fallback: see yellow banner, test a few aliases work
7. Run `grep -r '/home/vscode' ~/.config/zsh/ ~/.zshrc ~/.bashrc ~/.profile` to confirm no hardcoded paths
  </how-to-verify>
  <resume-signal>Type "approved" to finalize, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `chezmoi cat ~/.zshrc` renders without errors and shows pure sourcer structure
2. `chezmoi cat ~/.bashrc` renders without errors and shows bash fallback with banner
3. `chezmoi cat ~/.profile` renders without errors and is minimal
4. `grep -r '/home/vscode' ~/.dotfiles/dot_zshrc.tmpl ~/.dotfiles/dot_bashrc.tmpl ~/.dotfiles/dot_profile` returns nothing
5. `grep -r 'oh-my\|OMZ\|OMB\|p10k\|powerlevel10k\|nvm\|linuxbrew' ~/.dotfiles/dot_zshrc.tmpl ~/.dotfiles/dot_bashrc.tmpl ~/.dotfiles/dot_profile` returns nothing
6. Human verification of working shell environment after chezmoi apply
</verification>

<success_criteria>
- .zshrc is a pure sourcer loading modular files in correct order, ending with Starship
- .bashrc is a functional fallback with colored zsh hint, PATH, secrets, fnm, shared aliases, Starship
- .profile is minimal (under 15 lines), no secrets, no PATH duplication
- All three files use $HOME or chezmoi templates, no hardcoded paths
- No references to Oh My Zsh, Oh My Bash, p10k, nvm, or linuxbrew
- Human verifies working shell environment
</success_criteria>

<output>
After completion, create `.planning/phases/03-shell-configuration/03-04-SUMMARY.md`
</output>
