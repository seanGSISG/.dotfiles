---
phase: 01-repository-foundation-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.dotfiles-backup/
  - ~/.local/share/chezmoi/
  - ~/.config/chezmoi/chezmoi.toml
  - ~/key.txt
autonomous: true

must_haves:
  truths:
    - "Existing dotfiles are backed up to ~/.dotfiles-backup/ before chezmoi takes over"
    - "chezmoi is installed and available on PATH"
    - "age is installed and available on PATH"
    - "chezmoi init creates ~/.local/share/chezmoi/ as a git repository"
    - "Age key pair exists with public key configured as chezmoi recipient"
  artifacts:
    - path: "~/.dotfiles-backup/"
      provides: "Tarball backup of existing dotfiles"
    - path: "~/.local/share/chezmoi/.git"
      provides: "Initialized chezmoi git repository"
    - path: "~/.config/chezmoi/chezmoi.toml"
      provides: "chezmoi configuration with age encryption enabled"
      contains: 'encryption = "age"'
    - path: "~/key.txt"
      provides: "Age private key (identity)"
  key_links:
    - from: "~/.config/chezmoi/chezmoi.toml"
      to: "~/key.txt"
      via: "identity path reference"
      pattern: 'identity\s*=\s*".*/key\.txt"'
    - from: "~/.config/chezmoi/chezmoi.toml"
      to: "age public key"
      via: "recipient field"
      pattern: 'recipient\s*=\s*"age1'
---

<objective>
Install chezmoi and age, backup existing dotfiles, initialize the chezmoi repository with age encryption configured from the start.

Purpose: This is the foundational step -- chezmoi repo and age encryption must exist before any files can be added, encrypted, or safety guardrails configured. Backing up existing dotfiles first prevents data loss.
Output: Working chezmoi installation with age encryption, initialized empty repo, backup of existing dotfiles.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-repository-foundation-safety/01-RESEARCH.md
@.planning/phases/01-repository-foundation-safety/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backup existing dotfiles and install chezmoi + age</name>
  <files>
    ~/.dotfiles-backup/
  </files>
  <action>
    1. Create a timestamped backup of existing dotfiles BEFORE any chezmoi operations:
       ```bash
       mkdir -p ~/.dotfiles-backup
       tar czf ~/.dotfiles-backup/pre-chezmoi-$(date +%Y%m%d-%H%M%S).tar.gz \
         -C $HOME \
         .zshrc .bashrc .profile \
         .ssh/ \
         .gitconfig \
         .tmux.conf \
         .oh-my-zsh/ \
         .oh-my-bash/ \
         2>/dev/null || true
       ```
       Include any file that exists; skip missing ones silently. The backup is insurance -- we are NOT deleting originals.

    2. Install chezmoi via the official installer script (not apt -- gets latest v2.x):
       ```bash
       sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $HOME/.local/bin
       ```
       Ensure `~/.local/bin` is on PATH (it should be from .profile).

    3. Install age via apt (stable, sufficient version):
       ```bash
       sudo apt-get update && sudo apt-get install -y age
       ```
       If apt version is too old (< v1.0), fall back to downloading from GitHub releases.

    4. Verify both tools are available:
       ```bash
       chezmoi --version
       age --version
       ```
  </action>
  <verify>
    Run: `chezmoi --version && age --version && ls ~/.dotfiles-backup/pre-chezmoi-*.tar.gz`
    All three commands must succeed. chezmoi should be v2.x, age v1.x, and at least one backup tarball should exist.
  </verify>
  <done>
    chezmoi v2.x and age v1.x are installed and on PATH. A timestamped backup tarball of existing dotfiles exists in ~/.dotfiles-backup/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Initialize chezmoi repository with age encryption</name>
  <files>
    ~/.local/share/chezmoi/
    ~/.config/chezmoi/chezmoi.toml
    ~/key.txt
  </files>
  <action>
    1. Initialize chezmoi (creates ~/.local/share/chezmoi/ as a git repo):
       ```bash
       chezmoi init
       ```

    2. Generate an age key pair:
       ```bash
       chezmoi age-keygen --output=$HOME/key.txt
       ```
       IMPORTANT: Capture the public key from the output (starts with "age1..."). This is needed for the recipient field.

    3. Create the chezmoi configuration file at ~/.config/chezmoi/chezmoi.toml:
       ```toml
       encryption = "age"
       [age]
       identity = "~/key.txt"
       recipient = "age1..."  # Use the ACTUAL public key from step 2
       ```
       Use the real public key captured from `chezmoi age-keygen` output. Do NOT use a placeholder.

    4. Verify encryption works by doing a round-trip test:
       ```bash
       echo "test-secret" > /tmp/test-secret.txt
       chezmoi add --encrypt /tmp/test-secret.txt
       chezmoi cat /tmp/test-secret.txt  # Should output "test-secret"
       chezmoi forget /tmp/test-secret.txt
       rm /tmp/test-secret.txt
       ```
       This confirms: chezmoi can encrypt files with age, store them in the repo, and decrypt them on read.

    5. Verify the source directory is a git repo:
       ```bash
       git -C ~/.local/share/chezmoi rev-parse --is-inside-work-tree
       ```
  </action>
  <verify>
    Run these three checks:
    1. `cat ~/.config/chezmoi/chezmoi.toml` -- must contain `encryption = "age"`, an identity path pointing to ~/key.txt, and a recipient starting with "age1"
    2. `ls ~/key.txt` -- age private key exists
    3. `git -C ~/.local/share/chezmoi rev-parse --is-inside-work-tree` -- returns "true"
    4. Round-trip encryption test passes (encrypt a temp file, read it back, clean up)
  </verify>
  <done>
    chezmoi repository exists at ~/.local/share/chezmoi/ with git initialized. Age encryption is configured in chezmoi.toml with a real key pair. Encryption round-trip test proves encrypt/decrypt works end-to-end.
  </done>
</task>

</tasks>

<verification>
1. `chezmoi --version` outputs v2.x
2. `age --version` outputs v1.x
3. `ls ~/.dotfiles-backup/pre-chezmoi-*.tar.gz` shows at least one backup
4. `cat ~/.config/chezmoi/chezmoi.toml` shows age encryption configured with real key
5. `git -C ~/.local/share/chezmoi status` runs without error
6. `chezmoi doctor` runs without critical errors
</verification>

<success_criteria>
- chezmoi and age are installed and functional
- Existing dotfiles are backed up
- chezmoi repo initialized with age encryption working end-to-end
- Age key pair generated and configured
</success_criteria>

<output>
After completion, create `.planning/phases/01-repository-foundation-safety/01-01-SUMMARY.md`
</output>
