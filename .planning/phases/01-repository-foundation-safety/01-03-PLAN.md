---
phase: 01-repository-foundation-safety
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - ~/.local/share/chezmoi/.chezmoi.toml.tmpl
  - ~/.local/share/chezmoi/README.md
autonomous: false

must_haves:
  truths:
    - "chezmoi.toml.tmpl uses chezmoi template variables for machine-specific values"
    - "README.md documents the stack, bootstrap instructions, age encryption workflow, and Bitwarden key storage"
    - "Remote origin is set to github.com/seanGSISG/.dotfiles.git"
    - "Initial commit is pushed to remote with all safety guardrails and encrypted secrets"
    - "chezmoi apply on a fresh machine would reproduce the setup (given the age key)"
  artifacts:
    - path: "~/.local/share/chezmoi/.chezmoi.toml.tmpl"
      provides: "chezmoi config template for new machine setup"
      contains: ".chezmoi.hostname"
    - path: "~/.local/share/chezmoi/README.md"
      provides: "Project documentation with bootstrap instructions"
      contains: "bootstrap"
  key_links:
    - from: "~/.local/share/chezmoi/.chezmoi.toml.tmpl"
      to: "~/.config/chezmoi/chezmoi.toml"
      via: "chezmoi init renders template to config"
      pattern: "chezmoi\\.(hostname|username)"
    - from: "README.md"
      to: "chezmoi init --apply"
      via: "bootstrap instructions reference"
      pattern: "chezmoi init"
    - from: "git remote origin"
      to: "github.com/seanGSISG/.dotfiles.git"
      via: "git remote -v"
      pattern: "seanGSISG/\\.dotfiles"

user_setup:
  - service: github
    why: "Push initial commit to remote repository"
    env_vars: []
    dashboard_config:
      - task: "Ensure git push authentication works (gh auth or SSH key)"
        location: "Terminal: gh auth login or SSH key setup"
  - service: bitwarden
    why: "Store age encryption key for multi-machine access"
    dashboard_config:
      - task: "Store contents of ~/key.txt as a secure note in Bitwarden"
        location: "Bitwarden vault"
---

<objective>
Create the chezmoi.toml.tmpl template for portable machine config, write a comprehensive README documenting the stack and bootstrap workflow, set the remote origin, and make the initial commit and push.

Purpose: This finalizes the repository foundation. The template ensures new machines get properly configured chezmoi. The README documents everything a future setup needs. The initial push establishes the remote as the source of truth.
Output: Complete, pushed dotfiles repository with documentation, templates, safety guardrails, and encrypted secrets.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-repository-foundation-safety/01-RESEARCH.md
@.planning/phases/01-repository-foundation-safety/01-CONTEXT.md
@.planning/phases/01-repository-foundation-safety/01-01-SUMMARY.md
@.planning/phases/01-repository-foundation-safety/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chezmoi.toml.tmpl and README.md</name>
  <files>
    ~/.local/share/chezmoi/.chezmoi.toml.tmpl
    ~/.local/share/chezmoi/README.md
  </files>
  <action>
    1. Create `.chezmoi.toml.tmpl` in the chezmoi source directory. This template is rendered during `chezmoi init` on a new machine and creates the local chezmoi.toml config.

       ```toml
       # Managed by chezmoi - edit source, not this file
       # Source: ~/.local/share/chezmoi/.chezmoi.toml.tmpl

       encryption = "age"
       [age]
       identity = "~/key.txt"
       recipient = "{{ ACTUAL_PUBLIC_KEY }}"

       [data]
       hostname = "{{ .chezmoi.hostname }}"
       username = "{{ .chezmoi.username }}"
       ```

       Use the ACTUAL age public key from the chezmoi.toml created in Plan 01 (read it from `~/.config/chezmoi/chezmoi.toml`). The `[data]` section provides template variables available to all managed files.

    2. Create `README.md` in the chezmoi source directory. This is a public-facing document for the GitHub repo. It must cover:

       **Structure:**
       - Project title and one-line description
       - Stack overview (chezmoi, zsh, Starship, antidote, fnm, fzf, zoxide, age)
       - Quick start / bootstrap instructions (for new machine)
       - How secrets/encryption work (age key, chezmoi add --encrypt, chezmoi apply)
       - How to store/retrieve the age key (Bitwarden workflow)
       - Directory structure of the chezmoi source
       - Day-to-day usage (chezmoi edit, chezmoi diff, chezmoi apply)
       - Safety notes (never edit target files directly, always dry-run first)

       **Bootstrap section must include:**
       ```
       1. Install chezmoi: sh -c "$(curl -fsLS get.chezmoi.io)"
       2. Retrieve age key from Bitwarden, save to ~/key.txt
       3. Run: chezmoi init --apply https://github.com/seanGSISG/.dotfiles.git
       4. Source secrets: source ~/.secrets.env
       ```

       **Keep it practical, not verbose.** This is a personal dotfiles repo README, not enterprise documentation. Target ~100-150 lines.

    3. Verify .chezmoiignore includes README.md (should already be set from Plan 02) so it won't be applied to home directory.
  </action>
  <verify>
    1. `cat ~/.local/share/chezmoi/.chezmoi.toml.tmpl` contains `encryption = "age"`, a real age public key as recipient, and `{{ .chezmoi.hostname }}` template syntax
    2. `cat ~/.local/share/chezmoi/README.md` contains sections for bootstrap instructions, encryption, and the GitHub repo URL
    3. `grep "README.md" ~/.local/share/chezmoi/.chezmoiignore` confirms README won't be applied to home
    4. `chezmoi apply --dry-run --verbose` does NOT show README.md being applied to ~/
  </verify>
  <done>
    .chezmoi.toml.tmpl exists with real age public key and template variables. README.md documents the full stack, bootstrap workflow, secrets management, and day-to-day usage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Set remote origin, initial commit, and push</name>
  <files>
    ~/.local/share/chezmoi/.git/config
  </files>
  <action>
    1. Set the remote origin to the user's GitHub repo:
       ```bash
       cd ~/.local/share/chezmoi
       git remote add origin https://github.com/seanGSISG/.dotfiles.git
       ```
       If origin already exists, update it: `git remote set-url origin https://github.com/seanGSISG/.dotfiles.git`

    2. Stage all files for the initial commit:
       ```bash
       cd ~/.local/share/chezmoi
       git add -A
       ```

    3. BEFORE committing, verify no secrets are staged:
       ```bash
       cd ~/.local/share/chezmoi
       git diff --cached --name-only
       ```
       Verify:
       - `key.txt` is NOT in the list (blocked by .gitignore)
       - No plaintext secret values appear in any staged file
       - `encrypted_dot_secrets.env.age` IS in the list (encrypted = safe to commit)
       - `.secrets.env.example` IS in the list (placeholder values only)

    4. Run pre-commit hooks on staged files:
       ```bash
       cd ~/.local/share/chezmoi
       pre-commit run --all-files
       ```
       Must pass. If detect-secrets flags the .secrets.env.example, audit the baseline and update:
       ```bash
       detect-secrets scan > .secrets.baseline
       git add .secrets.baseline
       ```

    5. Create the initial commit:
       ```bash
       cd ~/.local/share/chezmoi
       git commit -m "Initial commit: chezmoi repo with age encryption and safety guardrails

       - chezmoi initialized with age encryption
       - Pre-commit hooks with detect-secrets
       - .secrets.env encrypted with age (3 secrets extracted from shell configs)
       - .secrets.env.example template with placeholder values
       - .gitignore blocks age keys
       - .chezmoiignore prevents repo-only files from applying to home
       - .chezmoi.toml.tmpl for portable machine config
       - README with bootstrap instructions"
       ```

    6. Push to remote:
       ```bash
       cd ~/.local/share/chezmoi
       git push -u origin main
       ```
       If the default branch is "master", rename first: `git branch -M main`
       If push fails due to authentication, this will be handled dynamically (auth gate).

    7. Copy .planning/ directory into the chezmoi source (user decision: project history travels with the code):
       ```bash
       cp -r /home/vscode/.planning ~/.local/share/chezmoi/.planning
       cd ~/.local/share/chezmoi
       git add .planning/
       git commit -m "docs: add project planning history"
       git push
       ```
  </action>
  <verify>
    1. `git -C ~/.local/share/chezmoi remote -v` shows origin pointing to `github.com/seanGSISG/.dotfiles.git`
    2. `git -C ~/.local/share/chezmoi log --oneline` shows at least one commit
    3. `git -C ~/.local/share/chezmoi diff --name-only HEAD` is empty (clean working tree)
    4. The .planning/ directory is committed
  </verify>
  <done>
    Remote origin set to github.com/seanGSISG/.dotfiles.git. Initial commit contains all safety guardrails, encrypted secrets, config template, and README. Push to remote succeeds (or auth gate created if authentication needed). .planning/ directory committed per user decision.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete chezmoi-managed dotfiles repository with:
    - age encryption configured and working
    - 3 secrets extracted from shell configs and encrypted
    - Pre-commit hooks blocking plaintext secret commits
    - .secrets.env.example template with placeholder values
    - .chezmoi.toml.tmpl for portable machine config
    - README with bootstrap instructions
    - Pushed to github.com/seanGSISG/.dotfiles.git
  </what-built>
  <how-to-verify>
    1. Visit https://github.com/seanGSISG/.dotfiles to confirm the repo has content
    2. Verify encrypted_dot_secrets.env.age is in the repo (encrypted, not plaintext)
    3. Verify key.txt is NOT in the repo (should be gitignored)
    4. Run locally: `chezmoi apply --dry-run --verbose` to see what chezmoi would apply
    5. Run locally: `chezmoi cat ~/.secrets.env` to confirm secrets decrypt correctly
    6. IMPORTANT: Store the contents of ~/key.txt in Bitwarden as a secure note for multi-machine access
    7. Review README.md on GitHub for accuracy and completeness
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `chezmoi doctor` runs without critical errors
2. `git -C ~/.local/share/chezmoi remote -v` shows correct remote
3. `git -C ~/.local/share/chezmoi log --oneline` shows commits
4. `chezmoi apply --dry-run --verbose` shows expected files
5. `chezmoi cat ~/.secrets.env` outputs decrypted secrets
6. GitHub repo at seanGSISG/.dotfiles contains all expected files
7. No plaintext secrets visible in any committed file
</verification>

<success_criteria>
- .chezmoi.toml.tmpl renders correct config on new machine init
- README documents full bootstrap workflow including Bitwarden key retrieval
- Remote origin set and initial commit pushed
- All Phase 1 requirements (CZMOI-01 through CZMOI-05, SEC-01 through SEC-05) are satisfied
- .planning/ directory committed to the repo
- User has stored age key in Bitwarden (checkpoint verified)
</success_criteria>

<output>
After completion, create `.planning/phases/01-repository-foundation-safety/01-03-SUMMARY.md`
</output>
