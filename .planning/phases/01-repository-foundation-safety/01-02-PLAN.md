---
phase: 01-repository-foundation-safety
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - ~/.local/share/chezmoi/.gitignore
  - ~/.local/share/chezmoi/.chezmoiignore
  - ~/.local/share/chezmoi/.pre-commit-config.yaml
  - ~/.local/share/chezmoi/.secrets.baseline
  - ~/.local/share/chezmoi/.secrets.env.example
  - ~/.local/share/chezmoi/encrypted_dot_secrets.env.age
  - ~/.secrets.env
autonomous: true

must_haves:
  truths:
    - "Pre-commit hooks block any commit containing plaintext secrets"
    - ".gitignore prevents age key from being committed"
    - "Secrets are extracted from .bashrc/.zshrc/.profile into ~/.secrets.env"
    - "~/.secrets.env is stored as an age-encrypted file in the chezmoi repo"
    - ".secrets.env.example exists with placeholder values documenting required secrets"
    - ".chezmoiignore prevents repo-only files (README, .planning/) from being applied to home dir"
  artifacts:
    - path: "~/.local/share/chezmoi/.gitignore"
      provides: "Git ignore patterns preventing key and sensitive file commits"
      contains: "key.txt"
    - path: "~/.local/share/chezmoi/.chezmoiignore"
      provides: "Patterns for files that live in repo but should not be applied to target"
      contains: "README.md"
    - path: "~/.local/share/chezmoi/.pre-commit-config.yaml"
      provides: "Pre-commit hook configuration with detect-secrets"
      contains: "detect-secrets"
    - path: "~/.local/share/chezmoi/.secrets.env.example"
      provides: "Template showing required secret variables with placeholder values"
      contains: "GITHUB_PERSONAL_ACCESS_TOKEN"
    - path: "~/.local/share/chezmoi/encrypted_dot_secrets.env.age"
      provides: "Age-encrypted secrets file in chezmoi source state"
    - path: "~/.secrets.env"
      provides: "Plaintext secrets file in home directory (target state, never committed)"
  key_links:
    - from: "~/.local/share/chezmoi/.pre-commit-config.yaml"
      to: "~/.local/share/chezmoi/.secrets.baseline"
      via: "baseline reference in detect-secrets args"
      pattern: "--baseline.*\\.secrets\\.baseline"
    - from: "~/.local/share/chezmoi/encrypted_dot_secrets.env.age"
      to: "~/.secrets.env"
      via: "chezmoi apply decrypts to target"
      pattern: "chezmoi.*(apply|cat).*secrets"
    - from: "~/.local/share/chezmoi/.gitignore"
      to: "~/key.txt"
      via: "gitignore pattern"
      pattern: "key\\.txt"
---

<objective>
Set up safety guardrails (gitignore, chezmoiignore, pre-commit secret scanning) and extract inline secrets from shell configs into an age-encrypted .secrets.env file managed by chezmoi.

Purpose: Safety guardrails must be in place BEFORE any commits to prevent accidental secret exposure. Secrets must be extracted from shell configs (where they currently live as plaintext) into encrypted storage.
Output: Pre-commit hooks active, .gitignore/.chezmoiignore configured, secrets extracted and encrypted, .secrets.env.example template committed.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-repository-foundation-safety/01-RESEARCH.md
@.planning/phases/01-repository-foundation-safety/01-CONTEXT.md
@.planning/phases/01-repository-foundation-safety/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure safety guardrails (.gitignore, .chezmoiignore, pre-commit hooks)</name>
  <files>
    ~/.local/share/chezmoi/.gitignore
    ~/.local/share/chezmoi/.chezmoiignore
    ~/.local/share/chezmoi/.pre-commit-config.yaml
    ~/.local/share/chezmoi/.secrets.baseline
  </files>
  <action>
    All files are created inside the chezmoi source directory (`~/.local/share/chezmoi/`).

    1. Create `.gitignore` to prevent committing sensitive files:
       ```gitignore
       # Age encryption keys - NEVER commit
       key.txt
       key.txt.bak
       *.age.key

       # Local chezmoi state
       .chezmoidata.json

       # OS artifacts
       .DS_Store
       Thumbs.db
       ```

    2. Create `.chezmoiignore` to prevent repo-only files from being applied to home directory.
       Use chezmoi template syntax. These files exist in the repo but should NOT be copied to ~/
       ```
       README.md
       LICENSE
       .pre-commit-config.yaml
       .secrets.baseline
       .secrets.env.example
       .planning/
       .github/
       ```

    3. Install detect-secrets (needed for pre-commit hook):
       ```bash
       pip install detect-secrets
       ```
       If pip is not available, use `pipx install detect-secrets` or `uv tool install detect-secrets`.

    4. Create `.pre-commit-config.yaml` with detect-secrets hook:
       ```yaml
       repos:
         - repo: https://github.com/Yelp/detect-secrets
           rev: v1.5.0
           hooks:
             - id: detect-secrets
               args: ['--baseline', '.secrets.baseline']
               exclude: |
                 (?x)^(
                   .*\.lock$|
                   .*\.baseline$
                 )$
       ```

    5. Generate the secrets baseline (marks known encrypted files as non-secrets):
       ```bash
       cd ~/.local/share/chezmoi
       detect-secrets scan > .secrets.baseline
       ```

    6. Install pre-commit hooks in the chezmoi repo:
       ```bash
       cd ~/.local/share/chezmoi
       pre-commit install
       ```

    7. Test the hooks:
       ```bash
       cd ~/.local/share/chezmoi
       pre-commit run --all-files
       ```
  </action>
  <verify>
    1. `cat ~/.local/share/chezmoi/.gitignore` contains "key.txt"
    2. `cat ~/.local/share/chezmoi/.chezmoiignore` contains "README.md" and ".planning/"
    3. `cat ~/.local/share/chezmoi/.pre-commit-config.yaml` contains "detect-secrets"
    4. `ls ~/.local/share/chezmoi/.secrets.baseline` exists
    5. Run `cd ~/.local/share/chezmoi && pre-commit run --all-files` -- should pass (or show hooks are installed)
    6. `git -C ~/.local/share/chezmoi log --oneline` -- no commits yet (safety first, commit in Plan 03)
  </verify>
  <done>
    .gitignore blocks key.txt from git. .chezmoiignore prevents repo-only files from being applied to home. Pre-commit hooks with detect-secrets are installed and functional. Baseline generated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract secrets and create encrypted .secrets.env</name>
  <files>
    ~/.secrets.env
    ~/.local/share/chezmoi/encrypted_dot_secrets.env.age
    ~/.local/share/chezmoi/.secrets.env.example
  </files>
  <action>
    1. Audit existing shell configs for inline secrets. Known secrets from the current machine:
       - `GITHUB_PERSONAL_ACCESS_TOKEN` (in .bashrc line 201, .profile line 31)
       - `EXA_API_KEY` (in .bashrc line 185, .zshrc line 119)
       - `GREPTILE_API_KEY` (in .bashrc line 186)

       Also check for any other secrets (SSH keys are handled separately via chezmoi private_ prefix in later phases).

    2. Create `~/.secrets.env` with the REAL secret values extracted from the shell configs:
       ```bash
       # Secrets - sourced by shell configs
       # Managed by chezmoi with age encryption
       # DO NOT commit this file unencrypted

       export GITHUB_PERSONAL_ACCESS_TOKEN="<actual value from .bashrc>"
       export EXA_API_KEY="<actual value from .bashrc>"
       export GREPTILE_API_KEY="<actual value from .bashrc>"
       ```
       Copy the ACTUAL values from the existing shell config files. These are the user's real secrets.

    3. Add the secrets file to chezmoi with encryption:
       ```bash
       chezmoi add --encrypt ~/.secrets.env
       ```
       This creates `encrypted_dot_secrets.env.age` in the chezmoi source directory.

    4. Verify the encrypted file exists and the plaintext is NOT in the source:
       ```bash
       ls ~/.local/share/chezmoi/encrypted_dot_secrets.env.age
       # Should NOT contain plaintext -- verify:
       file ~/.local/share/chezmoi/encrypted_dot_secrets.env.age
       # Should show "ASCII text" with age header, not the actual secrets
       ```

    5. Verify round-trip works:
       ```bash
       chezmoi cat ~/.secrets.env
       # Should output the plaintext secrets
       ```

    6. Create `.secrets.env.example` in the chezmoi source directory (NOT encrypted -- this is a template for documentation):
       ```bash
       cat > ~/.local/share/chezmoi/.secrets.env.example <<'EOF'
       # Secrets Environment Variables
       # Copy to ~/.secrets.env and fill in real values
       # Then run: chezmoi add --encrypt ~/.secrets.env
       #
       # On new machine: chezmoi apply will decrypt and place at ~/.secrets.env
       # Source this file from your shell config: source ~/.secrets.env

       export GITHUB_PERSONAL_ACCESS_TOKEN="ghp_your_token_here"
       export EXA_API_KEY="your-exa-api-key-here"
       export GREPTILE_API_KEY="your-greptile-api-key-here"
       EOF
       ```

    7. Re-generate the detect-secrets baseline (now that encrypted files exist):
       ```bash
       cd ~/.local/share/chezmoi
       detect-secrets scan > .secrets.baseline
       ```

    8. Verify pre-commit hooks still pass with the new files:
       ```bash
       cd ~/.local/share/chezmoi && pre-commit run --all-files
       ```
  </action>
  <verify>
    1. `ls ~/.local/share/chezmoi/encrypted_dot_secrets.env.age` -- encrypted file exists
    2. `chezmoi cat ~/.secrets.env` -- outputs plaintext with all three secret variables
    3. `grep -c "age1" ~/.local/share/chezmoi/encrypted_dot_secrets.env.age` -- contains age encryption header (not plaintext)
    4. `cat ~/.local/share/chezmoi/.secrets.env.example` -- contains placeholder values, NOT real secrets
    5. `cd ~/.local/share/chezmoi && pre-commit run --all-files` -- passes
  </verify>
  <done>
    Three secrets (GITHUB_PERSONAL_ACCESS_TOKEN, EXA_API_KEY, GREPTILE_API_KEY) are extracted from shell configs into ~/.secrets.env. The file is stored age-encrypted in the chezmoi repo. A .secrets.env.example template with placeholder values exists for documentation. Pre-commit hooks pass with all new files.
  </done>
</task>

</tasks>

<verification>
1. `git -C ~/.local/share/chezmoi status` shows .gitignore, .chezmoiignore, .pre-commit-config.yaml, .secrets.baseline, .secrets.env.example, and encrypted_dot_secrets.env.age as untracked (ready for commit in Plan 03)
2. `chezmoi apply --dry-run --verbose` shows it would create ~/.secrets.env from encrypted source
3. `cd ~/.local/share/chezmoi && pre-commit run --all-files` passes
4. `grep -r "GITHUB_PERSONAL_ACCESS_TOKEN" ~/.local/share/chezmoi/ --include="*.example"` shows ONLY the placeholder, never the real value
</verification>

<success_criteria>
- Safety guardrails are active: .gitignore blocks keys, pre-commit hooks scan for secrets
- All three known secrets extracted from shell configs into encrypted .secrets.env
- .secrets.env.example template committed with placeholder values
- .chezmoiignore prevents repo-only files from polluting home directory
- chezmoi can decrypt and apply .secrets.env on demand
</success_criteria>

<output>
After completion, create `.planning/phases/01-repository-foundation-safety/01-02-SUMMARY.md`
</output>
