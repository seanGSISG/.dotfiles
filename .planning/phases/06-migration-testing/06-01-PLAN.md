---
phase: 06-migration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bootstrap.sh
autonomous: true

must_haves:
  truths:
    - "Bootstrap prompts user to paste age encryption key if ~/.config/age/keys.txt is missing"
    - "SSH private keys are age-encrypted in chezmoi source repo"
    - "chezmoi apply deploys SSH keys with correct permissions (700 dir, 600 private keys, 644 pub keys)"
  artifacts:
    - path: "bootstrap.sh"
      provides: "Age key prompt before chezmoi apply"
      contains: "age/keys.txt"
    - path: "encrypted_private_dot_ssh/private_idm-prod-key.age"
      provides: "Age-encrypted SSH private key for Azure VM"
    - path: "private_dot_ssh/authorized_keys"
      provides: "SSH authorized_keys managed by chezmoi"
  key_links:
    - from: "bootstrap.sh"
      to: "~/.config/age/keys.txt"
      via: "Prompt user to paste key before chezmoi apply"
      pattern: "age.*keys.*paste"
    - from: "chezmoi apply"
      to: "~/.ssh/"
      via: "Deploys encrypted SSH keys to home directory"
      pattern: "private_dot_ssh"
---

<objective>
Add SSH keys to chezmoi repo (age-encrypted) and add age key prompt to bootstrap.sh so SSH keys deploy automatically on new machine without manual SCP.

Purpose: Eliminates manual SSH key transfer step — keys are encrypted in the repo and deploy automatically when age key is present. Bootstrap prompts for the age key if missing, ensuring chezmoi can decrypt everything on first run.

Output: SSH keys in chezmoi source (encrypted), bootstrap with age key interactive prompt.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-migration-testing/06-CONTEXT.md
@bootstrap.sh
@.chezmoi.toml.tmpl
@.chezmoiignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SSH keys to chezmoi repo with age encryption</name>
  <files>
    encrypted_private_dot_ssh/ (new - encrypted SSH private keys)
    private_dot_ssh/ (new - unencrypted SSH public keys and config)
  </files>
  <action>
Add the entire ~/.ssh/ directory to chezmoi source, encrypting private keys:

1. Add SSH private keys with encryption:
   ```bash
   chezmoi add --encrypt ~/.ssh/idm-prod-key
   ```

2. Add SSH public keys and other files WITHOUT encryption (they're not secrets):
   ```bash
   chezmoi add ~/.ssh/idm-prod-key.pub
   chezmoi add ~/.ssh/authorized_keys
   chezmoi add ~/.ssh/known_hosts
   ```

3. Verify the chezmoi source has the correct structure:
   - `encrypted_private_dot_ssh/` directory with `.age` files for private keys
   - `private_dot_ssh/` directory with plain files for pub keys, config, known_hosts, authorized_keys
   - If chezmoi puts them all under one directory, that's fine — the key thing is private keys are `.age` encrypted

4. After adding, verify with `chezmoi managed --include=files | grep ssh` that SSH files are tracked.

5. Remove the interactive SSH key copy section from bootstrap.sh (the `setup_ssh_keys()` function and its `run_step` call in `main()`), since SSH keys now deploy automatically via chezmoi apply. Keep the SSH verification step in the post-install checklist.

IMPORTANT: Do NOT add the SSH config file — it does not exist in ~/.ssh/ on the current machine. Only add files that actually exist: idm-prod-key, idm-prod-key.pub, authorized_keys, known_hosts.
IMPORTANT: The `.chezmoi.toml.tmpl` already has age encryption configured, so `chezmoi add --encrypt` will use age automatically.
  </action>
  <verify>
Run these checks:
- `chezmoi managed --include=files | grep -i ssh` shows SSH files tracked
- `ls ~/.dotfiles/encrypted_private_dot_ssh/` or similar shows .age files for private keys
- `chezmoi diff` shows no unexpected changes
- `bash -n bootstrap.sh` passes syntax check
- `grep -c 'setup_ssh_keys' bootstrap.sh` returns 0 (function removed)
  </verify>
  <done>
SSH private keys are age-encrypted in chezmoi source. SSH public keys and other files are tracked unencrypted. The interactive SSH copy step is removed from bootstrap.sh since keys now deploy via chezmoi apply.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add age key paste prompt to bootstrap.sh</name>
  <files>bootstrap.sh</files>
  <action>
Add a new function `setup_age_key()` to bootstrap.sh that prompts the user to paste their age encryption key if `~/.config/age/keys.txt` doesn't exist. This must run BEFORE `setup_chezmoi()` (which calls chezmoi apply) so encrypted files can be decrypted.

Function logic:
1. Check if `~/.config/age/keys.txt` exists — if yes, log_skip and return
2. If not found, display a message explaining what the age key is and where to find it (Bitwarden)
3. Prompt: "Paste your age secret key (starts with AGE-SECRET-KEY-1...) or press Enter to skip:"
4. If user pastes a key:
   - Validate it starts with `AGE-SECRET-KEY-` (basic sanity check)
   - Create directory: `mkdir -p ~/.config/age`
   - Write key to `~/.config/age/keys.txt`
   - Set permissions: `chmod 600 ~/.config/age/keys.txt`
   - log_success "Age encryption key saved"
5. If user presses Enter (empty input):
   - log_skip "Age key setup skipped — encrypted files will not be decrypted"
   - Print warning that `chezmoi apply` will skip encrypted files
   - Return 0 (not a failure — user can add later)

Wire into main():
- Add `run_step "Age Key" setup_age_key` AFTER "Chezmoi Configuration" installs chezmoi but BEFORE the line where chezmoi apply runs.
- Actually, looking at the current code, `setup_chezmoi()` both installs chezmoi AND runs apply. So add the age key prompt BETWEEN chezmoi install and chezmoi apply. The cleanest approach: split `setup_chezmoi()` into two functions:
  - `install_chezmoi()` — install chezmoi binary + clone repo if needed
  - `apply_chezmoi()` — run chezmoi init --apply
  Then wire in main as: install_chezmoi -> setup_age_key -> apply_chezmoi

Also update the existing age key warning in the chezmoi section — remove it since the prompt now handles this case earlier.

Update the post-install checklist: change the "Age Encryption Key" item from "Retrieve from Bitwarden" to "If skipped during setup, retrieve from Bitwarden and save to ~/.config/age/keys.txt, then run chezmoi apply".
  </action>
  <verify>
Run these checks:
- `bash -n bootstrap.sh` passes syntax check
- `grep -q 'setup_age_key' bootstrap.sh` — function exists
- `grep -q 'AGE-SECRET-KEY' bootstrap.sh` — validation present
- `grep -q 'install_chezmoi' bootstrap.sh && grep -q 'apply_chezmoi' bootstrap.sh` — both split functions exist
- Verify ordering in main(): `grep -A 50 'main()' bootstrap.sh | grep -oP '(install_chezmoi|setup_age_key|apply_chezmoi)' | tr '\n' ' '` outputs `install_chezmoi setup_age_key apply_chezmoi` in that order
  </verify>
  <done>
Bootstrap prompts for age key paste before chezmoi apply. User can paste key or skip. Age key is validated and saved with correct permissions. Chezmoi apply runs after age key is in place, allowing all encrypted files (secrets, SSH keys) to be decrypted.
  </done>
</task>

</tasks>

<verification>
1. `bash -n bootstrap.sh` — syntax check passes
2. `chezmoi managed --include=files | grep ssh` — SSH files tracked
3. `grep -q 'setup_age_key' bootstrap.sh` — age prompt function exists
4. `grep -q 'AGE-SECRET-KEY' bootstrap.sh` — key validation present
5. `chezmoi verify` — chezmoi source is valid (or `chezmoi doctor`)
6. SSH private keys in chezmoi source are .age encrypted files
</verification>

<success_criteria>
- SSH keys are age-encrypted in chezmoi repo and will deploy on `chezmoi apply`
- Bootstrap prompts for age key before chezmoi apply
- Interactive SSH copy function is removed from bootstrap (replaced by chezmoi-managed keys)
- All existing bootstrap functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/06-migration-testing/06-01-SUMMARY.md`
</output>
