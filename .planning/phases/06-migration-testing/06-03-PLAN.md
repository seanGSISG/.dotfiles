---
phase: 06-migration-testing
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Developer can run single bootstrap.sh command on fresh WSL2 Ubuntu and get complete working environment"
    - "Developer can start new shell and see Starship prompt with all integrations working"
    - "Developer can use all aliases, functions, and tools (fnm, fzf, zoxide, gh, tmux) without errors"
    - "Developer can access production Azure VM via SSH with idm-prod-key"
    - "Age-decrypted secrets are available in environment variables"
    - "All tool configs (git, tmux) work correctly on new machine with user adminuser"
  artifacts: []
  key_links:
    - from: "bootstrap.sh (via curl)"
      to: "complete working environment"
      via: "Single command deployment"
      pattern: "curl.*bootstrap"
    - from: "verify.sh"
      to: "all checks pass"
      via: "Post-deployment validation"
      pattern: "PASS.*FAIL"
---

<objective>
Deploy the complete dotfiles environment to the fresh WSL2 Ubuntu machine (user adminuser) via curl, validate with verify.sh, and confirm all 6 Phase 6 success criteria are met.

Purpose: This is the real-world deployment that validates all 19 plans across 7 phases work end-to-end on a fresh machine. Everything built so far converges here.

Output: Working dev environment on new machine, verified by verify.sh.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-migration-testing/06-CONTEXT.md
@.planning/phases/06-migration-testing/06-01-SUMMARY.md
@.planning/phases/06-migration-testing/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push all changes and prepare deployment command</name>
  <files></files>
  <action>
Ensure all Phase 6 changes (SSH keys in chezmoi, bootstrap logging, age key prompt, verify.sh) are committed and pushed to GitHub.

1. Run `git -C ~/.dotfiles status` to check for uncommitted changes
2. If any uncommitted changes exist from plans 06-01 and 06-02, ensure they're committed
3. Push to GitHub: `git -C ~/.dotfiles push`
4. Verify the raw URL works by constructing it:
   ```
   https://raw.githubusercontent.com/{GITHUB_REPO}/main/bootstrap.sh
   ```
   Print the exact curl command the user will run on the new machine:
   ```bash
   curl -fsSL https://raw.githubusercontent.com/{GITHUB_REPO}/main/bootstrap.sh | bash
   ```
   (Replace {GITHUB_REPO} with actual repo from git remote)

5. Also print the verify.sh command for post-deployment:
   ```bash
   bash ~/.dotfiles/verify.sh
   ```

Print all commands clearly for the user to copy to the new machine.
  </action>
  <verify>
- `git -C ~/.dotfiles status` shows clean working tree (no uncommitted changes)
- `git -C ~/.dotfiles log --oneline -5` shows recent commits with Phase 6 changes
- Curl command is printed with correct GitHub repo URL
  </verify>
  <done>
All Phase 6 changes pushed to GitHub. Deployment curl command ready for user to run on fresh machine.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Deploy on fresh WSL2 Ubuntu machine (user adminuser)</name>
  <action>
Run the bootstrap on the fresh WSL2 Ubuntu machine (user adminuser).
  </action>
  <instructions>
On the **new machine** (WSL2 Ubuntu, user adminuser):

**Step 1: Run bootstrap**
```bash
curl -fsSL https://raw.githubusercontent.com/{GITHUB_REPO}/main/bootstrap.sh | bash
```

During bootstrap:
- When prompted for age encryption key: paste the key from Bitwarden
- When prompted for password (chsh): enter your password
- Watch for any errors in the output

**Step 2: Follow post-install checklist**
The script will print a checklist. Complete each item:
1. Age key (already done during bootstrap if you pasted it)
2. `gh auth login`
3. Open tmux, press `prefix + I`
4. `claude login`
5. `ssh -T git@github.com`
6. WSL restart if needed (`wsl.exe --shutdown` from PowerShell)

**Step 3: Verify age-decrypted secrets are available**
Open a new zsh shell, then run:
```bash
source ~/.secrets.env && env | grep -c '.'
```
If secrets are loaded, this will show environment variable count. Verify at least one expected secret is set:
```bash
source ~/.secrets.env && [ -n "$GITHUB_TOKEN" ] && echo "Secrets OK" || echo "Secrets MISSING"
```
(Replace `GITHUB_TOKEN` with any known secret key from your .secrets.env)

**Step 4: Run verify.sh**
```bash
bash ~/.dotfiles/verify.sh
```

**Step 5: Report results**
Share:
- The verify.sh output (all pass/fail lines)
- The bootstrap log file contents (if any failures): `cat ~/.dotfiles-bootstrap-*.log`
- Whether Starship prompt appears in new zsh shell
- Whether `ssh idm-prod-key` connection works to Azure VM
- Whether `source ~/.secrets.env` successfully loaded environment variables (Step 3 result)
  </instructions>
  <resume-signal>Share verify.sh output and any issues encountered. Type "all-pass" if everything works, or describe failures.</resume-signal>
</task>

</tasks>

<verification>
After user reports results:
1. verify.sh shows all checks passing (0 failures)
2. User confirms Starship prompt visible in zsh
3. User confirms SSH to Azure VM works
4. User confirms age-decrypted secrets are available
5. User confirms tools work (fnm, fzf, zoxide, gh, tmux)
6. User confirms git config shows correct name/email for adminuser machine
</verification>

<success_criteria>
All 6 Phase 6 success criteria met:
1. Single bootstrap.sh command on fresh WSL2 Ubuntu produces complete working environment
2. New shell shows Starship prompt with all integrations
3. All aliases, functions, and tools work without errors
4. Production Azure VM accessible via SSH with idm-prod-key
5. Age-decrypted secrets available in environment variables
6. All tool configs work correctly on new machine with user adminuser
</success_criteria>

<output>
After completion, create `.planning/phases/06-migration-testing/06-03-SUMMARY.md`
</output>
