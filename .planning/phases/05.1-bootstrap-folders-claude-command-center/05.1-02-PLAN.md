---
phase: 05.1-bootstrap-folders-claude-command-center
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - create_dot_claude/scripts/lib/utils.js
  - create_dot_claude/scripts/hooks/session-start.js
  - create_dot_claude/scripts/hooks/session-end.js
  - create_dot_claude/scripts/hooks/pre-compact.js
  - create_dot_claude/scripts/hooks/evaluate-session.js
autonomous: true

must_haves:
  truths:
    - "Hook scripts are deployed to ~/.claude/scripts/hooks/ on first chezmoi apply"
    - "utils.js provides cross-platform helper functions used by all hook scripts"
    - "session-start.js loads previous session context on new session"
    - "session-end.js persists session state with timestamp tracking"
    - "pre-compact.js saves state before context compaction"
    - "evaluate-session.js evaluates session for extractable learning patterns"
    - "All hooks exit 0 on errors (never block Claude Code)"
  artifacts:
    - path: "create_dot_claude/scripts/lib/utils.js"
      provides: "Cross-platform utility functions (getSessionsDir, ensureDir, findFiles, log, etc.)"
      min_lines: 80
    - path: "create_dot_claude/scripts/hooks/session-start.js"
      provides: "SessionStart hook - loads previous context"
      min_lines: 20
      contains: "process.exit(0)"
    - path: "create_dot_claude/scripts/hooks/session-end.js"
      provides: "SessionEnd hook - persists session state"
      min_lines: 30
      contains: "process.exit(0)"
    - path: "create_dot_claude/scripts/hooks/pre-compact.js"
      provides: "PreCompact hook - saves state before compaction"
      min_lines: 20
      contains: "process.exit(0)"
    - path: "create_dot_claude/scripts/hooks/evaluate-session.js"
      provides: "SessionEnd hook - evaluates patterns for learning"
      min_lines: 25
      contains: "process.exit(0)"
  key_links:
    - from: "create_dot_claude/scripts/hooks/session-start.js"
      to: "create_dot_claude/scripts/lib/utils.js"
      via: "require('../lib/utils')"
      pattern: "require.*lib/utils"
    - from: "create_dot_claude/scripts/hooks/session-end.js"
      to: "create_dot_claude/scripts/lib/utils.js"
      via: "require('../lib/utils')"
      pattern: "require.*lib/utils"
    - from: "create_dot_claude/scripts/hooks/pre-compact.js"
      to: "create_dot_claude/scripts/lib/utils.js"
      via: "require('../lib/utils')"
      pattern: "require.*lib/utils"
    - from: "create_dot_claude/scripts/hooks/evaluate-session.js"
      to: "create_dot_claude/scripts/lib/utils.js"
      via: "require('../lib/utils')"
      pattern: "require.*lib/utils"
---

<objective>
Create the Claude Code hook scripts and shared utility library for deployment to ~/.claude/scripts/.

Purpose: These hook scripts provide session persistence (session-start, session-end, pre-compact) and continuous learning evaluation (evaluate-session). They are the runtime backbone of the Claude Code environment, firing on session lifecycle events.

Output: 4 hook scripts + 1 shared utility library, all in chezmoi source under create_dot_claude/scripts/
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05.1-bootstrap-folders-claude-command-center/05.1-CONTEXT.md
@.planning/phases/05.1-bootstrap-folders-claude-command-center/05.1-RESEARCH.md

Reference sources (adapt, do NOT copy verbatim):
@.planning/research/temp/everything-claude-code-main/scripts/lib/utils.js
@.planning/research/temp/everything-claude-code-main/scripts/hooks/session-start.js
@.planning/research/temp/everything-claude-code-main/scripts/hooks/session-end.js
@.planning/research/temp/everything-claude-code-main/scripts/hooks/pre-compact.js
@.planning/research/temp/everything-claude-code-main/scripts/hooks/evaluate-session.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared utility library (utils.js)</name>
  <files>create_dot_claude/scripts/lib/utils.js</files>
  <action>
Create the `create_dot_claude/scripts/lib/utils.js` file in the chezmoi source directory (~/.dotfiles/).

IMPORTANT: The `create_` prefix on the parent directory means chezmoi will deploy this ONLY if ~/.claude/ doesn't already exist. This is by design — preserves user customizations.

Adapt from the reference utils.js at `.planning/research/temp/everything-claude-code-main/scripts/lib/utils.js`. This is a LINUX-ONLY deployment (WSL2 Ubuntu), so simplify cross-platform code:

Include these functions (essential for hook scripts):
- `getHomeDir()` — returns os.homedir()
- `getClaudeDir()` — returns ~/.claude
- `getSessionsDir()` — returns ~/.claude/sessions
- `getInsightsDir()` — returns ~/.claude/insights (renamed from homunculus per user decision)
- `getLearnedSkillsDir()` — returns ~/.claude/skills/learned
- `ensureDir(dirPath)` — mkdir -p equivalent
- `getDateString()` — YYYY-MM-DD format
- `getTimeString()` — HH:MM format
- `getDateTimeString()` — YYYY-MM-DD HH:MM:SS format
- `getSessionIdShort(fallback)` — last 8 chars of CLAUDE_SESSION_ID env var
- `getProjectName()` — from git repo or cwd
- `findFiles(dir, pattern, options)` — glob-like file search with maxAge filter
- `readFile(filePath)` — safe file read returning null on error
- `writeFile(filePath, content)` — write file, creating parent dirs
- `appendFile(filePath, content)` — append to file, creating parent dirs
- `replaceInFile(filePath, search, replace)` — regex replace in file
- `countInFile(filePath, pattern)` — count regex matches
- `readStdinJson()` — async Promise for reading hook JSON input from stdin
- `log(message)` — console.error (visible to user in Claude Code)
- `output(data)` — console.log (returned to Claude)
- `runCommand(cmd, options)` — execSync wrapper
- `isGitRepo()` — check if cwd is git repo

REMOVE from reference (not needed for Linux-only):
- isWindows, isMacOS platform detection (keep isLinux as constant true)
- Windows-specific commandExists logic
- getAliasesPath (session aliases feature not included)
- getGitModifiedFiles (not used by our hooks)
- grepFile (not used by our hooks)

Hardcode `~/.claude/` paths as decided in CONTEXT.md. No CLAUDE_PLUGIN_ROOT indirection.

Export all functions via module.exports.
  </action>
  <verify>
    Run: `node -c ~/.dotfiles/create_dot_claude/scripts/lib/utils.js` — syntax check passes
    Run: `node -e "const u = require('$HOME/.dotfiles/create_dot_claude/scripts/lib/utils.js'); console.log(Object.keys(u).length)"` — should show 15+ exports
    Run: `node -e "const u = require('$HOME/.dotfiles/create_dot_claude/scripts/lib/utils.js'); console.log(u.getSessionsDir())"` — should print path containing .claude/sessions
    Run: `node -e "const u = require('$HOME/.dotfiles/create_dot_claude/scripts/lib/utils.js'); console.log(u.getInsightsDir())"` — should print path containing .claude/insights
  </verify>
  <done>
    utils.js exists at create_dot_claude/scripts/lib/utils.js with 15+ exported utility functions.
    All functions use ~/.claude/ hardcoded paths (not CLAUDE_PLUGIN_ROOT).
    Uses "insights" directory name (not "homunculus").
    Node.js syntax check passes.
    Functions return correct paths when tested.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create session hook scripts (session-start, session-end, pre-compact, evaluate-session)</name>
  <files>
    create_dot_claude/scripts/hooks/session-start.js
    create_dot_claude/scripts/hooks/session-end.js
    create_dot_claude/scripts/hooks/pre-compact.js
    create_dot_claude/scripts/hooks/evaluate-session.js
  </files>
  <action>
Create 4 hook scripts in `create_dot_claude/scripts/hooks/` adapting from reference implementations. All scripts share these patterns:

**Common patterns for ALL hooks:**
- Shebang: `#!/usr/bin/env node`
- Import from `../lib/utils` (NOT `../lib/package-manager` or `../lib/session-aliases` — those don't exist in our deployment)
- Main function is async, wrapped in `.catch()` that exits 0 (NEVER block Claude Code)
- All errors log to stderr via `log()` and exit 0

**1. session-start.js** (SessionStart hook)
Adapt from reference, but REMOVE:
- Package manager detection (getPackageManager, getSelectionPrompt) — not relevant
- Session aliases (listAliases) — not included

KEEP:
- Check for recent session files (last 7 days) via findFiles
- Log count of recent sessions
- Check for learned skills in getLearnedSkillsDir()
- ensureDir for sessions and learned dirs

**2. session-end.js** (SessionEnd hook)
Adapt from reference. KEEP the full implementation:
- Creates/updates session file: `{date}-{shortId}-session.tmp`
- If session file exists, updates "Last Updated" timestamp
- If new, creates template with Date, Started, Last Updated, sections for Completed/In Progress/Notes/Context
- Uses getDateString(), getTimeString(), getSessionIdShort()

**3. pre-compact.js** (PreCompact hook)
Adapt from reference. KEEP the full implementation:
- Logs compaction event to compaction-log.txt in sessions dir
- Notes compaction in active session file if one exists
- Uses getDateTimeString(), findFiles(), appendFile()

**4. evaluate-session.js** (SessionEnd hook — evaluates patterns)
Adapt from reference with these changes:
- Update config path to look for `~/.claude/skills/continuous-learning-v2/config.json` (hardcoded, not relative to __dirname)
- Update learned skills path to use `~/.claude/insights/instincts/personal/` (renamed from homunculus)
- Keep min session length check (default 10 messages)
- Keep CLAUDE_TRANSCRIPT_PATH environment variable check
- Keep message count logic
- Log to ~/.claude/insights/ directory (not homunculus)

Each script should have a JSDoc comment block at the top explaining what it does and when it runs.
  </action>
  <verify>
    Run: `node -c ~/.dotfiles/create_dot_claude/scripts/hooks/session-start.js` — syntax check passes
    Run: `node -c ~/.dotfiles/create_dot_claude/scripts/hooks/session-end.js` — syntax check passes
    Run: `node -c ~/.dotfiles/create_dot_claude/scripts/hooks/pre-compact.js` — syntax check passes
    Run: `node -c ~/.dotfiles/create_dot_claude/scripts/hooks/evaluate-session.js` — syntax check passes
    Run: `grep -l "require.*lib/utils" ~/.dotfiles/create_dot_claude/scripts/hooks/*.js | wc -l` — should be 4 (all hooks use utils)
    Run: `grep -l "process.exit(0)" ~/.dotfiles/create_dot_claude/scripts/hooks/*.js | wc -l` — should be 4 (all hooks exit cleanly)
  </verify>
  <done>
    4 hook scripts exist at create_dot_claude/scripts/hooks/.
    All scripts require ../lib/utils (shared utility library).
    All scripts exit 0 on errors (never block Claude Code).
    All scripts pass Node.js syntax check.
    session-start.js checks for recent sessions and learned skills.
    session-end.js creates/updates session tracking files.
    pre-compact.js logs compaction events.
    evaluate-session.js evaluates sessions for learning patterns.
  </done>
</task>

</tasks>

<verification>
1. All 5 files exist in create_dot_claude/scripts/ directory tree
2. All .js files pass `node -c` syntax checks
3. utils.js exports are importable and return correct paths
4. All hooks reference ../lib/utils correctly
5. All hooks catch errors and exit 0
6. No references to "homunculus" — all use "insights" naming
</verification>

<success_criteria>
- utils.js provides 15+ exported utility functions with hardcoded ~/.claude/ paths
- 4 hook scripts adapted from reference, simplified for Linux-only deployment
- All scripts use "insights" directory name (not "homunculus")
- All scripts pass Node.js syntax validation
- All hooks exit cleanly (exit 0) on any error
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-bootstrap-folders-claude-command-center/05.1-02-SUMMARY.md`
</output>
