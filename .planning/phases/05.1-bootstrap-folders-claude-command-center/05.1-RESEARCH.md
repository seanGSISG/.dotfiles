# Phase 5.1: Bootstrap Folders & Claude Code Command Center - Research

**Researched:** 2026-02-11
**Domain:** chezmoi dotfile management, Claude Code configuration deployment, continuous learning system
**Confidence:** HIGH

## Summary

This phase deploys a complete workspace structure and Claude Code environment using chezmoi as the deployment mechanism. The research confirms that chezmoi's template system, create_ prefix for initial-deploy files, and age encryption provide all necessary capabilities for portable, secure configuration management.

The continuous-learning-v2 system from the reference materials uses a hook-based observation architecture where PreToolUse/PostToolUse hooks capture session data to observations.jsonl, a background observer agent analyzes patterns, and instincts (atomic learned behaviors with confidence scoring) are stored in a hierarchical directory structure. The system is fully file-based with no external dependencies beyond the hooks and Python CLI tools.

Claude Code's official installer (curl -fsSL https://claude.ai/install.sh | bash) is the recommended installation method, avoiding Node.js package manager conflicts. The ~/.claude/ directory structure is standardized: settings.json for hooks configuration, skills/ and agents/ for reusable components, and insights/ (renamed from homunculus) for learning system data.

**Primary recommendation:** Use chezmoi's create_ prefix for ~/.claude/ configs (hooks.json, settings.json) to enable initial deployment without overwriting user edits. Deploy workspace folders (~/projects/, ~/labs/, ~/tools/, ~/tmp/, ~/command-center/) with boundary CLAUDE.md files via standard chezmoi templates. Learning system data (~/.claude/insights/) stays unmanaged by chezmoi—it's runtime-generated and machine-specific.

## Standard Stack

The established tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| chezmoi | v2.x | Dotfile management with templating | Industry standard for cross-machine config deployment, built-in age encryption, template variables |
| age | v1.2.1+ | File encryption | Simple, modern alternative to GPG, built-in chezmoi support, no passphrase prompts |
| Claude Code | Latest | AI coding assistant CLI | Official Anthropic tool, native installer eliminates Node.js conflicts |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| bash | 5.x | Hook scripts | Simple observation hooks, file I/O, process management |
| node.js | 22.x LTS | Session hook scripts | Complex hook logic from reference (session-start.js, session-end.js) |
| python3 | 3.10+ | Learning system CLI | Instinct management, observation parsing, evolution pipeline |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| chezmoi | GNU Stow | Stow is simpler (symlinks only) but lacks templating, encryption, per-machine variables |
| age | GPG | GPG is more mature but requires passphrase prompts, more complex setup |
| Official installer | npm/bun install | Package manager install creates conflicts, native installer is Anthropic-recommended |

**Installation:**
```bash
# chezmoi (already in bootstrap.sh)
curl -fsLS https://get.chezmoi.io | sh -s -- -b "$HOME/.local/bin"

# age (already in bootstrap.sh)
apt install age  # or GitHub releases fallback

# Claude Code (replace bun/npm method in bootstrap.sh)
curl -fsSL https://claude.ai/install.sh | bash
```

## Architecture Patterns

### Recommended Project Structure
```
~/.dotfiles/                                    # chezmoi source directory
├── .chezmoi.toml.tmpl                         # Config with age settings
├── bootstrap.sh                                # Entry point script
├── packages/                                   # Package manifests (existing)
│
├── create_dot_claude/                          # Initial ~/.claude/ deployment
│   ├── settings.json.tmpl                     # Global Claude Code settings
│   ├── hooks.json.tmpl                        # Hooks configuration
│   ├── scripts/
│   │   └── hooks/
│   │       ├── session-start.js               # Load previous context
│   │       ├── session-end.js                 # Persist session state
│   │       ├── pre-compact.js                 # Save before compaction
│   │       ├── evaluate-session.js            # Extract patterns
│   │       └── lib/
│   │           └── utils.js                   # Shared utilities
│   │
│   └── skills/
│       └── continuous-learning-v2/
│           ├── SKILL.md                       # Learning system docs
│           ├── config.json                    # Learning config
│           ├── hooks/
│           │   └── observe.sh                 # Observation capture
│           ├── scripts/
│           │   └── instinct-cli.py            # Instinct management
│           └── agents/
│               ├── observer.md                # Background observer spec
│               └── start-observer.sh          # Observer launcher
│
├── dot_config/                                 # Existing configs
│   └── (current structure unchanged)
│
└── workspace/                                  # NEW: Workspace folder templates
    ├── projects_CLAUDE.md.tmpl                # ~/projects/ boundary file
    ├── labs_CLAUDE.md.tmpl                    # ~/labs/ boundary file
    ├── tools_CLAUDE.md.tmpl                   # ~/tools/ boundary file
    ├── tmp_CLAUDE.md.tmpl                     # ~/tmp/ boundary file
    └── command-center_CLAUDE.md.tmpl          # ~/command-center/ boundary file
```

**Runtime structure (after chezmoi apply):**
```
~/.claude/                                      # Deployed by chezmoi (create_ prefix)
├── settings.json                              # Won't overwrite if exists
├── hooks.json                                 # Won't overwrite if exists
├── scripts/hooks/                             # Session hook scripts
├── skills/continuous-learning-v2/             # Learning system
└── insights/                                  # NOT MANAGED BY CHEZMOI
    ├── observations.jsonl                     # Hook-captured data
    ├── observations.archive/                  # Rotated observations
    ├── instincts/
    │   ├── personal/                          # Auto-learned patterns
    │   └── inherited/                         # Imported instincts
    └── evolved/
        ├── agents/                            # Clustered into agents
        ├── skills/                            # Clustered into skills
        └── commands/                          # Clustered into commands

~/projects/                                     # Deployed by chezmoi
~/labs/                                         # Deployed by chezmoi
~/tools/                                        # Deployed by chezmoi
~/tmp/                                          # Deployed by chezmoi
~/command-center/                               # Deployed by chezmoi
    └── CLAUDE.md                              # Command center boundary file
```

### Pattern 1: Create-Prefix for Initial Deploy Only
**What:** Use create_ prefix on chezmoi source files that should initialize but never overwrite existing files
**When to use:** Configuration files users may customize (hooks.json, settings.json)
**Example:**
```
# Source: https://www.chezmoi.io/reference/target-types/
~/.dotfiles/create_dot_claude/settings.json.tmpl
  → ~/.claude/settings.json (only if it doesn't exist)

# If ~/.claude/settings.json exists, chezmoi apply skips it entirely
# User edits are preserved across chezmoi apply runs
```

### Pattern 2: Learning System Data Outside Chezmoi
**What:** Runtime-generated data directories are NOT managed by chezmoi
**When to use:** Machine-specific runtime state (observations, instincts, session logs)
**Example:**
```bash
# Source: continuous-learning-v2/config.json analysis
# chezmoi creates ~/.claude/skills/continuous-learning-v2/
# But ~/.claude/insights/ is created at runtime by hooks
# chezmoi NEVER touches ~/.claude/insights/ contents

# In .chezmoiignore:
.claude/insights/
.claude/insights/**
```

### Pattern 3: Workspace CLAUDE.md Boundary Files
**What:** Each workspace folder gets a CLAUDE.md describing its scope and rules
**When to use:** Defining boundaries for Claude Code's workspace awareness
**Example:**
```markdown
# Source: Adapted from init-home-structure.sh reference
# ~/projects/CLAUDE.md
# Projects Workspace

Active development projects and code repositories.

## Allowed Actions
- Read/write files within this folder and subfolders
- Create new projects and repositories
- Install dependencies and run tests

## Safety Boundaries
- Never store secrets or credentials
- Don't modify files outside ~/projects without explicit permission
```

### Pattern 4: Age Encryption for MCP Secrets
**What:** Encrypt MCP server configs containing API keys using age
**When to use:** Any file with sensitive tokens (Context7 API key, Exa API key, etc.)
**Example:**
```bash
# Source: https://www.chezmoi.io/user-guide/encryption/age/
# In chezmoi source:
encrypted_dot_claude_mcp-servers.json.age

# Generated via:
chezmoi add --encrypt ~/.claude/mcp-servers.json

# Requires age key at ~/.config/age/keys.txt (already configured)
```

### Anti-Patterns to Avoid
- **Don't use create_ with .tmpl suffix expecting template processing:** The create_ prefix and template processing work together, but the GitHub issue #1495 discussion suggests potential quirks—test thoroughly
- **Don't let chezmoi manage runtime state:** ~/.claude/insights/ is hands-off, learning system owns it
- **Don't hardcode paths in hook scripts:** Use environment variables like CLAUDE_PLUGIN_ROOT (Claude Code sets this)
- **Don't enable linting hooks by default:** User decided to exclude console.log checks, TypeScript validation, Prettier auto-format from hooks.json

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Session persistence | Custom session logging | session-start.js, session-end.js from reference | Already handles context loading, timestamp tracking, cross-platform paths |
| Pattern observation | Stop hook extraction | continuous-learning-v2 observe.sh + observer agent | 100% reliable PreToolUse/PostToolUse hooks vs probabilistic Stop hook, structured JSONL format |
| File-based instinct storage | Custom markdown parser | instinct-cli.py from reference | Handles frontmatter parsing, confidence scoring, domain tagging |
| Workspace folder creation | Bash script with mkdir | chezmoi templates | Templates handle per-machine variables, idempotent apply, version control |
| Config encryption | Custom encrypt script | chezmoi age integration | Built-in age support, automatic decryption on apply, no passphrase prompts |

**Key insight:** The learning system architecture is fully designed—hooks capture observations (100% reliable via Pre/PostToolUse), Python CLI manages instincts, observer agent analyzes patterns. Custom implementation would miss edge cases (observation rotation, confidence decay, evolution clustering).

## Common Pitfalls

### Pitfall 1: create_ Prefix Stops Managing File Updates
**What goes wrong:** After initial deployment, changes to create_-prefixed source files in chezmoi don't propagate to target
**Why it happens:** create_ means "only deploy if target doesn't exist"—once deployed, chezmoi ignores it
**How to avoid:** Use create_ ONLY for files users customize (hooks.json, settings.json). Use regular templates for files that should always sync (CLAUDE.md boundary files)
**Warning signs:** Running chezmoi apply after updating a create_-prefixed source file, but target unchanged

### Pitfall 2: Template Variables Undefined in Non-.tmpl Files
**What goes wrong:** Using {{ .chezmoi.username }} in a file without .tmpl suffix causes literal text to appear
**Why it happens:** chezmoi only processes templates for files ending in .tmpl
**How to avoid:** Any file using template variables MUST have .tmpl suffix (even if it has create_ prefix)
**Warning signs:** Seeing literal "{{ .chezmoi.username }}" in deployed files

### Pitfall 3: Learning System Data in Git Repo
**What goes wrong:** Committing ~/.claude/insights/ to dotfiles repo causes merge conflicts, exposes observations
**Why it happens:** Forgetting to exclude runtime-generated directories from chezmoi source
**How to avoid:** Add to .chezmoiignore: `.claude/insights/` and never chezmoi add files from that path
**Warning signs:** Git status showing unstaged changes in .planning/research/temp/ or runtime data

### Pitfall 4: Hardcoded Paths in Hook Scripts
**What goes wrong:** Hook scripts with hardcoded ~/.claude/ paths fail when CLAUDE_PLUGIN_ROOT is different
**Why it happens:** Reference scripts use absolute paths, but Claude Code plugins can be elsewhere
**How to avoid:** User decision states "hardcoded ~/.claude/ paths"—we're NOT using plugin installation, we're deploying to standard ~/.claude/ location. This is intentional.
**Warning signs:** N/A—hardcoded paths are the decision for this implementation

### Pitfall 5: Bootstrap.sh Installing Claude Code Before Chezmoi Apply
**What goes wrong:** bootstrap.sh installs Claude Code, then chezmoi apply deploys ~/.claude/ configs, but installation order matters
**Why it happens:** Official installer may create default ~/.claude/settings.json, then chezmoi create_ prefix sees it exists and skips
**How to avoid:** Install Claude Code FIRST in bootstrap.sh (before chezmoi apply), then chezmoi's create_ files deploy alongside installer's defaults. User decision confirms this order.
**Warning signs:** Fresh machine has no hooks configured after bootstrap completion

### Pitfall 6: Observer Agent Enabled by Default
**What goes wrong:** Background observer agent runs continuously, consuming resources
**Why it happens:** continuous-learning-v2/config.json has "observer.enabled": false by default, but could be misconfigured
**How to avoid:** Keep observer.enabled: false in deployed config.json—observation hooks capture data, but background analysis is opt-in
**Warning signs:** Python process using CPU continuously, high memory from haiku model loading

## Code Examples

Verified patterns from reference sources:

### Workspace Boundary File Template
```markdown
# Source: Adapted from init-home-structure.sh
# File: ~/.dotfiles/workspace/command-center_CLAUDE.md.tmpl
# Agent Command Center

This is the primary workspace for Claude Code sessions and development orchestration.

## Scope of Access
You may operate within:
- ~/projects (active development)
- ~/labs (experiments and prototypes)
- ~/tools (personal utilities)
- ~/tmp (disposable scratch space)

Full workspace structure:
- **~/projects/** — Active development projects and repositories
- **~/labs/** — Experiments, tutorials, PoCs, throwaway prototypes
- **~/tools/** — Personal scripts, helper CLIs, developer utilities
- **~/tmp/** — Disposable scratch space (safe to wipe)
- **~/command-center/** — This directory (command center)

## Learning System
Continuous learning v2 is active:
- Observations captured to ~/.claude/insights/observations.jsonl
- Instincts stored in ~/.claude/insights/instincts/personal/
- Use /instinct-status to view learned patterns
- Use /evolve to cluster instincts into skills

## Safety Rules
- Never touch secrets, credentials, tokens, or private keys
- Never modify files outside this workspace without explicit permission
- Never delete user files without confirmation

---
*Managed by chezmoi from ~/.dotfiles/workspace/command-center_CLAUDE.md.tmpl*
```

### Session Start Hook (Node.js)
```javascript
// Source: everything-claude-code-main/scripts/hooks/session-start.js
#!/usr/bin/env node
/**
 * SessionStart Hook - Load previous context on new session
 * Cross-platform (Windows, macOS, Linux)
 */

const {
  getSessionsDir,
  findFiles,
  ensureDir,
  log
} = require('../lib/utils');

async function main() {
  const sessionsDir = getSessionsDir(); // Uses CLAUDE_PLUGIN_ROOT env var
  ensureDir(sessionsDir);

  // Check for recent session files (last 7 days)
  const recentSessions = findFiles(sessionsDir, '*-session.tmp', { maxAge: 7 });

  if (recentSessions.length > 0) {
    const latest = recentSessions[0];
    log(`[SessionStart] Found ${recentSessions.length} recent session(s)`);
    log(`[SessionStart] Latest: ${latest.path}`);
  }

  process.exit(0);
}

main().catch(err => {
  console.error('[SessionStart] Error:', err.message);
  process.exit(0); // Don't block on errors
});
```

### Observation Hook (Bash + Python)
```bash
# Source: continuous-learning-v2/hooks/observe.sh
#!/bin/bash
# Continuous Learning v2 - Observation Hook
# Captures tool use events for pattern analysis

set -e

CONFIG_DIR="${HOME}/.claude/insights"  # Renamed from homunculus
OBSERVATIONS_FILE="${CONFIG_DIR}/observations.jsonl"
MAX_FILE_SIZE_MB=10

mkdir -p "$CONFIG_DIR"

# Skip if disabled
if [ -f "$CONFIG_DIR/disabled" ]; then
  exit 0
fi

# Read JSON from stdin (Claude Code hook format)
INPUT_JSON=$(cat)

# Parse using python (more reliable than jq)
PARSED=$(python3 << EOF
import json
import sys

try:
    data = json.loads('''$INPUT_JSON''')
    hook_type = data.get('hook_type', 'unknown')
    tool_name = data.get('tool_name', data.get('tool', 'unknown'))
    tool_input = data.get('tool_input', data.get('input', {}))
    session_id = data.get('session_id', 'unknown')

    event = 'tool_start' if 'Pre' in hook_type else 'tool_complete'

    print(json.dumps({
        'parsed': True,
        'event': event,
        'tool': tool_name,
        'session': session_id
    }))
except Exception as e:
    print(json.dumps({'parsed': False, 'error': str(e)}))
EOF
)

# Build and write observation
timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

python3 << EOF
import json

parsed = json.loads('''$PARSED''')
observation = {
    'timestamp': '$timestamp',
    'event': parsed['event'],
    'tool': parsed['tool'],
    'session': parsed['session']
}

with open('$OBSERVATIONS_FILE', 'a') as f:
    f.write(json.dumps(observation) + '\n')
EOF

exit 0
```

### hooks.json Configuration (Learning + Session Only)
```json
{
  "$schema": "https://json.schemastore.org/claude-code-settings.json",
  "hooks": {
    "PreToolUse": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "~/.claude/skills/continuous-learning-v2/hooks/observe.sh pre"
      }],
      "description": "Capture tool use for learning system"
    }],
    "PostToolUse": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "~/.claude/skills/continuous-learning-v2/hooks/observe.sh post"
      }],
      "description": "Capture tool results for learning system"
    }],
    "PreCompact": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "node ~/.claude/scripts/hooks/pre-compact.js"
      }],
      "description": "Save state before context compaction"
    }],
    "SessionStart": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "node ~/.claude/scripts/hooks/session-start.js"
      }],
      "description": "Load previous context on new session"
    }],
    "SessionEnd": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "node ~/.claude/scripts/hooks/session-end.js"
      }],
      "description": "Persist session state on end"
    }, {
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "node ~/.claude/scripts/hooks/evaluate-session.js"
      }],
      "description": "Evaluate session for extractable patterns"
    }]
  }
}
```

### chezmoi Template for MCP Servers (Encrypted)
```bash
# Source: mcp-servers.json (to be encrypted)
# Command: chezmoi add --encrypt ~/.claude/mcp-servers.json
# Result: encrypted_dot_claude_mcp-servers.json.age in source

# The encrypted file contains:
{
  "mcpServers": {
    "context7": {
      "type": "http",
      "url": "https://mcp.context7.com/mcp",
      "headers": {
        "CONTEXT7_API_KEY": "{{ (index (index . "secret") "context7_api_key") }}"
      }
    },
    "exa_websearch": {
      "command": "npx",
      "args": ["-y", "exa-mcp-server"],
      "env": {
        "EXA_API_KEY": "{{ (index (index . "secret") "exa_api_key") }}"
      }
    }
  }
}

# Template variables populated from encrypted data source
# chezmoi decrypts on apply using ~/.config/age/keys.txt
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Skills-based observation | Hook-based observation | continuous-learning v2 | Hooks fire 100% of time (PreToolUse/PostToolUse) vs skills ~50-80% probabilistic |
| Stop hook for session eval | SessionEnd hook | Claude Code recent updates | SessionEnd more reliable, runs deterministically at session end |
| Full skills as learned units | Atomic instincts with confidence | continuous-learning v2 | Smaller learned behaviors (one trigger, one action) with 0.3-0.9 confidence scoring |
| Homunculus directory name | insights directory | User decision (Phase 5.1) | Clearer naming, "homunculus" was cryptic |
| bun/npm Claude Code install | Official native installer | Anthropic recommendation 2025-2026 | Avoids Node.js package manager conflicts, auto-updates in background |

**Deprecated/outdated:**
- Installing Claude Code via npm/bun: Native installer is recommended, eliminates dependency conflicts
- Using "homunculus" directory name: Reference uses it, but user renamed to "insights" for clarity
- Enabling observer agent by default: Resource-intensive, should be opt-in (config has enabled: false)

## Open Questions

Things that couldn't be fully resolved:

1. **Template Processing with create_ Prefix**
   - What we know: create_ prefix prevents overwrites, .tmpl suffix enables template processing
   - What's unclear: GitHub issue #1495 suggests potential quirks with create_ + .tmpl combination
   - Recommendation: Test create_ + .tmpl pattern during planning phase—if issues arise, use run_once_ scripts to deploy initial configs instead

2. **Hook Script Utilities Library**
   - What we know: session-start.js, session-end.js reference '../lib/utils.js' with helper functions
   - What's unclear: utils.js content not in reference files—need to implement or adapt
   - Recommendation: Extract utils.js from reference repo OR create minimal implementation (getSessionsDir, ensureDir, log, findFiles) during planning

3. **Observer Agent Background Process**
   - What we know: start-observer.sh launches background Python agent, observer.md describes behavior
   - What's unclear: Observer agent implementation details, how it signals running state
   - Recommendation: Observer is optional (disabled by default in config.json)—defer implementation details, focus on hook observation capture which works independently

4. **Workspace Folder Creation Timing**
   - What we know: chezmoi applies workspace CLAUDE.md files
   - What's unclear: Does chezmoi create parent directories if they don't exist?
   - Recommendation: Test with chezmoi apply --dry-run—likely need to explicitly create ~/projects/, ~/labs/, etc. directories in chezmoi templates

## Sources

### Primary (HIGH confidence)
- [chezmoi Target Types](https://www.chezmoi.io/reference/target-types/) - create_ prefix behavior, template processing
- [chezmoi age Encryption](https://www.chezmoi.io/user-guide/encryption/age/) - age configuration, encrypted files
- [Claude Code Setup](https://code.claude.com/docs/en/setup) - Official installation documentation
- [Claude Code Plugins Reference](https://code.claude.com/docs/en/plugins-reference) - ~/.claude directory structure
- Local reference files:
  - .planning/research/temp/everything-claude-code-main/scripts/hooks/ - Session hooks (session-start.js, session-end.js, pre-compact.js, evaluate-session.js)
  - .planning/research/temp/everything-claude-code-main/skills/continuous-learning-v2/ - Learning system architecture
  - .planning/research/temp/everything-claude-code-main/hooks/hooks.json - Hooks configuration reference
  - .planning/research/temp/init-home-structure.sh - Workspace structure reference
  - .planning/research/temp/mcp-servers.json - MCP server configuration

### Secondary (MEDIUM confidence)
- [How To Manage Dotfiles With Chezmoi](https://jerrynsh.com/how-to-manage-dotfiles-with-chezmoi/) - Best practices, organization patterns
- [Taking Control of My Dotfiles with chezmoi](https://blog.cmmx.de/2026/01/13/taking-control-of-my-dotfiles-with-chezmoi/) - 2026 real-world usage
- [Sync Claude Code commands and hooks across machines](https://www.arun.blog/sync-claude-code-with-chezmoi-and-age/) - chezmoi + Claude Code integration patterns
- [A complete guide to hooks in Claude Code](https://www.eesel.ai/blog/hooks-in-claude-code) - Hook architecture, event lifecycle

### Tertiary (LOW confidence - marked for validation)
- [Claude Code Native Installer](https://claudefa.st/blog/guide/native-installer) - Installation benefits (blog post, not official docs)
- WebSearch: "chezmoi template create_ prefix" - GitHub issues #1495, #3767 discussing limitations

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Official docs, local reference files, existing chezmoi setup in repo
- Architecture: HIGH - User decisions in CONTEXT.md, verified reference implementations
- Pitfalls: MEDIUM - Derived from docs + GitHub issues, some untested edge cases (create_ + .tmpl)

**Research date:** 2026-02-11
**Valid until:** 30 days (stable domain—chezmoi, age, Claude Code are mature tools)

---

**Research complete. Ready for planning phase.**
