---
phase: 05.1-bootstrap-folders-claude-command-center
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - create_dot_claude/hooks.json
  - create_dot_claude/settings.json
  - create_dot_claude/skills/continuous-learning-v2/SKILL.md
  - create_dot_claude/skills/continuous-learning-v2/config.json
  - create_dot_claude/skills/continuous-learning-v2/hooks/observe.sh
  - create_dot_claude/skills/continuous-learning-v2/scripts/instinct-cli.py
  - create_dot_claude/skills/continuous-learning-v2/agents/observer.md
  - create_dot_claude/skills/continuous-learning-v2/agents/start-observer.sh
  - encrypted_dot_claude/mcp-servers.json.age
autonomous: true
user_setup:
  - service: age-encryption
    why: "MCP server configs contain API keys that must be age-encrypted"
    env_vars:
      - name: AGE_KEY
        source: "~/.config/age/keys.txt (already configured from Phase 1)"
    dashboard_config: []

must_haves:
  truths:
    - "hooks.json configures session + learning hooks only (no linting hooks)"
    - "settings.json contains global Claude Code settings"
    - "Observation hook (observe.sh) captures PreToolUse/PostToolUse events to observations.jsonl"
    - "Learning system config uses 'insights' directory name (not 'homunculus')"
    - "Observer agent is disabled by default (enabled: false)"
    - "MCP servers config is age-encrypted in chezmoi source"
    - "instinct-cli.py uses ~/.claude/insights/ paths"
  artifacts:
    - path: "create_dot_claude/hooks.json"
      provides: "Hook configuration for session + learning hooks"
      contains: "PreToolUse"
    - path: "create_dot_claude/settings.json"
      provides: "Global Claude Code settings"
      min_lines: 3
    - path: "create_dot_claude/skills/continuous-learning-v2/config.json"
      provides: "Learning system configuration with insights paths"
      contains: "insights"
    - path: "create_dot_claude/skills/continuous-learning-v2/hooks/observe.sh"
      provides: "Observation hook capturing tool use events"
      contains: "observations.jsonl"
    - path: "create_dot_claude/skills/continuous-learning-v2/scripts/instinct-cli.py"
      provides: "Python CLI for instinct management"
      contains: "insights"
    - path: "create_dot_claude/skills/continuous-learning-v2/SKILL.md"
      provides: "Learning system documentation"
      min_lines: 30
  key_links:
    - from: "create_dot_claude/hooks.json"
      to: "create_dot_claude/skills/continuous-learning-v2/hooks/observe.sh"
      via: "hook command path"
      pattern: "continuous-learning-v2/hooks/observe\\.sh"
    - from: "create_dot_claude/hooks.json"
      to: "create_dot_claude/scripts/hooks/session-start.js"
      via: "hook command path"
      pattern: "scripts/hooks/session-start\\.js"
    - from: "create_dot_claude/hooks.json"
      to: "create_dot_claude/scripts/hooks/pre-compact.js"
      via: "hook command path"
      pattern: "scripts/hooks/pre-compact\\.js"
---

<objective>
Create Claude Code configuration files (hooks.json, settings.json), the continuous-learning-v2 system, and encrypted MCP server config.

Purpose: This plan deploys the core Claude Code configuration — hooks that fire on session events, the learning system that observes and creates instincts, and encrypted MCP server configs with API keys. Together with Plans 01 and 02, this completes the full ~/.claude/ deployment.

Output: hooks.json, settings.json, continuous-learning-v2 skill (6 files), encrypted MCP servers config
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05.1-bootstrap-folders-claude-command-center/05.1-CONTEXT.md
@.planning/phases/05.1-bootstrap-folders-claude-command-center/05.1-RESEARCH.md
@.chezmoi.toml.tmpl

Reference sources (adapt, do NOT copy verbatim):
@.planning/research/temp/everything-claude-code-main/hooks/hooks.json
@.planning/research/temp/everything-claude-code-main/skills/continuous-learning-v2/SKILL.md
@.planning/research/temp/everything-claude-code-main/skills/continuous-learning-v2/config.json
@.planning/research/temp/everything-claude-code-main/skills/continuous-learning-v2/hooks/observe.sh
@.planning/research/temp/everything-claude-code-main/skills/continuous-learning-v2/scripts/instinct-cli.py
@.planning/research/temp/everything-claude-code-main/skills/continuous-learning-v2/agents/observer.md
@.planning/research/temp/everything-claude-code-main/skills/continuous-learning-v2/agents/start-observer.sh
@.planning/research/temp/mcp-servers.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks.json, settings.json, and continuous-learning-v2 skill files</name>
  <files>
    create_dot_claude/hooks.json
    create_dot_claude/settings.json
    create_dot_claude/skills/continuous-learning-v2/SKILL.md
    create_dot_claude/skills/continuous-learning-v2/config.json
    create_dot_claude/skills/continuous-learning-v2/hooks/observe.sh
    create_dot_claude/skills/continuous-learning-v2/scripts/instinct-cli.py
    create_dot_claude/skills/continuous-learning-v2/agents/observer.md
    create_dot_claude/skills/continuous-learning-v2/agents/start-observer.sh
  </files>
  <action>
Create ALL files listed below in the chezmoi source directory (~/.dotfiles/). The `create_` prefix means these deploy only if ~/.claude/ doesn't exist yet (preserves user edits).

**1. create_dot_claude/hooks.json** — Hook configuration
Adapt from reference hooks.json but KEEP ONLY session + learning hooks. EXCLUDE all linting hooks per user decision:
- EXCLUDE: "Block dev servers outside tmux" (PreToolUse)
- EXCLUDE: "Reminder to use tmux for long-running commands" (PreToolUse)
- EXCLUDE: "Reminder before git push" (PreToolUse)
- EXCLUDE: "Block creation of random .md files" (PreToolUse Write matcher)
- EXCLUDE: "Suggest manual compaction at logical intervals" (PreToolUse Edit/Write)
- EXCLUDE: "Log PR URL and provide review command" (PostToolUse Bash)
- EXCLUDE: "Build analysis" (PostToolUse Bash build)
- EXCLUDE: "Auto-format JS/TS files with Prettier" (PostToolUse Edit)
- EXCLUDE: "TypeScript check after editing" (PostToolUse Edit)
- EXCLUDE: "Warn about console.log" (PostToolUse Edit)
- EXCLUDE: "Check for console.log in modified files" (Stop hook)

INCLUDE ONLY these hooks (use HARDCODED ~/.claude/ paths, NOT ${CLAUDE_PLUGIN_ROOT}):
```json
{
  "hooks": {
    "PreToolUse": [{
      "matcher": "*",
      "hooks": [{"type": "command", "command": "~/.claude/skills/continuous-learning-v2/hooks/observe.sh pre"}],
      "description": "Capture tool use for learning system"
    }],
    "PostToolUse": [{
      "matcher": "*",
      "hooks": [{"type": "command", "command": "~/.claude/skills/continuous-learning-v2/hooks/observe.sh post"}],
      "description": "Capture tool results for learning system"
    }],
    "PreCompact": [{
      "matcher": "*",
      "hooks": [{"type": "command", "command": "node ~/.claude/scripts/hooks/pre-compact.js"}],
      "description": "Save state before context compaction"
    }],
    "SessionStart": [{
      "matcher": "*",
      "hooks": [{"type": "command", "command": "node ~/.claude/scripts/hooks/session-start.js"}],
      "description": "Load previous context on new session"
    }],
    "SessionEnd": [
      {
        "matcher": "*",
        "hooks": [{"type": "command", "command": "node ~/.claude/scripts/hooks/session-end.js"}],
        "description": "Persist session state on end"
      },
      {
        "matcher": "*",
        "hooks": [{"type": "command", "command": "node ~/.claude/scripts/hooks/evaluate-session.js"}],
        "description": "Evaluate session for extractable patterns"
      }
    ]
  }
}
```

**2. create_dot_claude/settings.json** — Global Claude Code settings
Create a minimal settings.json:
```json
{
  "permissions": {
    "allow": [],
    "deny": []
  },
  "preferences": {
    "verbose": false
  }
}
```
Keep it minimal. The user will customize this. The hooks.json is where the real configuration lives.

**3. Continuous-learning-v2 files** — Adapt from reference with "insights" naming:

a) **SKILL.md**: Copy from reference, but replace ALL "homunculus" references with "insights". Update paths from `~/.claude/homunculus/` to `~/.claude/insights/`. Keep the full documentation (instinct model, how it works, commands, configuration, file structure, confidence scoring).

b) **config.json**: Adapt from reference with these changes:
- `observation.store_path`: `"~/.claude/insights/observations.jsonl"` (was homunculus)
- `instincts.personal_path`: `"~/.claude/insights/instincts/personal/"` (was homunculus)
- `instincts.inherited_path`: `"~/.claude/insights/instincts/inherited/"` (was homunculus)
- `observer.enabled`: `false` (disabled by default — user decision)
- `observer.model`: `"haiku"` (fixed default)
- `evolution.evolved_path`: `"~/.claude/insights/evolved/"` (was homunculus)
- Remove `integration` section (skill_creator_api not used)

c) **hooks/observe.sh**: Adapt from reference with these changes:
- Change `CONFIG_DIR="${HOME}/.claude/homunculus"` to `CONFIG_DIR="${HOME}/.claude/insights"`
- Change `OBSERVER_PID_FILE` path to use insights directory
- Keep ALL other logic (stdin reading, python parsing, observation writing, file rotation, observer signaling)
- Make executable (chezmoi will preserve permissions)

d) **scripts/instinct-cli.py**: Adapt from reference with these changes:
- Replace ALL `HOMUNCULUS_DIR = Path.home() / ".claude" / "homunculus"` with `INSIGHTS_DIR = Path.home() / ".claude" / "insights"`
- Update ALL path references from homunculus to insights
- Keep ALL commands (status, import, export, evolve) and all logic

e) **agents/observer.md**: Adapt from reference, replace "homunculus" with "insights" in all paths. Keep full documentation.

f) **agents/start-observer.sh**: Adapt from reference, replace `CONFIG_DIR="${HOME}/.claude/homunculus"` with `CONFIG_DIR="${HOME}/.claude/insights"`. Keep all start/stop/status logic. Make executable.

IMPORTANT: Ensure observe.sh and start-observer.sh have executable permissions. In chezmoi, files in create_ directories inherit the source file permissions, so set them executable on the source files:
After writing, run: `chmod +x create_dot_claude/skills/continuous-learning-v2/hooks/observe.sh create_dot_claude/skills/continuous-learning-v2/agents/start-observer.sh`
  </action>
  <verify>
    Run: `cat ~/.dotfiles/create_dot_claude/hooks.json | python3 -m json.tool` — valid JSON, no linting hooks
    Run: `cat ~/.dotfiles/create_dot_claude/settings.json | python3 -m json.tool` — valid JSON
    Run: `cat ~/.dotfiles/create_dot_claude/skills/continuous-learning-v2/config.json | python3 -m json.tool` — valid JSON, contains "insights"
    Run: `grep -r 'homunculus' ~/.dotfiles/create_dot_claude/` — should find NOTHING (all renamed to insights)
    Run: `grep -c 'insights' ~/.dotfiles/create_dot_claude/skills/continuous-learning-v2/config.json` — should be 4+
    Run: `bash -n ~/.dotfiles/create_dot_claude/skills/continuous-learning-v2/hooks/observe.sh` — syntax OK
    Run: `bash -n ~/.dotfiles/create_dot_claude/skills/continuous-learning-v2/agents/start-observer.sh` — syntax OK
    Run: `python3 -c "import ast; ast.parse(open('$HOME/.dotfiles/create_dot_claude/skills/continuous-learning-v2/scripts/instinct-cli.py').read())"` — Python syntax OK
    Run: `test -x ~/.dotfiles/create_dot_claude/skills/continuous-learning-v2/hooks/observe.sh && echo "executable" || echo "NOT executable"` — should be executable
    Run: `grep -c 'console.log\|prettier\|TypeScript\|tsc\|tmux' ~/.dotfiles/create_dot_claude/hooks.json` — should be 0 (no linting hooks)
  </verify>
  <done>
    hooks.json contains ONLY session + learning hooks (6 hook entries: PreToolUse, PostToolUse, PreCompact, SessionStart, 2x SessionEnd).
    No linting hooks present (no console.log, prettier, tsc, tmux enforcement).
    All paths use hardcoded ~/.claude/ (no CLAUDE_PLUGIN_ROOT).
    settings.json is minimal with permissions and preferences.
    continuous-learning-v2 has all 6 files adapted with "insights" naming.
    config.json has observer.enabled: false.
    All bash scripts pass syntax check and are executable.
    Python script passes syntax check.
    Zero references to "homunculus" in any deployed file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create age-encrypted MCP servers configuration</name>
  <files>encrypted_dot_claude/mcp-servers.json.age</files>
  <action>
Create the encrypted MCP servers configuration for ~/.claude/mcp-servers.json.

The MCP servers config contains API keys and must be age-encrypted. The encryption key is already configured at `~/.config/age/keys.txt` (set up in Phase 1).

Steps:
1. First, check if age key exists: `test -f ~/.config/age/keys.txt`
2. If age key exists, create a temporary mcp-servers.json with the server configs from the reference file at `.planning/research/temp/mcp-servers.json`:
   - context7 (HTTP type, with CONTEXT7_API_KEY header)
   - exa_websearch (stdio type via npx, with EXA_API_KEY env)
   - Lokka (stdio type via npx @merill/lokka, with CLIENT_ID, CLIENT_SECRET, TENANT_ID)
   - codex (stdio type, no secrets needed)

   Note: The reference file contains the ACTUAL API keys. Read the reference file and use those exact values.

3. Create proper JSON structure (the reference file is missing the outer `{` and `}` — it just has `"mcpServers": {...},` — wrap it properly):
```json
{
  "mcpServers": {
    ...contents from reference...
  }
}
```

4. Write the temp file to a temporary location, then use chezmoi to add it encrypted:
```bash
# Write temp file
cat > /tmp/mcp-servers.json << 'JSONEOF'
{...the full JSON...}
JSONEOF

# Add to chezmoi as encrypted file
chezmoi add --encrypt ~/.claude/mcp-servers.json
# This reads from the target path, so first deploy the temp file:
mkdir -p ~/.claude
cp /tmp/mcp-servers.json ~/.claude/mcp-servers.json
chezmoi add --encrypt ~/.claude/mcp-servers.json
rm /tmp/mcp-servers.json
```

Wait — the `chezmoi add --encrypt` approach reads from the TARGET location. Since this is a create_dot_claude directory with create_ prefix, there's a conflict. Instead, manually encrypt:

```bash
# Create the JSON file
mkdir -p /tmp/mcp-setup
cat > /tmp/mcp-setup/mcp-servers.json << 'JSONEOF'
{...json content...}
JSONEOF

# Encrypt with age
AGE_RECIPIENT=$(grep 'recipient' ~/.dotfiles/.chezmoi.toml.tmpl | sed 's/.*= *"//' | sed 's/"//')
age -r "$AGE_RECIPIENT" -o ~/.dotfiles/create_dot_claude/encrypted_mcp-servers.json.age /tmp/mcp-setup/mcp-servers.json

# Clean up
rm -rf /tmp/mcp-setup
```

IMPORTANT: The encrypted file goes INSIDE the create_dot_claude directory as `encrypted_mcp-servers.json.age`. The chezmoi naming convention:
- `encrypted_` prefix = age-encrypted file
- `mcp-servers.json` = target filename after decryption
- `.age` suffix = indicates encryption format

Wait, let me reconsider the chezmoi naming. For a file inside a `create_` directory, the encrypted file should follow chezmoi's naming:
- Source: `create_dot_claude/encrypted_mcp-servers.json.age`
- Target: `~/.claude/mcp-servers.json` (decrypted on apply)

Actually, the simplest approach: Place the file OUTSIDE create_dot_claude and use the standard chezmoi encrypted approach:
- Source: `encrypted_dot_claude/mcp-servers.json.age` — but this conflicts with create_dot_claude

The cleanest way: Use `chezmoi add --encrypt` after manually creating the target file:
```bash
mkdir -p ~/.claude
# Write the JSON to target location
cat > ~/.claude/mcp-servers.json << 'JSONEOF'
{...}
JSONEOF
# Let chezmoi add it encrypted
chezmoi add --encrypt ~/.claude/mcp-servers.json
# Remove from target (chezmoi apply will recreate it)
rm ~/.claude/mcp-servers.json
```

This will create the encrypted file in the correct chezmoi source location automatically. chezmoi figures out the right source path based on its config.

IF the age key does NOT exist (e.g., on a fresh machine test), skip encryption and log a warning: "Age key not found. MCP servers config skipped. Add key and run 'chezmoi add --encrypt ~/.claude/mcp-servers.json' manually."
  </action>
  <verify>
    Run: `ls ~/.dotfiles/**/encrypted*mcp* 2>/dev/null || ls ~/.dotfiles/create_dot_claude/encrypted* 2>/dev/null` — should find the encrypted file
    Run: `chezmoi cat ~/.claude/mcp-servers.json 2>/dev/null` — should show decrypted JSON with mcpServers
    If age key missing: verify warning was logged and task didn't fail
  </verify>
  <done>
    MCP servers config is age-encrypted in chezmoi source.
    `chezmoi apply` decrypts and deploys to ~/.claude/mcp-servers.json.
    Config includes context7, exa_websearch, Lokka, and codex servers.
    API keys are encrypted, never stored in plaintext in the repo.
    If age key is missing, a clear warning is shown.
  </done>
</task>

</tasks>

<verification>
1. `python3 -m json.tool` validates hooks.json, settings.json, and config.json
2. `grep -r 'homunculus' create_dot_claude/` returns no results
3. All shell scripts pass `bash -n` syntax check
4. Python script passes syntax check
5. hooks.json has exactly 6 hook entries (PreToolUse, PostToolUse, PreCompact, SessionStart, 2x SessionEnd)
6. No linting/enforcement hooks present in hooks.json
7. MCP servers config is encrypted (or warning logged if no age key)
8. observe.sh and start-observer.sh are executable
</verification>

<success_criteria>
- hooks.json has session + learning hooks only (6 entries, zero linting)
- settings.json is minimal and valid
- continuous-learning-v2 skill has all 6 files with "insights" paths
- observer disabled by default in config.json
- MCP servers encrypted with age
- All scripts pass syntax validation
- Zero references to "homunculus" anywhere in create_dot_claude/
</success_criteria>

<output>
After completion, create `.planning/phases/05.1-bootstrap-folders-claude-command-center/05.1-03-SUMMARY.md`
</output>
