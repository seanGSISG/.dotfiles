---
phase: 05-bootstrap-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bootstrap.sh
autonomous: true

must_haves:
  truths:
    - "bootstrap.sh exists at repo root and is executable"
    - "Running bootstrap.sh installs all apt packages from packages/apt-packages.txt"
    - "Running bootstrap.sh installs Starship, fnm, fzf, zoxide, uv, bun, age, antidote, TPM, Claude Code"
    - "Running bootstrap.sh installs Node.js LTS via fnm and uv tools from packages/uv-tools.txt"
    - "Running bootstrap.sh configures /etc/wsl.conf with systemd=true"
    - "Re-running bootstrap.sh shows 'skipped' messages for already-installed tools (idempotent)"
    - "If any step fails, subsequent steps still execute (continue-on-failure)"
  artifacts:
    - path: "bootstrap.sh"
      provides: "Idempotent bootstrap script with all installation sections"
      min_lines: 250
  key_links:
    - from: "bootstrap.sh"
      to: "packages/apt-packages.txt"
      via: "reads package names for apt-get install"
      pattern: "apt-packages\\.txt"
    - from: "bootstrap.sh"
      to: "packages/uv-tools.txt"
      via: "reads tool names for uv tool install"
      pattern: "uv-tools\\.txt"
---

<objective>
Create the bootstrap.sh script with all installation logic: scaffolding (colors, helpers, error tracking), system configuration (WSL2 wsl.conf, apt repos, apt packages), and all binary/plugin/tool installations (Starship, fnm, fzf, zoxide, uv, bun, age, antidote, TPM, uv tools, Node LTS, Claude Code).

Purpose: This is the core of the bootstrap script — everything that installs software. Plan 02 adds finalization (chezmoi deploy, shell change, SSH, backup, summary).

Output: bootstrap.sh at repo root with ~300 lines covering scaffolding through tool installation. Not yet runnable end-to-end (main function and finalization added in Plan 02).
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bootstrap-implementation/05-CONTEXT.md
@.planning/phases/05-bootstrap-implementation/05-RESEARCH.md
@packages/apt-packages.txt
@packages/binary-installs.txt
@packages/uv-tools.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bootstrap.sh with scaffolding, system config, and apt package installation</name>
  <files>bootstrap.sh</files>
  <action>
Create `bootstrap.sh` at the repo root (~/.dotfiles/bootstrap.sh).

**Shebang and safety flags:**
- `#!/usr/bin/env bash`
- `set -euo pipefail` for prerequisites section only

**Color and formatting setup:**
- Use `tput` for colors: RED, GREEN, YELLOW, BLUE, MAGENTA, CYAN, BOLD, RESET
- Helper functions: `log_info()`, `log_success()`, `log_skip()`, `log_error()`, `section_header()`
- See RESEARCH.md Pattern 3 for exact style

**Error tracking:**
- Global arrays: `FAILED_STEPS=()`, `INSTALLED=()`, `SKIPPED=()`
- `run_step()` wrapper that calls functions and tracks success/failure in arrays
- See RESEARCH.md Pattern 2 for error collection pattern

**Prerequisites check function (`check_prerequisites`):**
- Verify `curl`, `git`, `sudo` exist via `command -v`
- Exit with error if any missing
- This runs under `set -euo pipefail`

**System configuration function (`configure_wsl`):**
- Check if `/etc/wsl.conf` already has `systemd=true` — skip if yes
- Write `/etc/wsl.conf` with `sudo tee`:
  ```
  [boot]
  systemd=true

  [interop]
  enabled=true
  appendWindowsPath=true
  ```
- Log success, note WSL restart required
- See RESEARCH.md Pattern 6

**Apt repository setup function (`setup_apt_repos`):**
- Add GitHub CLI apt repo (required for `gh` package):
  - Check if repo already configured: `[ -f /etc/apt/sources.list.d/github-cli.list ]`
  - If not: add GPG key and repo source
- Add PowerShell repo if not present (for `powershell` package):
  - Check if repo already configured: `[ -f /etc/apt/sources.list.d/microsoft.list ]` or similar
  - If not: add Microsoft GPG key and repo source
- Run `sudo apt-get update -qq` after repo setup

**Apt package installation function (`install_apt_packages`):**
- Read `packages/apt-packages.txt` from `$DOTFILES_DIR/packages/apt-packages.txt`
  - Where `DOTFILES_DIR` is set at top of script: detect if running from clone (`$HOME/.dotfiles`) or needs to clone first
  - For now, set `DOTFILES_DIR="$HOME/.dotfiles"` — the clone logic will be in Plan 02's chezmoi section
- Parse the file: strip comments (lines starting with `#`), strip empty lines, strip version constraints (`>=X.Y`), strip trailing comments
- For each package: check with `dpkg-query -W -f='${Status}'` — skip if installed, install if not
- Use `sudo apt-get install -y -qq` for quiet installation
- Track installed/skipped counts
- See RESEARCH.md "Idempotent Package Installation" code example

**Make the file executable:** `chmod +x bootstrap.sh`

**Important implementation notes:**
- Set `DOTFILES_DIR="$HOME/.dotfiles"` as a global variable near the top
- Do NOT write the `main()` function yet — that comes in Plan 02
- Each section is a standalone function that can be called by `run_step`
- Strip version constraints from apt-packages.txt parsing (e.g., `git>=2.40` becomes `git`) — apt handles versions naturally
  </action>
  <verify>
- `[ -f ~/.dotfiles/bootstrap.sh ]` — file exists
- `[ -x ~/.dotfiles/bootstrap.sh ]` — file is executable
- `bash -n ~/.dotfiles/bootstrap.sh` — syntax check passes (no errors)
- `grep -c 'log_info\|log_success\|log_skip\|log_error' ~/.dotfiles/bootstrap.sh` returns 4+ (helper functions exist)
- `grep -q 'section_header' ~/.dotfiles/bootstrap.sh` — section header function exists
- `grep -q 'FAILED_STEPS' ~/.dotfiles/bootstrap.sh` — error tracking exists
- `grep -q 'apt-packages.txt' ~/.dotfiles/bootstrap.sh` — reads package manifest
- `grep -q 'systemd=true' ~/.dotfiles/bootstrap.sh` — WSL config handled
- `grep -q 'dpkg-query' ~/.dotfiles/bootstrap.sh` — idempotent package check
  </verify>
  <done>
bootstrap.sh exists at repo root with: shebang + safety flags, colored output helpers, error tracking (FAILED_STEPS/INSTALLED/SKIPPED arrays), prerequisites check, WSL2 wsl.conf configuration, apt repository setup (gh, powershell), and idempotent apt package installation from apt-packages.txt. File is executable and passes bash syntax check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add binary tool, plugin manager, and Python/Node tool installation functions</name>
  <files>bootstrap.sh</files>
  <action>
Append the following installation functions to `bootstrap.sh` (after the apt section, before any main function).

**Binary tools installation function (`install_binary_tools`):**
- Uses `section_header "Binary Tools"`
- Each tool as its own sub-function or inline block with idempotency check:

  **Starship** (`install_starship`):
  - Check: `command -v starship`
  - Install: `curl -sS https://starship.rs/install.sh | sh -s -- -y --bin-dir "$HOME/.local/bin"`

  **fnm** (`install_fnm`):
  - Check: `command -v fnm`
  - Install: `curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell`
  - Note: --skip-shell because shell integration is in zsh config already

  **fzf** (`install_fzf`):
  - Check: `command -v fzf` (may already be installed via apt — check apt-packages.txt... actually fzf is NOT in apt-packages.txt)
  - If fzf is not in apt-packages.txt, install from git: `git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf && ~/.fzf/install --key-bindings --completion --no-update-rc --no-bash --no-fish`
  - If fzf IS already present via apt (unlikely on fresh machine), skip

  **zoxide** (already in apt-packages.txt — installed by apt, skip here):
  - Note: zoxide IS in apt-packages.txt, so it's handled by apt. Do NOT install it again here.

  **uv** (`install_uv`):
  - Check: `command -v uv`
  - Install: `curl -LsSf https://astral.sh/uv/install.sh | sh`

  **bun** (`install_bun`):
  - Check: `command -v bun`
  - Install: `curl -fsSL https://bun.sh/install | bash`

  **age** (`install_age`):
  - Check: `command -v age`
  - Install: Download latest release from GitHub (`https://github.com/FiloSottile/age/releases`), extract to `~/.local/bin/`
  - Use: `curl -fsSL` to get latest release tarball, extract `age` and `age-keygen` binaries to `~/.local/bin/`
  - Alternative simpler approach: `sudo apt-get install -y age` if available in repos (check first)

**Plugin manager installation function (`install_plugin_managers`):**
- Uses `section_header "Plugin Managers"`

  **antidote** (`install_antidote`):
  - Check: `[ -d "$HOME/.antidote" ]`
  - Install: `git clone --depth=1 https://github.com/mattmc3/antidote.git "$HOME/.antidote"`

  **TPM (Tmux Plugin Manager)**:
  - Note: TPM is managed by `.chezmoiexternal.toml` — chezmoi will handle this automatically when `chezmoi apply` runs in Plan 02
  - Do NOT install TPM manually here — just log a note that it will be installed via chezmoi

**Python tools installation function (`install_python_tools`):**
- Uses `section_header "Python Tools"`
- Requires uv to be installed (check `command -v uv` first, warn if missing)
- Read `$DOTFILES_DIR/packages/uv-tools.txt`
- Parse: strip comments, strip empty lines
- For each tool: check `uv tool list 2>/dev/null | grep -q "^$tool "` — skip if installed
- Install: `uv tool install "$tool"`

**Node.js setup function (`install_node_tools`):**
- Uses `section_header "Node.js & JavaScript Tools"`
- Requires fnm to be installed
- Source fnm into current shell: `export PATH="$HOME/.local/share/fnm:$PATH" && eval "$(fnm env)"`
- Check if Node LTS installed: `fnm list | grep -q "22"` — skip if yes
- Install: `fnm install 22 && fnm default 22`
- Install Claude Code: Check `command -v claude` (after ensuring npm/bun is available)
  - Use bun if available: `bun install -g @anthropic-ai/claude-code`
  - Fallback to npm: `npm install -g @anthropic-ai/claude-code`

**Important implementation notes:**
- Ensure `~/.local/bin` is in PATH early: `export PATH="$HOME/.local/bin:$PATH"` near top of script if not already there
- Each function should track what was installed/skipped using the global INSTALLED and SKIPPED arrays
- Use consistent pattern: check -> skip or install -> log result
- All curl commands use `-fsSL` flags (fail silently, show errors, follow redirects)
  </action>
  <verify>
- `bash -n ~/.dotfiles/bootstrap.sh` — syntax check still passes
- `grep -q 'install_starship\|starship' ~/.dotfiles/bootstrap.sh` — Starship installation exists
- `grep -q 'install_fnm\|fnm' ~/.dotfiles/bootstrap.sh` — fnm installation exists
- `grep -q 'install_uv\|astral' ~/.dotfiles/bootstrap.sh` — uv installation exists
- `grep -q 'install_bun\|bun.sh' ~/.dotfiles/bootstrap.sh` — bun installation exists
- `grep -q 'antidote' ~/.dotfiles/bootstrap.sh` — antidote installation exists
- `grep -q 'uv-tools.txt' ~/.dotfiles/bootstrap.sh` — reads uv tools manifest
- `grep -q 'claude-code\|claude' ~/.dotfiles/bootstrap.sh` — Claude Code installation exists
- `grep -q 'fnm install' ~/.dotfiles/bootstrap.sh` — Node LTS installation exists
- `grep -q 'fzf' ~/.dotfiles/bootstrap.sh` — fzf installation exists
  </verify>
  <done>
bootstrap.sh contains all installation functions: binary tools (Starship, fnm, fzf, uv, bun, age), plugin managers (antidote, TPM note), Python tools (uv tool install from uv-tools.txt), and Node.js tools (fnm install 22, Claude Code via bun/npm). All functions use idempotency checks (command -v, directory checks) and track installed/skipped items. File passes bash syntax check.
  </done>
</task>

</tasks>

<verification>
After Plan 01 completion:
1. `bootstrap.sh` exists at `~/.dotfiles/bootstrap.sh` and is executable
2. `bash -n bootstrap.sh` passes syntax validation
3. The script contains all helper functions (logging, error tracking)
4. The script contains all installation functions (system config, apt, binary tools, plugins, python tools, node tools)
5. The script reads from `packages/apt-packages.txt` and `packages/uv-tools.txt`
6. Every installation step has an idempotency check (command -v, dpkg-query, directory check)
7. The script does NOT yet have a `main()` function — that comes in Plan 02
</verification>

<success_criteria>
- bootstrap.sh exists, is executable, and passes `bash -n` syntax check
- All installation functions defined: configure_wsl, setup_apt_repos, install_apt_packages, install_binary_tools (starship, fnm, fzf, uv, bun, age), install_plugin_managers (antidote), install_python_tools, install_node_tools
- Every function uses idempotency checks before installation
- Error tracking via FAILED_STEPS, INSTALLED, SKIPPED arrays
- Colored output via tput helper functions
- Package manifests (apt-packages.txt, uv-tools.txt) are consumed by the script
</success_criteria>

<output>
After completion, create `.planning/phases/05-bootstrap-implementation/05-01-SUMMARY.md`
</output>
