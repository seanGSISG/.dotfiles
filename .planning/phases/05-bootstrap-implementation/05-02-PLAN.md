---
phase: 05-bootstrap-implementation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - bootstrap.sh
autonomous: false

must_haves:
  truths:
    - "Running bootstrap.sh backs up existing dotfiles to ~/.dotfiles-backup/[timestamp]"
    - "Running bootstrap.sh clones the dotfiles repo and runs chezmoi init --apply"
    - "Running bootstrap.sh changes default shell to zsh via chsh"
    - "Running bootstrap.sh prompts for SSH source path and copies keys with correct permissions (700/600)"
    - "Running bootstrap.sh prints a numbered post-install checklist"
    - "Running bootstrap.sh shows a full summary of installed/skipped/failed items"
    - "Running bootstrap.sh ends with exec zsh to land user in new shell"
    - "Running bootstrap.sh twice produces identical results with skipped messages"
  artifacts:
    - path: "bootstrap.sh"
      provides: "Complete, runnable bootstrap script with main() function"
      min_lines: 400
  key_links:
    - from: "bootstrap.sh main()"
      to: "all installation functions"
      via: "run_step calls in correct order"
      pattern: "run_step"
    - from: "bootstrap.sh setup_chezmoi()"
      to: "chezmoi init --apply"
      via: "deploys all dotfiles from repo"
      pattern: "chezmoi init"
    - from: "bootstrap.sh setup_ssh_keys()"
      to: "~/.ssh/ directory"
      via: "copies and sets permissions"
      pattern: "chmod 700.*\\.ssh"
---

<objective>
Complete bootstrap.sh with finalization sections: dotfile backup, chezmoi deployment, shell change (chsh), SSH key copying, failure summary, post-install checklist, and the main() function that wires everything together. Then verify the complete script end-to-end.

Purpose: This turns the collection of installation functions from Plan 01 into a complete, runnable bootstrap script. After this plan, `curl|bash` invocation works.

Output: Complete bootstrap.sh (~500 lines) that can be executed on a fresh WSL2 Ubuntu machine.
</objective>

<execution_context>
@/home/vscode/.claude/get-shit-done/workflows/execute-plan.md
@/home/vscode/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bootstrap-implementation/05-CONTEXT.md
@.planning/phases/05-bootstrap-implementation/05-RESEARCH.md
@.planning/phases/05-bootstrap-implementation/05-01-SUMMARY.md
@packages/apt-packages.txt
@packages/binary-installs.txt
@packages/uv-tools.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add finalization functions and main() to bootstrap.sh</name>
  <files>bootstrap.sh</files>
  <action>
Append the following functions to `bootstrap.sh` (after the installation functions from Plan 01), then add the main() function at the very end.

**Dotfile backup function (`backup_dotfiles`):**
- Create backup directory: `$HOME/.dotfiles-backup/$(date +%Y%m%d_%H%M%S)`
- List of files to check: `.zshrc`, `.bashrc`, `.profile`, `.gitconfig`, `.tmux.conf`
- Also check directories: `.config/zsh`, `.config/tmux`, `.config/starship.toml`
- For each existing file/dir (not symlinks from chezmoi): copy to backup dir with `cp -aL`
- Only create backup dir if at least one file exists to backup
- Log what was backed up
- See RESEARCH.md Pattern 8

**Chezmoi deployment function (`setup_chezmoi`):**
- Check if chezmoi installed: `command -v chezmoi`
- If not installed: `sh -c "$(curl -fsLS https://get.chezmoi.io)" -- -b "$HOME/.local/bin"`
- Check if dotfiles repo already cloned: `[ -d "$HOME/.dotfiles/.git" ]`
  - If yes: run `chezmoi update --apply` (idempotent re-apply)
  - If no (fresh machine): `chezmoi init --apply --source "$HOME/.dotfiles" https://github.com/leifniem/dotfiles.git`
    - IMPORTANT: Read the git remote from the existing repo if available. Use placeholder `YOUR_GITHUB_USERNAME/dotfiles` that user should customize.
    - Actually, since the script lives IN the repo, the curl|bash flow would need to clone first. Handle two cases:
      1. Script run from existing clone (`$HOME/.dotfiles/bootstrap.sh`): skip clone, just `chezmoi init --apply --source "$HOME/.dotfiles"`
      2. Script run via curl|bash (no repo yet): `git clone https://github.com/YOUR_GITHUB_USERNAME/dotfiles.git "$HOME/.dotfiles"` first, then init
    - Detect which case: `[ -d "$DOTFILES_DIR/.git" ]`
- Set GITHUB_REPO variable near the top of the script (with DOTFILES_DIR): `GITHUB_REPO="leifniem/dotfiles"` — read this from git remote if running from existing clone
- Check if age key exists (`~/.config/age/keys.txt`) — if not, warn but continue (chezmoi will skip encrypted files)
- See RESEARCH.md Pattern 5

**Shell change function (`change_default_shell`):**
- Check if already using zsh: `[ "$SHELL" = "/usr/bin/zsh" ]` — skip if yes
- Verify zsh is in `/etc/shells`: `grep -q "^/usr/bin/zsh$" /etc/shells`
  - If not: `echo "/usr/bin/zsh" | sudo tee -a /etc/shells`
- Run `chsh -s /usr/bin/zsh` — let it prompt for password naturally
- Log: "Note: You'll be prompted for your password"
- See RESEARCH.md Pattern 7

**SSH key setup function (`setup_ssh_keys`):**
- Prompt user for SSH source path: "Enter path to existing SSH directory (e.g., /mnt/c/Users/YourName/.ssh) or press Enter to skip:"
- If user presses Enter (empty input): skip SSH setup entirely, log skip
- Validate source directory exists
- Create `~/.ssh` with `chmod 700`
- Copy all files: `cp -r "$ssh_source"/* ~/.ssh/`
- Fix permissions:
  - `chmod 700 ~/.ssh`
  - `find ~/.ssh -type f -name "id_*" ! -name "*.pub" -exec chmod 600 {} \;`
  - `find ~/.ssh -type f -name "*.pub" -exec chmod 644 {} \;`
  - `[ -f ~/.ssh/config ] && chmod 600 ~/.ssh/config`
  - `[ -f ~/.ssh/known_hosts ] && chmod 644 ~/.ssh/known_hosts`
- Verify permissions are correct: `stat -c '%a' ~/.ssh` should be 700
- See RESEARCH.md Pattern 4

**Summary and checklist function (`print_summary`):**
- Print banner: "Bootstrap Complete!" with green color
- Print INSTALLED items from INSTALLED array (green checkmarks)
- Print SKIPPED items from SKIPPED array (yellow skip indicators)
- Print FAILED items from FAILED_STEPS array (red X marks)
- Print numbered post-install checklist:
  1. Age encryption key: Retrieve from Bitwarden, save to ~/.config/age/keys.txt, then run `chezmoi apply`
  2. GitHub auth: Run `gh auth login`
  3. Tmux plugins: Open tmux, press `prefix + I` to install plugins
  4. Claude Code: Run `claude login`
  5. SSH verification: Run `ssh -T git@github.com`
  6. WSL restart: Run `wsl.exe --shutdown` from PowerShell (if wsl.conf was modified)
- See RESEARCH.md Pattern 9

**Main function (`main`):**
- Print welcome banner (ASCII art box with "WSL2 Dev Environment Bootstrap")
- Call `check_prerequisites` (under set -euo pipefail)
- `set +e` to switch to continue-on-failure mode
- Call each section via `run_step`:
  1. `run_step "WSL2 Configuration" configure_wsl`
  2. `run_step "APT Repository Setup" setup_apt_repos`
  3. `run_step "System Packages" install_apt_packages`
  4. `run_step "Binary Tools" install_binary_tools`
  5. `run_step "Plugin Managers" install_plugin_managers`
  6. `run_step "Python Tools" install_python_tools`
  7. `run_step "Node.js Tools" install_node_tools`
  8. `run_step "Dotfile Backup" backup_dotfiles`
  9. `run_step "Chezmoi Configuration" setup_chezmoi`
  10. `run_step "Default Shell" change_default_shell`
  11. `run_step "SSH Keys" setup_ssh_keys`
- `set -e` to re-enable strict mode
- Call `print_summary`
- If FAILED_STEPS is non-empty: print failure summary, exit 1
- Otherwise: print "Starting zsh..." and `exec zsh`

**Final line:** `main "$@"`

**GITHUB_REPO detection:**
Near the top of the script, after DOTFILES_DIR, add:
```bash
# Detect GitHub repo from existing git remote, or use default
if [ -d "$DOTFILES_DIR/.git" ]; then
  GITHUB_REPO=$(git -C "$DOTFILES_DIR" remote get-url origin 2>/dev/null | sed 's|.*github.com[:/]||;s|\.git$||' || echo "")
fi
GITHUB_REPO="${GITHUB_REPO:-YOUR_GITHUB_USERNAME/dotfiles}"
```
  </action>
  <verify>
- `bash -n ~/.dotfiles/bootstrap.sh` — full script syntax check passes
- `grep -q 'main "$@"' ~/.dotfiles/bootstrap.sh` — main invocation at end of file
- `grep -q 'backup_dotfiles' ~/.dotfiles/bootstrap.sh` — backup function exists
- `grep -q 'setup_chezmoi' ~/.dotfiles/bootstrap.sh` — chezmoi function exists
- `grep -q 'chezmoi init' ~/.dotfiles/bootstrap.sh` — chezmoi init command present
- `grep -q 'change_default_shell\|chsh' ~/.dotfiles/bootstrap.sh` — shell change function exists
- `grep -q 'setup_ssh_keys' ~/.dotfiles/bootstrap.sh` — SSH function exists
- `grep -q 'chmod 700.*\.ssh\|chmod 600' ~/.dotfiles/bootstrap.sh` — SSH permission fixing
- `grep -q 'print_summary' ~/.dotfiles/bootstrap.sh` — summary function exists
- `grep -q 'age/keys.txt\|Bitwarden' ~/.dotfiles/bootstrap.sh` — age key checklist item
- `grep -q 'gh auth login' ~/.dotfiles/bootstrap.sh` — gh auth checklist item
- `grep -q 'claude login' ~/.dotfiles/bootstrap.sh` — claude login checklist item
- `grep -q 'exec zsh' ~/.dotfiles/bootstrap.sh` — auto-start zsh at end
- `grep -c 'run_step' ~/.dotfiles/bootstrap.sh` returns 10+ — all sections wired in main
- `wc -l < ~/.dotfiles/bootstrap.sh` returns 400+ — complete script
  </verify>
  <done>
bootstrap.sh is a complete, runnable script with: dotfile backup, chezmoi init/apply with age key check, chsh to zsh, SSH key copying with permission fixing, comprehensive summary with installed/skipped/failed items, numbered post-install checklist (age key, gh auth, tmux plugins, claude login, SSH verify, WSL restart), and main() function wiring all sections via run_step with continue-on-failure. Script ends with exec zsh.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete bootstrap.sh script (~500 lines) that idempotently installs all tools, configures WSL2, deploys chezmoi configs, sets up SSH keys, changes default shell, and prints a post-install checklist. The script is designed to be invoked via `curl|bash` on a fresh WSL2 Ubuntu machine.
  </what-built>
  <how-to-verify>
1. Review the script: `cat ~/.dotfiles/bootstrap.sh`
2. Verify syntax: `bash -n ~/.dotfiles/bootstrap.sh` (should show no errors)
3. Check idempotency patterns: every installation step should have an `if command -v ... || [ -d ... ]` guard
4. Check the post-install checklist covers: age key, gh auth, tmux plugins, claude login, SSH verify, WSL restart
5. Check main() calls sections in sensible order (system config -> packages -> tools -> chezmoi -> shell -> SSH)
6. Verify error handling: FAILED_STEPS array, continue-on-failure (set +e), summary at end
7. Optionally dry-run a single function to test output formatting (e.g., source the script and call `check_prerequisites`)
  </how-to-verify>
  <resume-signal>Type "approved" to proceed, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
After Plan 02 completion:
1. `bootstrap.sh` is a complete, runnable script (400+ lines)
2. `bash -n bootstrap.sh` passes syntax validation
3. All 11 sections are wired in main() via run_step
4. Script handles both "run from clone" and "curl|bash" invocations
5. Backup creates timestamped directory before chezmoi apply
6. SSH keys get correct permissions (700 dir, 600 private, 644 public)
7. chsh prompts for password naturally
8. Post-install checklist has 6 items
9. exec zsh at end starts new shell
10. Re-running shows "skipped" for already-completed steps
</verification>

<success_criteria>
- bootstrap.sh is complete with main() function wiring all sections
- All phase success criteria from ROADMAP.md are satisfied:
  1. Script is idempotent (existence checks on every step)
  2. All tools installed (apt + binary + plugins + python + node)
  3. chsh to zsh included
  4. Backup to ~/.dotfiles-backup/[timestamp] included
  5. chezmoi init --apply included
  6. Post-install checklist printed (6 items)
  7. SSH key copy with correct permissions included
  8. WSL2 wsl.conf configuration included
- bash -n syntax check passes
- Script is executable (chmod +x)
</success_criteria>

<output>
After completion, create `.planning/phases/05-bootstrap-implementation/05-02-SUMMARY.md`
</output>
