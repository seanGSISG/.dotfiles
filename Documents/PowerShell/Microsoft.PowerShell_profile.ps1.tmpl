# PowerShell 7 Profile - Modular configuration
# Managed by chezmoi - edit source at ~/.dotfiles/Documents/PowerShell/Microsoft.PowerShell_profile.ps1.tmpl
#
# Load order (mirrors zsh setup):
#   1. exports.ps1   - PATH, env vars, PSReadLine history
#   2. plugins.ps1   - PSReadLine config, module management
#   3. tools.ps1     - fnm, fzf, zoxide
#   4. functions.ps1 - custom functions
#   5. aliases/      - categorized alias files
#   6. secrets       - decrypted secrets
#   7. Starship      - prompt (must be last)

$ConfigDir = "$HOME\.config\powershell"

if (-not (Test-Path $ConfigDir)) {
    Write-Warning "PowerShell config directory not found: $ConfigDir"
    Write-Warning "Run 'chezmoi apply' to deploy configuration files."
    return
}

# Source modular config files
. "$ConfigDir\exports.ps1"
. "$ConfigDir\plugins.ps1"
. "$ConfigDir\tools.ps1"
. "$ConfigDir\functions.ps1"

# Source all alias files
Get-ChildItem "$ConfigDir\aliases\*.ps1" -ErrorAction SilentlyContinue |
    ForEach-Object { . $_.FullName }

# Load secrets from age-encrypted chezmoi-managed file
# Parses .env file format: KEY=value or export KEY=value
# Handles values containing = signs (e.g., KEY=value=with=equals sets KEY to "value=with=equals")
# Strips surrounding quotes from values (single or double quotes)
if (Test-Path "$HOME\.secrets.env") {
    Get-Content "$HOME\.secrets.env" | ForEach-Object {
        if ($_ -match '^\s*#') { return }       # skip comments
        if ($_ -match '^\s*$') { return }       # skip blank lines
        
        # Match: export KEY=value or KEY=value
        # Captures: $Matches[1] = KEY, $Matches[2] = everything after first =
        # The (.*) pattern intentionally captures all remaining text, including embedded = signs
        if ($_ -match '^export\s+(\w+)=(.*)$') {
            $value = $Matches[2].Trim('"').Trim("'")
            Set-Item -Path "Env:$($Matches[1])" -Value $value
        } elseif ($_ -match '^(\w+)=(.*)$') {
            $value = $Matches[2].Trim('"').Trim("'")
            Set-Item -Path "Env:$($Matches[1])" -Value $value
        }
    }
}

# Starship prompt (must be last - it modifies prompt function)
if (Get-Command starship -ErrorAction SilentlyContinue) {
    Invoke-Expression (&starship init powershell)
}
